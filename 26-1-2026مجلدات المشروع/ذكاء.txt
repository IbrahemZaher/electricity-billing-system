# app.py
import tkinter as tk
from tkinter import messagebox
import logging
import sys
import os

import threading
from modules.fast_operations import FastOperations

# إعداد سجل الأخطاء
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/application.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

# إضافة المسارات للمكتبات
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
def auto_backup():
    """نسخ احتياطي تلقائي كل 6 ساعات"""
    try:
        logger.info("بدء النسخ الاحتياطي التلقائي...")
        fast_ops = FastOperations()
        fast_ops.backup_to_excel_parallel()
        logger.info("اكتمل النسخ الاحتياطي التلقائي")
    except Exception as e:
        logger.error(f"خطأ في النسخ الاحتياطي التلقائي: {e}")

def run_scheduler():
    """تشغيل المجدول في thread منفصل"""
    schedule.every(6).hours.do(auto_backup)
    
    while True:
        schedule.run_pending()
        time.sleep(60)

def main():
    try:
        # التحقق من وجود قاعدة البيانات
        from database.models import models
        logger.info("تم تهيئة قاعدة البيانات بنجاح")
        
        # تشغيل نافذة تسجيل الدخول
        from ui.login_window import LoginWindow
        login_window = LoginWindow()
        login_window.run()

        
        # بدء النسخ الاحتياطي التلقائي
        backup_thread = threading.Thread(target=run_scheduler, daemon=True)
        backup_thread.start()
            
    except Exception as e:
        logger.error(f"خطأ في تشغيل البرنامج: {e}")
        messagebox.showerror("خطأ تشغيل", f"فشل تشغيل البرنامج: {str(e)}")
        sys.exit(1)


if __name__ == "__main__":
    main()
مجلد auth يحوي الملفات التالية
__init__.py له الكود التالي
# auth/__init__.py
from .authentication import auth
from .permissions import Permission, require_permission
from .session import Session

__all__ = ['auth', 'Permission', 'require_permission', 'Session']
وملف authentication.py له الكود التالي
# auth/authentication.py
from database.connection import db
import hashlib
import jwt
from datetime import datetime, timedelta
import logging
from config.settings import SECRET_KEY

logger = logging.getLogger(__name__)

class Authentication:
    def __init__(self):
        self.secret_key = SECRET_KEY
    
    def hash_password(self, password):
        """تشفير كلمة المرور"""
        return hashlib.sha256(password.encode()).hexdigest()
    
    def verify_password(self, password, hashed_password):
        """التحقق من كلمة المرور"""
        return self.hash_password(password) == hashed_password
    
    def create_token(self, user_id, username, role):
        """إنشاء توكن للمستخدم"""
        payload = {
            'user_id': user_id,
            'username': username,
            'role': role,
            'exp': datetime.utcnow() + timedelta(hours=8)
        }
        return jwt.encode(payload, self.secret_key, algorithm='HS256')
    
    def verify_token(self, token):
        """التحقق من التوكن"""
        try:
            payload = jwt.decode(token, self.secret_key, algorithms=['HS256'])
            return payload
        except jwt.ExpiredSignatureError:
            return None
        except jwt.InvalidTokenError:
            return None
    
    def login(self, username, password):
        """تسجيل الدخول"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                    SELECT id, username, password_hash, full_name, role, permissions, is_active
                    FROM users 
                    WHERE username = %s
                """, (username,))
                
                user = cursor.fetchone()
                
                if not user:
                    return {'error': 'اسم المستخدم أو كلمة المرور غير صحيحة'}
                
                if not user['is_active']:
                    return {'error': 'الحساب غير مفعل'}
                
                if self.verify_password(password, user['password_hash']):
                    # تحديث وقت آخر دخول
                    cursor.execute("""
                        UPDATE users 
                        SET updated_at = CURRENT_TIMESTAMP 
                        WHERE id = %s
                    """, (user['id'],))
                    
                    # إنشاء التوكن
                    token = self.create_token(
                        user['id'], 
                        user['username'], 
                        user['role']
                    )
                    
                    return {
                        'id': user['id'],
                        'username': user['username'],
                        'full_name': user['full_name'],
                        'role': user['role'],
                        'permissions': user['permissions'],
                        'token': token
                    }
                else:
                    return {'error': 'اسم المستخدم أو كلمة المرور غير صحيحة'}
                    
        except Exception as e:
            logger.error(f"خطأ في تسجيل الدخول: {e}")
            return {'error': 'حدث خطأ أثناء تسجيل الدخول'}

    def register_user(self, user_data):
        """تسجيل مستخدم جديد"""
        try:
            with db.get_cursor() as cursor:
                # التحقق من عدم وجود المستخدم
                cursor.execute("SELECT id FROM users WHERE username = %s", 
                             (user_data['username'],))
                if cursor.fetchone():
                    return {'error': 'اسم المستخدم موجود بالفعل'}
                
                # تشفير كلمة المرور
                hashed_password = self.hash_password(user_data['password'])
                
                # إضافة المستخدم
                cursor.execute("""
                    INSERT INTO users 
                    (username, password_hash, full_name, role, permissions)
                    VALUES (%s, %s, %s, %s, %s)
                    RETURNING id
                """, (
                    user_data['username'],
                    hashed_password,
                    user_data['full_name'],
                    user_data.get('role', 'accountant'),
                    user_data.get('permissions', {})
                ))
                
                user_id = cursor.fetchone()['id']
                
                # تسجيل النشاط
                self.log_activity(
                    user_id,
                    'register',
                    f'تم تسجيل مستخدم جديد: {user_data["full_name"]}'
                )
                
                return {'success': True, 'user_id': user_id}
                
        except Exception as e:
            logger.error(f"خطأ في تسجيل المستخدم: {e}")
            return {'error': str(e)}
    
    def log_activity(self, user_id, action_type, description, ip_address=None, user_agent=None):
        """تسجيل نشاط المستخدم"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                    INSERT INTO activity_logs 
                    (user_id, action_type, description, ip_address, user_agent)
                    VALUES (%s, %s, %s, %s, %s)
                """, (user_id, action_type, description, ip_address, user_agent))
                
        except Exception as e:
            logger.error(f"خطأ في تسجيل النشاط: {e}")
    
    def check_permission(self, user, permission):
        """التحقق من صلاحية المستخدم"""
        if user['role'] == 'admin':
            return True
        
        permissions = user.get('permissions', {})
        return permissions.get(permission, False)

# إنشاء كائن المصادقة
auth = Authentication()

وملف permissions.py له الكود التالي 
# auth/permissions.py

from enum import Enum
from auth.session import Session

class Role(Enum):
    ADMIN = "admin"
    ACCOUNTANT = "accountant"
    VIEWER = "viewer"

class Permission(Enum):
    VIEW_CUSTOMERS = "view_customers"
    CREATE_BILLS = "create_bills"
    EDIT_BILLS = "edit_bills"
    VIEW_REPORTS = "view_reports"
    MANAGE_USERS = "manage_users"

ROLE_PERMISSIONS = {
    Role.ADMIN: list(Permission),
    Role.ACCOUNTANT: [
        Permission.VIEW_CUSTOMERS,
        Permission.CREATE_BILLS,
        Permission.EDIT_BILLS,
        Permission.VIEW_REPORTS
    ],
    Role.VIEWER: [
        Permission.VIEW_CUSTOMERS,
        Permission.VIEW_REPORTS
    ]
}

def has_permission(permission: Permission) -> bool:
    """التحقق من صلاحية المستخدم الحالي"""
    role = Session.get_role()
    if not role:
        return False

    try:
        role_enum = Role(role)
    except ValueError:
        return False

    return permission in ROLE_PERMISSIONS.get(role_enum, [])

def require_permission(permission: Permission):
    """
    تستخدم داخل UI قبل تنفيذ أي عملية
    """
    if not has_permission(permission):
        raise PermissionError("ليس لديك الصلاحية لتنفيذ هذا الإجراء")

session.py له الكود التالي 
# auth/session.py

class Session:
    """إدارة جلسة المستخدم الحالية (Desktop App)"""
    
    current_user = None

    @classmethod
    def login(cls, user: dict):
        """
        user = {
            'id': int,
            'username': str,
            'role': str
        }
        """
        cls.current_user = user

    @classmethod
    def logout(cls):
        cls.current_user = None

    @classmethod
    def is_authenticated(cls) -> bool:
        return cls.current_user is not None

    @classmethod
    def get_role(cls) -> str | None:
        if not cls.current_user:
            return None
        return cls.current_user.get("role")


مجلد config يحوي الملفات التالية
ملف __init__.py فارغ
constants.py فارغ
ملف settings.py   له الكود التالي
# config/settings.py
import os
from pathlib import Path

# مسارات الملفات
BASE_DIR = Path(__file__).resolve().parent.parent
DATA_DIR = BASE_DIR / 'data'
LOG_DIR = BASE_DIR / 'logs'
BACKUP_DIR = BASE_DIR / 'backups'

# إنشاء المجلدات
for directory in [DATA_DIR, LOG_DIR, BACKUP_DIR]:
    directory.mkdir(exist_ok=True)

# إعدادات قاعدة البيانات
DATABASE_CONFIG = {
    'host': os.getenv('DB_HOST', 'localhost'),
    'port': os.getenv('DB_PORT', '5432'),
    'database': os.getenv('DB_NAME', 'electricity_billing'),
    'user': os.getenv('DB_USER', 'postgres'),
    'password': os.getenv('DB_PASSWORD', '521990')
}

# المفتاح السري للتشفير
SECRET_KEY = os.getenv('SECRET_KEY', 'your-secret-key-here-change-in-production')

# إعدادات النظام
APP_NAME = 'مولدة الريان - نظام إدارة الفواتير'
COMPANY_NAME = 'شركة الريان للطاقة الكهربائية'
VERSION = '2.0.0'

# إعدادات الطباعة
PRINTER_CONFIG = {
    'ip': '10.10.0.5',
    'port': 9100,
    'timeout': 10,
    'paper_width': 570
}

# الصلاحيات الافتراضية
DEFAULT_PERMISSIONS = {
    'admin': {
        'all': True,
        'manage_import': True,
        'delete_all_customers': True    },
    'manager': {
        'view_customers': True,
        'add_customers': True,
        'edit_customers': True,
        'delete_customers': True,
        'create_invoices': True,
        'view_invoices': True,
        'edit_invoices': True,
        'delete_invoices': True,
        'view_reports': True,
        'export_data': True,
        'manage_users': False,
        'view_activity_log': True,
        'manage_import': True  # ← أضف هذا السطر
    },
    'accountant': {
        'view_customers': True,
        'add_customers': True,
        'edit_customers': True,
        'create_invoices': True,
        'view_invoices': True,
        'view_reports': True
    }
}

# إعدادات النسخ الاحتياطي
BACKUP_CONFIG = {
    'local_backup_path': str(BACKUP_DIR),
    'remote_backup_paths': [
        r"\\10.10.0.1\D\backups",
        r"\\10.10.0.6\D\backups"
    ],
    'backup_interval_hours': 24
}

# إعدادات الأداء
PERFORMANCE_SETTINGS = {
    'fast_search_limit': 50,  # عدد نتائج البحث
    'auto_save_interval': 60,  # ثانية للحفظ التلقائي
    'cache_customers': True,   # تخزين مؤقت للزبائن
    'parallel_backup': True,   # نسخ احتياطي موازي
    'fast_printing': True,     # طباعة سريعة
}

# إعدادات الاتصال
CONNECTION_POOL = {
    'min_connections': 5,
    'max_connections': 50,
    'connection_timeout': 30,
}

مجلد database يحوي الملفات التالية 
ملف __init__.py فارغ تماما
ملف connection.py له الكود التالي
# database/connection.py
import psycopg2
from psycopg2 import pool
from psycopg2.extras import RealDictCursor
import logging
from contextlib import contextmanager
import os
from config.settings import DATABASE_CONFIG

logger = logging.getLogger(__name__)

class DatabaseConnection:
    _instance = None
    _connection_pool = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super(DatabaseConnection, cls).__new__(cls)
            cls._instance._initialize_pool()
        return cls._instance
    
    def _initialize_pool(self):
        try:
            self._connection_pool = psycopg2.pool.ThreadedConnectionPool(
                minconn=1,
                maxconn=20,
                **DATABASE_CONFIG
            )
            logger.info("تم إنشاء مجموعة اتصالات قاعدة البيانات بنجاح")
        except Exception as e:
            logger.error(f"فشل إنشاء مجموعة الاتصالات: {e}")
            raise
    
    @contextmanager
    def get_connection(self):
        conn = None
        try:
            conn = self._connection_pool.getconn()
            yield conn
        except Exception as e:
            logger.error(f"خطأ في الحصول على الاتصال: {e}")
            raise
        finally:
            if conn:
                self._connection_pool.putconn(conn)
    
    @contextmanager
    def get_cursor(self, connection=None):
        if connection:
            cursor = connection.cursor(cursor_factory=RealDictCursor)
            try:
                yield cursor
                connection.commit()
            except Exception as e:
                connection.rollback()
                logger.error(f"خطأ في تنفيذ الاستعلام: {e}")
                raise
            finally:
                cursor.close()
        else:
            with self.get_connection() as conn:
                cursor = conn.cursor(cursor_factory=RealDictCursor)
                try:
                    yield cursor
                    conn.commit()
                except Exception as e:
                    conn.rollback()
                    logger.error(f"خطأ في تنفيذ الاستعلام: {e}")
                    raise
                finally:
                    cursor.close()
    
    def close_all(self):
        if self._connection_pool:
            self._connection_pool.closeall()
            logger.info("تم إغلاق جميع اتصالات قاعدة البيانات")

# إنشاء كائن قاعدة البيانات العام
db = DatabaseConnection()
ملف migrations.py له الكود التالي 
import pandas as pd
import logging
from database.connection import db
from tqdm import tqdm
import os
from datetime import datetime
import traceback

logger = logging.getLogger(__name__)

class ExcelMigration:
    def __init__(self, excel_folder):
        self.excel_folder = excel_folder
        self.sector_mapping = {
            "بيدر": "BAIDAR",
            "غبور": "GABOR", 
            "الحديقة": "GARDEN",
            "القمر": "MOON",
            "صمصم": "SAMSAM",
            "تغرة": "TAGRA"
        }
    
    def migrate_all_data(self):
        """ترحيل جميع البيانات من Excel إلى PostgreSQL"""
        try:
            logger.info("بدء ترحيل البيانات من Excel إلى PostgreSQL")
            
            # 1. ترحيل القطاعات أولاً
            self.migrate_sectors()
            
            # 2. الحصول على mapping للقطاعات
            sector_map = self.get_sector_mapping()
            logger.info(f"تم تحميل {len(sector_map)} قطاع")
            
            # 3. ترحيل الزبائن من ملفات القطاعات
            total_customers = 0
            for arabic_name, file_name in self.sector_mapping.items():
                file_path = os.path.join(self.excel_folder, f"{file_name.lower()}.xlsx")
                if os.path.exists(file_path):
                    logger.info(f"جاري معالجة ملف: {file_path}")
                    count = self.migrate_customers_from_file(file_path, arabic_name, sector_map)
                    total_customers += count
                    logger.info(f"تم ترحيل {count} زبون من قطاع {arabic_name}")
                else:
                    logger.warning(f"الملف غير موجود: {file_path}")
            
            logger.info(f"اكتمل ترحيل البيانات بنجاح. إجمالي الزبائن: {total_customers}")
            return True
            
        except Exception as e:
            logger.error(f"خطأ في ترحيل البيانات: {e}")
            logger.error(traceback.format_exc())
            return False
    
    def get_sector_mapping(self):
        """الحصول على mapping للقطاعات"""
        sector_map = {}
        try:
            with db.get_cursor() as cursor:
                cursor.execute("SELECT id, name, code FROM sectors")
                for sector in cursor.fetchall():
                    sector_map[sector['name']] = sector['id']
                    sector_map[sector['code']] = sector['id']
            return sector_map
        except Exception as e:
            logger.error(f"خطأ في جلب القطاعات: {e}")
            return {}
    
    def migrate_sectors(self):
        """ترحيل القطاعات"""
        try:
            with db.get_cursor() as cursor:
                for arabic_name, code in self.sector_mapping.items():
                    # إدخال القطاع
                    cursor.execute("""
                        INSERT INTO sectors (name, code, is_active) 
                        VALUES (%s, %s, %s)
                        ON CONFLICT (name) DO UPDATE 
                        SET code = EXCLUDED.code,
                            updated_at = CURRENT_TIMESTAMP
                        RETURNING id
                    """, (arabic_name, code, True))
                    
                    result = cursor.fetchone()
                    logger.info(f"تم إدخال/تحديث القطاع: {arabic_name} (ID: {result['id']})")
        except Exception as e:
            logger.error(f"خطأ في ترحيل القطاعات: {e}")
    
    def migrate_customers_from_file(self, file_path, sector_name, sector_map):
        """ترحيل الزبائن من ملف قطاع"""
        customer_count = 0
        
        try:
            # قراءة ملف Excel
            df = pd.read_excel(file_path)
            logger.info(f"تم قراءة ملف {file_path}، عدد الصفوف: {len(df)}")
            
            # الحصول على معرف القطاع
            sector_id = sector_map.get(sector_name)
            if not sector_id:
                logger.error(f"القطاع غير موجود: {sector_name}")
                return 0
            
            # ترحيل كل زبون
            for index, row in tqdm(df.iterrows(), total=len(df), desc=f"ترحيل زبائن {sector_name}"):
                try:
                    # استخراج البيانات مع معالجة القيم الفارغة
                    box_number = str(row.get('علبة', '')).strip() if pd.notna(row.get('علبة', '')) else ''
                    serial_number = str(row.get('مسلسل', '')).strip() if pd.notna(row.get('مسلسل', '')) else ''
                    name = str(row.get('اسم الزبون', '')).strip() if pd.notna(row.get('اسم الزبون', '')) else ''
                    phone_number = str(row.get('رقم واتس الزبون', '')).strip() if pd.notna(row.get('رقم واتس الزبون', '')) else ''
                    
                    # تحويل القيم الرقمية بشكل آمن
                    def safe_float(value, default=0):
                        try:
                            if pd.isna(value):
                                return default
                            return float(value)
                        except:
                            return default
                    
                    # إنشاء بيانات الزبون
                    customer_data = {
                        'sector_id': sector_id,
                        'box_number': box_number,
                        'serial_number': serial_number,
                        'name': name,
                        'phone_number': phone_number,
                        'current_balance': safe_float(row.get('الرصيد', 0)),
                        'last_counter_reading': safe_float(row.get('نهاية جديدة', 0)),
                        'visa_balance': safe_float(row.get('تنزيل تأشيرة', 0)),
                        'withdrawal_amount': safe_float(row.get('سحب المشترك', 0)),
                        'notes': f"تم الاستيراد من {sector_name} في {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
                        'is_active': True
                    }
                    
                    # حذف المسافات الزائدة من الأسماء
                    if customer_data['name']:
                        customer_data['name'] = ' '.join(customer_data['name'].split())
                    
                    # حفظ الزبون في قاعدة البيانات
                    if self.save_customer(customer_data):
                        customer_count += 1
                    
                except Exception as e:
                    logger.error(f"خطأ في صف {index}: {e}")
                    continue
            
            return customer_count
            
        except Exception as e:
            logger.error(f"خطأ في ترحيل زبائن {sector_name}: {e}")
            logger.error(traceback.format_exc())
            return 0

    def save_customer(self, customer_data):
        """حفظ الزبون في قاعدة البيانات"""
        try:
            with db.get_cursor() as cursor:
                # أولاً: التحقق من وجود الزبون
                cursor.execute("""
                    SELECT id FROM customers 
                    WHERE sector_id = %s AND name = %s
                """, (customer_data['sector_id'], customer_data['name']))
                
                existing_customer = cursor.fetchone()
                
                if existing_customer:
                    # تحديث الزبون الموجود
                    cursor.execute("""
                        UPDATE customers 
                        SET box_number = %s,
                            serial_number = %s,
                            phone_number = %s,
                            current_balance = %s,
                            last_counter_reading = %s,
                            visa_balance = %s,
                            withdrawal_amount = %s,
                            notes = %s,
                            is_active = %s,
                            updated_at = CURRENT_TIMESTAMP
                        WHERE id = %s
                    """, (
                        customer_data['box_number'],
                        customer_data['serial_number'],
                        customer_data['phone_number'],
                        customer_data['current_balance'],
                        customer_data['last_counter_reading'],
                        customer_data['visa_balance'],
                        customer_data['withdrawal_amount'],
                        customer_data['notes'],
                        customer_data['is_active'],
                        existing_customer['id']
                    ))
                    logger.debug(f"تم تحديث الزبون: {customer_data['name']}")
                    return True
                else:
                    # إضافة زبون جديد
                    cursor.execute("""
                        INSERT INTO customers 
                        (sector_id, box_number, serial_number, name, phone_number,
                         current_balance, last_counter_reading, visa_balance,
                         withdrawal_amount, notes, is_active, created_at, updated_at)
                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
                        RETURNING id
                    """, (
                        customer_data['sector_id'],
                        customer_data['box_number'],
                        customer_data['serial_number'],
                        customer_data['name'],
                        customer_data['phone_number'],
                        customer_data['current_balance'],
                        customer_data['last_counter_reading'],
                        customer_data['visa_balance'],
                        customer_data['withdrawal_amount'],
                        customer_data['notes'],
                        customer_data['is_active']
                    ))
                    
                    result = cursor.fetchone()
                    logger.debug(f"تم إضافة الزبون الجديد: {customer_data['name']} (ID: {result['id']})")
                    return True
                        
        except Exception as e:
            logger.error(f"خطأ في حفظ الزبون '{customer_data['name']}': {e}")
            return False
    
    def migrate_invoices_from_archive(self, archive_path):
        """ترحيل الفواتير من الأرشيف"""
        try:
            if not os.path.exists(archive_path):
                logger.warning(f"ملف الأرشيف غير موجود: {archive_path}")
                return 0
            
            df = pd.read_excel(archive_path)
            invoice_count = 0
            
            logger.info(f"جاري ترحيل الفواتير من {archive_path}، عدد الصفوف: {len(df)}")
            
            for index, row in tqdm(df.iterrows(), total=len(df), desc="ترحيل الفواتير"):
                try:
                    invoice_data = self.prepare_invoice_data(row)
                    if invoice_data:
                        if self.save_invoice(invoice_data):
                            invoice_count += 1
                except Exception as e:
                    logger.error(f"خطأ في صف الفاتورة {index}: {e}")
                    continue
            
            logger.info(f"تم ترحيل {invoice_count} فاتورة")
            return invoice_count
            
        except Exception as e:
            logger.error(f"خطأ في ترحيل الفواتير: {e}")
            logger.error(traceback.format_exc())
            return 0
    
    def prepare_invoice_data(self, row):
        """تحضير بيانات الفاتورة"""
        try:
            # الحصول على معرف القطاع
            sector_name = str(row.get('القطاع', '')).strip()
            if not sector_name:
                return None
            
            # البحث عن القطاع
            with db.get_cursor() as cursor:
                cursor.execute("SELECT id FROM sectors WHERE name = %s OR code = %s", 
                             (sector_name, sector_name))
                sector_result = cursor.fetchone()
                
                if not sector_result:
                    logger.warning(f"القطاع غير موجود: {sector_name}")
                    return None
                
                sector_id = sector_result['id']
            
            # الحصول على معرف الزبون
            customer_name = str(row.get('اسم الزبون', '')).strip()
            if not customer_name:
                return None
            
            with db.get_cursor() as cursor:
                # البحث عن الزبون بالاسم والقطاع
                cursor.execute("""
                    SELECT id FROM customers 
                    WHERE name = %s AND sector_id = %s
                    LIMIT 1
                """, (customer_name, sector_id))
                
                customer_result = cursor.fetchone()
                
                if not customer_result:
                    # محاولة البحث بدون القطاع
                    cursor.execute("""
                        SELECT id FROM customers 
                        WHERE name = %s 
                        LIMIT 1
                    """, (customer_name,))
                    customer_result = cursor.fetchone()
                
                if not customer_result:
                    logger.warning(f"الزبون غير موجود: {customer_name}")
                    return None
                
                customer_id = customer_result['id']
            
            # معالجة القيم الرقمية
            def safe_float(value, default=0):
                try:
                    if pd.isna(value):
                        return default
                    return float(value)
                except:
                    return default
            
            # تحضير بيانات الفاتورة
            invoice_number = str(row.get('رقم الوصل', '')).strip()
            if not invoice_number:
                invoice_number = f"INV-{datetime.now().strftime('%Y%m%d%H%M%S')}-{customer_id}"
            
            # معالجة التواريخ
            try:
                payment_date = pd.to_datetime(row.get('تاريخ الدفع', datetime.now())).date()
            except:
                payment_date = datetime.now().date()
            
            try:
                payment_time = pd.to_datetime(row.get('توقيت الدفع', datetime.now())).time()
            except:
                payment_time = datetime.now().time()
            
            return {
                'customer_id': customer_id,
                'sector_id': sector_id,
                'user_id': 1,  # افتراضياً المسؤول
                'invoice_number': invoice_number,
                'payment_date': payment_date,
                'payment_time': payment_time,
                'kilowatt_amount': safe_float(row.get('كمية الدفع', 0)),
                'free_kilowatt': safe_float(row.get('المجاني', 0)),
                'price_per_kilo': safe_float(row.get('سعر الكيلو', 0)),
                'discount': safe_float(row.get('الحسم', 0)),
                'total_amount': safe_float(row.get('المبلغ الكلي', 0)),
                'previous_reading': safe_float(row.get('نهاية سابقة', 0)),
                'new_reading': safe_float(row.get('نهاية جديدة', 0)),
                'visa_application': str(row.get('تنزيل تأشيرة', '')).strip() if pd.notna(row.get('تنزيل تأشيرة', '')) else '',
                'customer_withdrawal': str(row.get('سحب المشترك', '')).strip() if pd.notna(row.get('سحب المشترك', '')) else '',
                'book_number': str(row.get('رقم الدفتر', '')).strip() if pd.notna(row.get('رقم الدفتر', '')) else '',
                'receipt_number': str(row.get('رقم الوصل', '')).strip() if pd.notna(row.get('رقم الوصل', '')) else '',
                'current_balance': safe_float(row.get('الرصيد الحالي', 0)),
                'notes': f"تم الاستيراد من الأرشيف في {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
            }
            
        except Exception as e:
            logger.error(f"خطأ في تحضير بيانات الفاتورة: {e}")
            return None
    
    def save_invoice(self, invoice_data):
        """حفظ الفاتورة في قاعدة البيانات"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                    INSERT INTO invoices 
                    (customer_id, sector_id, user_id, invoice_number, payment_date, 
                     payment_time, kilowatt_amount, free_kilowatt, price_per_kilo, 
                     discount, total_amount, previous_reading, new_reading, 
                     visa_application, customer_withdrawal, book_number, 
                     receipt_number, current_balance, notes, created_at)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, 
                            %s, %s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                    ON CONFLICT (invoice_number) DO UPDATE SET
                    customer_id = EXCLUDED.customer_id,
                    sector_id = EXCLUDED.sector_id,
                    payment_date = EXCLUDED.payment_date,
                    payment_time = EXCLUDED.payment_time,
                    kilowatt_amount = EXCLUDED.kilowatt_amount,
                    free_kilowatt = EXCLUDED.free_kilowatt,
                    price_per_kilo = EXCLUDED.price_per_kilo,
                    discount = EXCLUDED.discount,
                    total_amount = EXCLUDED.total_amount,
                    previous_reading = EXCLUDED.previous_reading,
                    new_reading = EXCLUDED.new_reading,
                    visa_application = EXCLUDED.visa_application,
                    customer_withdrawal = EXCLUDED.customer_withdrawal,
                    book_number = EXCLUDED.book_number,
                    receipt_number = EXCLUDED.receipt_number,
                    current_balance = EXCLUDED.current_balance,
                    notes = EXCLUDED.notes,
                    updated_at = CURRENT_TIMESTAMP
                    RETURNING id
                """, (
                    invoice_data['customer_id'],
                    invoice_data['sector_id'],
                    invoice_data['user_id'],
                    invoice_data['invoice_number'],
                    invoice_data['payment_date'],
                    invoice_data['payment_time'],
                    invoice_data['kilowatt_amount'],
                    invoice_data['free_kilowatt'],
                    invoice_data['price_per_kilo'],
                    invoice_data['discount'],
                    invoice_data['total_amount'],
                    invoice_data['previous_reading'],
                    invoice_data['new_reading'],
                    invoice_data['visa_application'],
                    invoice_data['customer_withdrawal'],
                    invoice_data['book_number'],
                    invoice_data['receipt_number'],
                    invoice_data['current_balance'],
                    invoice_data['notes']
                ))
                
                result = cursor.fetchone()
                if result:
                    logger.debug(f"تم حفظ الفاتورة: {invoice_data['invoice_number']}")
                    return True
                else:
                    logger.warning(f"فشل في حفظ الفاتورة: {invoice_data['invoice_number']}")
                    return False
                    
        except Exception as e:
            logger.error(f"خطأ في حفظ الفاتورة {invoice_data.get('invoice_number', 'غير معروف')}: {e}")
            return False

models.py له الكود التالي
# database/models.py
from database.connection import db
from datetime import datetime
import logging

logger = logging.getLogger(__name__)

class Models:
    def __init__(self):
        self.create_tables()

    def update_invoices_table(self):
        """تحديث جدول الفواتير بإضافة الأعمدة المفقودة"""
        try:
            with db.get_cursor() as cursor:
                # التحقق من وجود الأعمدة وإضافتها إذا كانت غير موجودة
                columns_to_add = [
                    ('free_kilowatt', 'DECIMAL(10, 2) DEFAULT 0'),
                    ('visa_application', 'VARCHAR(100)'),
                    ('customer_withdrawal', 'VARCHAR(100)'),
                    ('notes', 'TEXT')
                ]
                
                for column_name, column_type in columns_to_add:
                    # التحقق إذا كان العمود موجوداً
                    cursor.execute("""
                        SELECT column_name 
                        FROM information_schema.columns 
                        WHERE table_name = 'invoices' 
                        AND column_name = %s
                    """, (column_name,))
                    
                    if not cursor.fetchone():
                        # إضافة العمود إذا لم يكن موجوداً
                        cursor.execute(f"""
                            ALTER TABLE invoices 
                            ADD COLUMN {column_name} {column_type}
                        """)
                        logger.info(f"تم إضافة العمود {column_name} إلى جدول invoices")
                    else:
                        logger.info(f"العمود {column_name} موجود بالفعل")
                        
        except Exception as e:
            logger.error(f"خطأ في تحديث جدول invoices: {e}")

    def update_customer_history_table(self):
        """تحديث جدول سجل الزبائن بإضافة/تصحيح الأعمدة المفقودة"""
        try:
            with db.get_cursor() as cursor:
                # قائمة الأعمدة التي يجب التحقق منها وإضافتها
                columns_to_add = [
                    ('created_by', 'INTEGER REFERENCES users(id)'),
                    ('transaction_type', 'VARCHAR(50)'),
                    ('amount', 'DECIMAL(15, 2)'),
                    ('balance_before', 'DECIMAL(15, 2)'),
                    ('balance_after', 'DECIMAL(15, 2)'),
                    ('current_balance_before', 'DECIMAL(15, 2)'),
                    ('current_balance_after', 'DECIMAL(15, 2)'),
                    ('kilowatt_amount', 'DECIMAL(10, 2)'),
                    ('free_kilowatt', 'DECIMAL(10, 2) DEFAULT 0'),
                    ('price_per_kilo', 'DECIMAL(10, 2)'),
                    ('total_amount', 'DECIMAL(15, 2)'),
                    ('invoice_number', 'VARCHAR(50)'),
                    ('receipt_number', 'VARCHAR(50)'),
                    ('notes', 'TEXT'),
                    ('created_at', 'TIMESTAMP') 
                ]
                
                for column_name, column_type in columns_to_add:
                    # التحقق إذا كان العمود موجوداً
                    cursor.execute("""
                        SELECT column_name 
                        FROM information_schema.columns 
                        WHERE table_name = 'customer_history' 
                        AND column_name = %s
                    """, (column_name,))
                    
                    if not cursor.fetchone():
                        # إضافة العمود إذا لم يكن موجوداً
                        cursor.execute(f"""
                            ALTER TABLE customer_history 
                            ADD COLUMN {column_name} {column_type}
                        """)
                        logger.info(f"تم إضافة العمود {column_name} إلى جدول customer_history")
                        
                        # إذا كان العمود created_at، نقوم بتحديث القيم من performed_at
                        if column_name == 'created_at':
                            cursor.execute("""
                                UPDATE customer_history 
                                SET created_at = performed_at 
                                WHERE created_at IS NULL
                            """)
                            logger.info("تم تحديث قيم created_at من performed_at")
                    else:
                        logger.info(f"العمود {column_name} موجود بالفعل")
                    
                # حذف العمود performed_by إذا كان موجوداً (لإزالة التضارب)
                cursor.execute("""
                    SELECT column_name 
                    FROM information_schema.columns 
                    WHERE table_name = 'customer_history' 
                    AND column_name = 'performed_by'
                """)
                
                if cursor.fetchone():
                    # حذف الفهرس أولاً
                    cursor.execute("DROP INDEX IF EXISTS idx_customer_history_performed_by")
                    # ثم حذف العمود
                    cursor.execute("ALTER TABLE customer_history DROP COLUMN performed_by")
                    logger.info("تم حذف العمود performed_by من جدول customer_history")
                
        except Exception as e:
            logger.error(f"خطأ في تحديث جدول customer_history: {e}")

    def fix_customer_history_numeric_values(self):
        """تصحيح القيم النصية في الأعمدة الرقمية في جدول customer_history"""
        try:
            with db.get_cursor() as cursor:
                # التحقق من نوع البيانات في الأعمدة
                cursor.execute("""
                    SELECT column_name, data_type 
                    FROM information_schema.columns 
                    WHERE table_name = 'customer_history' 
                    AND column_name IN ('old_value', 'new_value', 'amount', 'current_balance_after')
                """)
                
                columns_info = cursor.fetchall()
                logger.info(f"معلومات أعمدة customer_history: {columns_info}")
                
                # تحديث القيم النصية إلى رقمية
                cursor.execute("""
                    UPDATE customer_history 
                    SET 
                        old_value = CASE 
                            WHEN old_value IS NULL THEN 0
                            WHEN old_value ~ '^[0-9]+(\\.[0-9]+)?$' THEN CAST(old_value AS DECIMAL(15, 2))
                            ELSE 0 
                        END,
                        new_value = CASE 
                            WHEN new_value IS NULL THEN 0
                            WHEN new_value ~ '^[0-9]+(\\.[0-9]+)?$' THEN CAST(new_value AS DECIMAL(15, 2))
                            ELSE 0 
                        END,
                        amount = CASE 
                            WHEN amount IS NULL THEN 0
                            WHEN amount ~ '^[0-9]+(\\.[0-9]+)?$' THEN CAST(amount AS DECIMAL(15, 2))
                            ELSE 0 
                        END,
                        current_balance_after = CASE 
                            WHEN current_balance_after IS NULL THEN 0
                            WHEN current_balance_after ~ '^[0-9]+(\\.[0-9]+)?$' THEN CAST(current_balance_after AS DECIMAL(15, 2))
                            ELSE 0 
                        END
                    WHERE 
                        old_value !~ '^[0-9]+(\\.[0-9]+)?$' OR 
                        new_value !~ '^[0-9]+(\\.[0-9]+)?$' OR 
                        amount !~ '^[0-9]+(\\.[0-9]+)?$' OR 
                        current_balance_after !~ '^[0-9]+(\\.[0-9]+)?$' OR
                        old_value IS NULL OR
                        new_value IS NULL OR
                        amount IS NULL OR
                        current_balance_after IS NULL
                """)
                
                rows_updated = cursor.rowcount
                if rows_updated > 0:
                    logger.info(f"تم تحديث {rows_updated} صف في جدول customer_history لتصحيح القيم الرقمية")
                else:
                    logger.info("لم تكن هناك حاجة لتحديث القيم الرقمية في جدول customer_history")
                
                # تغيير نوع البيانات للأعمدة إذا كانت لا تزال نصية
                cursor.execute("""
                    SELECT column_name, data_type 
                    FROM information_schema.columns 
                    WHERE table_name = 'customer_history' 
                    AND column_name IN ('old_value', 'new_value', 'amount', 'current_balance_after')
                    AND data_type != 'numeric'
                """)
                
                text_columns = cursor.fetchall()
                for column in text_columns:
                    column_name = column['column_name']
                    logger.info(f"تغيير نوع العمود {column_name} من {column['data_type']} إلى numeric")
                    
                    # تغيير نوع العمود إلى numeric
                    cursor.execute(f"""
                        ALTER TABLE customer_history 
                        ALTER COLUMN {column_name} TYPE DECIMAL(15, 2)
                        USING {column_name}::DECIMAL(15, 2)
                    """)
                    
                    logger.info(f"تم تغيير نوع العمود {column_name} إلى DECIMAL(15, 2)")
                    
        except Exception as e:
            logger.error(f"خطأ في تصحيح القيم الرقمية في جدول customer_history: {e}")

    def create_indexes(self, cursor):
        """إنشاء الفهارس للبحث السريع"""
        try:
            indexes = [
                "CREATE INDEX IF NOT EXISTS idx_customers_name ON customers(name);",
                "CREATE INDEX IF NOT EXISTS idx_customers_box_number ON customers(box_number);",
                "CREATE INDEX IF NOT EXISTS idx_customers_sector_id ON customers(sector_id);",
                "CREATE INDEX IF NOT EXISTS idx_customers_is_active ON customers(is_active);",
                
                "CREATE INDEX IF NOT EXISTS idx_invoices_customer_id ON invoices(customer_id);",
                "CREATE INDEX IF NOT EXISTS idx_invoices_payment_date ON invoices(payment_date);",
                "CREATE INDEX IF NOT EXISTS idx_invoices_invoice_number ON invoices(invoice_number);",
                
                "CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);",
                "CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active);",
                
                "CREATE INDEX IF NOT EXISTS idx_activity_logs_user_id ON activity_logs(user_id);",
                "CREATE INDEX IF NOT EXISTS idx_activity_logs_created_at ON activity_logs(created_at);"
            ]
            
            for index_sql in indexes:
                cursor.execute(index_sql)
            
            logger.info("تم إنشاء الفهارس للبحث السريع")
            
        except Exception as e:
            logger.error(f"خطأ في إنشاء الفهارس: {e}")
            raise

    def create_tables(self):
        """إنشاء جميع الجداول الضرورية"""
        tables_sql = [
            # جدول المستخدمين مع الصلاحيات
            """
            CREATE TABLE IF NOT EXISTS users (
                id SERIAL PRIMARY KEY,
                username VARCHAR(50) UNIQUE NOT NULL,
                password_hash VARCHAR(255) NOT NULL,
                full_name VARCHAR(100) NOT NULL,
                role VARCHAR(20) NOT NULL DEFAULT 'accountant',
                permissions JSONB DEFAULT '{}',
                is_active BOOLEAN DEFAULT TRUE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            
            # جدول القطاعات
            """
            CREATE TABLE IF NOT EXISTS sectors (
                id SERIAL PRIMARY KEY,
                name VARCHAR(50) UNIQUE NOT NULL,
                code VARCHAR(10) UNIQUE NOT NULL,
                description TEXT,
                is_active BOOLEAN DEFAULT TRUE
            )
            """,
            
            # جدول الزبائن
            """
            CREATE TABLE IF NOT EXISTS customers (
                id SERIAL PRIMARY KEY,
                sector_id INTEGER REFERENCES sectors(id),
                box_number VARCHAR(20),
                serial_number VARCHAR(20),
                name VARCHAR(100) NOT NULL,
                phone_number VARCHAR(20),
                telegram_username VARCHAR(50),
                current_balance DECIMAL(15, 2) DEFAULT 0,
                last_counter_reading DECIMAL(15, 2) DEFAULT 0,
                visa_balance DECIMAL(15, 2) DEFAULT 0,
                withdrawal_amount DECIMAL(15, 2) DEFAULT 0,
                notes TEXT,
                is_active BOOLEAN DEFAULT TRUE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            
            # جدول الفواتير (مع الأعمدة المحدثة)
            """
            CREATE TABLE IF NOT EXISTS invoices (
                id SERIAL PRIMARY KEY,
                invoice_number VARCHAR(50) UNIQUE NOT NULL,
                customer_id INTEGER REFERENCES customers(id),
                sector_id INTEGER REFERENCES sectors(id),
                user_id INTEGER REFERENCES users(id),
                
                -- بيانات الدفع
                payment_date DATE NOT NULL,
                payment_time TIME NOT NULL,
                kilowatt_amount DECIMAL(10, 2) NOT NULL,
                free_kilowatt DECIMAL(10, 2) DEFAULT 0,
                price_per_kilo DECIMAL(10, 2) NOT NULL,
                discount DECIMAL(10, 2) DEFAULT 0,
                total_amount DECIMAL(15, 2) NOT NULL,
                
                -- قراءات العداد
                previous_reading DECIMAL(15, 2) NOT NULL,
                new_reading DECIMAL(15, 2) NOT NULL,
                
                -- التأشيرات والسحب
                visa_application VARCHAR(100),
                customer_withdrawal VARCHAR(100),
                
                -- المستندات
                book_number VARCHAR(50),
                receipt_number VARCHAR(50),
                
                -- معلومات إضافية
                current_balance DECIMAL(15, 2),
                telegram_password VARCHAR(50),
                notes TEXT,
                
                -- حالة الفاتورة
                status VARCHAR(20) DEFAULT 'active',
                printed_count INTEGER DEFAULT 0,
                
                -- أرشفة
                archived_at TIMESTAMP,
                
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            
            # جدول سجل النشاطات
            """
            CREATE TABLE IF NOT EXISTS activity_logs (
                id SERIAL PRIMARY KEY,
                user_id INTEGER REFERENCES users(id),
                action_type VARCHAR(50) NOT NULL,
                description TEXT NOT NULL,
                ip_address INET,
                user_agent TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            
            # جدول أرشيف الفواتير (للأرشفة المنفصلة)
            """
            CREATE TABLE IF NOT EXISTS invoice_archive (
                id SERIAL PRIMARY KEY,
                original_invoice_id INTEGER,
                invoice_data JSONB NOT NULL,
                archived_by INTEGER REFERENCES users(id),
                archive_reason VARCHAR(100),
                archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            
            # جدول الإعدادات
            """
            CREATE TABLE IF NOT EXISTS settings (
                id SERIAL PRIMARY KEY,
                key VARCHAR(100) UNIQUE NOT NULL,
                value TEXT,
                description TEXT,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
            """,
            
            # جدول السجل التاريخي للزبائن - النسخة المحدثة
            """
            CREATE TABLE IF NOT EXISTS customer_history (
                id SERIAL PRIMARY KEY,
                customer_id INTEGER REFERENCES customers(id) ON DELETE CASCADE,
                
                -- معلومات العملية
                action_type VARCHAR(50) NOT NULL,
                transaction_type VARCHAR(50),
                details TEXT,
                notes TEXT,
                
                -- القيم القديمة والجديدة
                old_value DECIMAL(15, 2),
                new_value DECIMAL(15, 2),
                
                -- المبالغ المالية
                amount DECIMAL(15, 2),
                balance_before DECIMAL(15, 2),
                balance_after DECIMAL(15, 2),
                current_balance_before DECIMAL(15, 2),
                current_balance_after DECIMAL(15, 2),
                
                -- معلومات الفاتورة
                kilowatt_amount DECIMAL(10, 2),
                free_kilowatt DECIMAL(10, 2) DEFAULT 0,
                price_per_kilo DECIMAL(10, 2),
                total_amount DECIMAL(15, 2),
                invoice_number VARCHAR(50),
                receipt_number VARCHAR(50),
                
                -- معلومات النظام
                created_by INTEGER REFERENCES users(id),
                performed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  
            )
            """
        ]
        
        try:
            with db.get_cursor() as cursor:
                # إنشاء جميع الجداول
                for sql in tables_sql:
                    cursor.execute(sql)
                logger.info("تم إنشاء جميع الجداول بنجاح")
                
                # إضافة البيانات الأساسية
                self.seed_initial_data(cursor)
                
                # إنشاء الفهارس
                self.create_indexes(cursor)
                
        except Exception as e:
            logger.error(f"خطأ في إنشاء الجداول: {e}")
            raise
        finally:
            # تحديث جدول الفواتير بإضافة الأعمدة المفقودة (للتوافق مع الإصدارات القديمة)
            self.update_invoices_table()
            # تحديث جدول سجل الزبائن
            self.update_customer_history_table()
            # إنشاء فهارس إضافية لجدول التاريخ بعد التحديث
            self.create_history_indexes()
            # تصحيح القيم النصية في الأعمدة الرقمية
            self.fix_customer_history_numeric_values()

    def create_history_indexes(self):
        """إنشاء فهارس لجدول التاريخ"""
        try:
            with db.get_cursor() as cursor:
                history_indexes = [
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_customer_id ON customer_history(customer_id);",
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_action_type ON customer_history(action_type);",
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_transaction_type ON customer_history(transaction_type);",
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_performed_at ON customer_history(performed_at DESC);",
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_created_at ON customer_history(created_at DESC);",  # أضفت فهرس لـ created_at
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_created_by ON customer_history(created_by);",
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_invoice_number ON customer_history(invoice_number);",
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_amount ON customer_history(amount);",
                    "CREATE INDEX IF NOT EXISTS idx_customer_history_current_balance_after ON customer_history(current_balance_after);"
                ]
                
                for index_sql in history_indexes:
                    cursor.execute(index_sql)
                
                logger.info("تم إنشاء فهارس جدول التاريخ بنجاح")
                
        except Exception as e:
            logger.error(f"خطأ في إنشاء فهارس التاريخ: {e}")

    def seed_initial_data(self, cursor):
        """إضافة البيانات الأولية"""
        # إضافة القطاعات الأساسية
        sectors = [
            ("بيدر", "BAIDAR"),
            ("غبور", "GABOR"),
            ("الحديقة", "GARDEN"),
            ("القمر", "MOON"),
            ("صمصم", "SAMSAM"),
            ("تغرة", "TAGRA")
        ]
        
        for name, code in sectors:
            cursor.execute("""
                INSERT INTO sectors (name, code) 
                VALUES (%s, %s)
                ON CONFLICT (name) DO NOTHING
            """, (name, code))
        
        # إضافة المستخدم الإداري الافتراضي
        cursor.execute("""
            INSERT INTO users (username, password_hash, full_name, role, permissions)
            VALUES ('admin', 'scrypt:32768:8:1$wFnfT6hB9u3xKXqg$afb5fb045f9afab01e2036b5b7b7d4c6c9c6b2e7e6f7a8b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3', 'المسؤول العام', 'admin', '{"all": true}')
            ON CONFLICT (username) DO NOTHING
        """)
        
        # إضافة الإعدادات الافتراضية
        settings = [
            ('printer_ip', '10.10.0.5', 'عنوان IP للطابعة'),
            ('printer_port', '9100', 'منفذ الطابعة'),
            ('default_price_per_kilo', '7200', 'سعر الكيلو الافتراضي'),
            ('company_name', 'شركة الريان للطاقة الكهربائية', 'اسم الشركة'),
            ('company_phone', '0952411882', 'هاتف الشركة'),
            ('company_address', '', 'عنوان الشركة'),
            ('receipt_header', 'شركة الريان للطاقة الكهربائية', 'عنوان الفاتورة الرئيسي'),
            ('receipt_subheader', 'مدينة عريمة - شارع البريد', 'عنوان الفاتورة الفرعي'),
            ('vat_percentage', '0', 'نسبة الضريبة المضافة'),
            ('vat_number', '', 'الرقم الضريبي')
        ]
        
        for key, value, description in settings:
            cursor.execute("""
                INSERT INTO settings (key, value, description)
                VALUES (%s, %s, %s)
                ON CONFLICT (key) DO NOTHING
            """, (key, value, description))
                
        # database/models.py - تحديث دالة fix_customer_history_numeric_values فقط

    def fix_customer_history_numeric_values(self):
        """تصحيح القيم النصية في الأعمدة الرقمية في جدول customer_history"""
        try:
            with db.get_cursor() as cursor:
                # التحقق من نوع البيانات في الأعمدة
                cursor.execute("""
                    SELECT column_name, data_type 
                    FROM information_schema.columns 
                    WHERE table_name = 'customer_history' 
                    AND column_name IN ('old_value', 'new_value', 'amount', 'current_balance_after')
                """)
                
                columns_info = cursor.fetchall()
                logger.info(f"معلومات أعمدة customer_history: {columns_info}")
                
                # تحديث القيم النصية إلى رقمية للأعمدة التي لا تزال نصية فقط
                for column in columns_info:
                    column_name = column['column_name']
                    data_type = column['data_type']
                    
                    if data_type == 'text':
                        logger.info(f"معالجة العمود النصي: {column_name}")
                        
                        # تحويل القيم النصية إلى رقمية
                        cursor.execute(f"""
                            UPDATE customer_history 
                            SET {column_name} = CASE 
                                WHEN {column_name} IS NULL THEN 0
                                WHEN {column_name} ~ '^[0-9]+(\\.[0-9]+)?$' THEN CAST({column_name} AS DECIMAL(15, 2))
                                ELSE 0 
                            END
                            WHERE {column_name} IS NULL 
                            OR {column_name} !~ '^[0-9]+(\\.[0-9]+)?$'
                            OR {column_name} = ''
                        """)
                        
                        # تغيير نوع العمود إلى numeric
                        try:
                            cursor.execute(f"""
                                ALTER TABLE customer_history 
                                ALTER COLUMN {column_name} TYPE DECIMAL(15, 2)
                                USING {column_name}::DECIMAL(15, 2)
                            """)
                            logger.info(f"تم تغيير نوع العمود {column_name} من text إلى DECIMAL(15, 2)")
                        except Exception as alter_error:
                            logger.warning(f"لا يمكن تغيير نوع العمود {column_name}: {alter_error}")
                    
                    elif data_type == 'numeric':
                        logger.info(f"العمود {column_name} بالفعل من نوع numeric، لا حاجة للتحديث")
                    
                    # التعامل مع القيم الفارغة في الأعمدة الرقمية
                    cursor.execute(f"""
                        UPDATE customer_history 
                        SET {column_name} = 0
                        WHERE {column_name} IS NULL
                    """)
                    
                    rows_updated = cursor.rowcount
                    if rows_updated > 0:
                        logger.info(f"تم تحديث {rows_updated} قيمة فارغة في العمود {column_name}")
                
                logger.info("تم الانتهاء من تصحيح القيم الرقمية في جدول customer_history")
                
        except Exception as e:
            logger.error(f"خطأ في تصحيح القيم الرقمية في جدول customer_history: {e}")
            # لا نرفع الخطأ حتى لا يمنع تشغيل التطبيق        
                    
                
                        
# تأكد أن هذا السطر موجود في النهاية
models = Models()

مجلد modules له املفات التالية 
ملف __init__.py له الكود التالي
# modules/__init__.py
from .customers import CustomerManager
from .invoices import InvoiceManager
from .reports import ReportManager
from .accounting import AccountingEngine
from .archive import ArchiveManager

__all__ = [
    'CustomerManager',
    'InvoiceManager',
    'ReportManager',
    'AccountingEngine',
    'ArchiveManager',
    'HistoryManager'  # أضف هذا السطر
]

ملف accounting.py له الكود التالي
# modules/accounting.py

import logging
from datetime import datetime
from database.connection import db

logger = logging.getLogger(__name__)

class AccountingEngine:
    """
    محرك المحاسبة الرئيسي
    مسؤول عن:
    - حساب الاستهلاك
    - حساب المبلغ
    - تحديث رصيد الزبون
    - تحديث قراءة العداد
    """

    def __init__(self, kilowatt_price: float):
        self.kilowatt_price = kilowatt_price

    # =========================
    # الحسابات الأساسية
    # =========================

    def calculate_consumption(self, previous_reading: float, new_reading: float) -> float:
        """حساب الاستهلاك"""
        if new_reading < previous_reading:
            raise ValueError("القراءة الجديدة أقل من القراءة السابقة")

        return new_reading - previous_reading

    def calculate_amount(self, consumption: float) -> float:
        """حساب المبلغ المستحق"""
        return consumption * self.kilowatt_price

    # =========================
    # العملية الكاملة للفاتورة
    # =========================

    def process_invoice(
        self,
        customer_id: int,
        kilowatt_amount: float,      # كمية الدفع (بدلاً من new_reading)
        free_kilowatt: float = 0,    # المجاني
        visa_amount: float = 0,
        discount: float = 0,
        accountant_id: int = None
    ) -> dict:
        """تنفيذ عملية محاسبة كاملة للفاتورة"""
        try:
            with db.get_cursor() as cursor:
                # 1. جلب بيانات الزبون
                cursor.execute("""
                    SELECT id, name, current_balance, last_counter_reading
                    FROM customers
                    WHERE id = %s AND is_active = TRUE
                """, (customer_id,))
                customer = cursor.fetchone()
                if not customer:
                    return {'success': False, 'error': 'الزبون غير موجود'}
                
                previous_reading = float(customer['last_counter_reading'] or 0)
                current_balance = float(customer['current_balance'] or 0)
                
                # 2. الحسابات الجديدة (مثل البرنامج البسيط)
                # القراءة الجديدة = القراءة السابقة + كمية الدفع + المجاني
                new_reading = previous_reading + kilowatt_amount + free_kilowatt
                
                # المبلغ = (كمية الدفع * سعر الكيلو) - الحسم
                amount = kilowatt_amount * self.kilowatt_price
                total_amount = amount - discount
                
                # الرصيد الجديد = الرصيد القديم + كمية الدفع + المجاني
                new_balance = current_balance + kilowatt_amount + free_kilowatt
                
                # 3. تحديث بيانات الزبون
                cursor.execute("""
                    UPDATE customers
                    SET
                        current_balance = %s,
                        last_counter_reading = %s,
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                """, (
                    new_balance,
                    new_reading,
                    customer_id
                ))
                
                logger.info(
                    f"محاسبة زبون {customer['name']} | "
                    f"كمية الدفع: {kilowatt_amount} | المجاني: {free_kilowatt} | "
                    f"المبلغ: {total_amount}"
                )
                
                # 4. إرجاع البيانات
                return {
                    'success': True,
                    'customer_id': customer_id,
                    'customer_name': customer['name'],
                    'previous_reading': previous_reading,
                    'new_reading': new_reading,
                    'kilowatt_amount': kilowatt_amount,
                    'free_kilowatt': free_kilowatt,
                    'consumption': kilowatt_amount + free_kilowatt,  # إجمالي الاستهلاك
                    'kilowatt_price': self.kilowatt_price,
                    'amount': amount,
                    'discount': discount,
                    'visa_amount': visa_amount,
                    'total_amount': total_amount,
                    'new_balance': new_balance,
                    'processed_at': datetime.now().strftime("%Y-%m-%d %H:%M")
                }
                
        except Exception as e:
            logger.error(f"خطأ في المحاسبة: {e}")
            return {'success': False, 'error': str(e)}


archive.py له الكود التالي 
# modules/archive.py
import logging
import os
import shutil
from datetime import datetime
from database.connection import db

logger = logging.getLogger(__name__)

class ArchiveManager:
    """مدير عمليات الأرشيف والنسخ الاحتياطي"""
    
    def __init__(self):
        self.backup_dir = "backups"
        os.makedirs(self.backup_dir, exist_ok=True)
    
    def perform_backup(self):
        """تنفيذ نسخ احتياطي كامل"""
        try:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            backup_folder = os.path.join(self.backup_dir, f"backup_{timestamp}")
            os.makedirs(backup_folder, exist_ok=True)
            
            # تصدير البيانات من قاعدة البيانات
            self.export_database_tables(backup_folder)
            
            # نسخ ملفات النظام
            self.backup_system_files(backup_folder)
            
            logger.info(f"تم النسخ الاحتياطي في: {backup_folder}")
            return {
                'success': True,
                'backup_path': backup_folder,
                'message': f"تم النسخ الاحتياطي بنجاح في {backup_folder}"
            }
            
        except Exception as e:
            logger.error(f"فشل النسخ الاحتياطي: {e}")
            return {
                'success': False,
                'error': f"فشل النسخ الاحتياطي: {str(e)}"
            }
    
    def export_database_tables(self, backup_folder):
        """تصدير جداول قاعدة البيانات"""
        tables = ['customers', 'invoices', 'users', 'sectors', 'activity_logs']
        
        for table in tables:
            try:
                with db.get_cursor() as cursor:
                    cursor.execute(f"SELECT * FROM {table}")
                    rows = cursor.fetchall()
                    
                    if rows:
                        # تصدير كملف CSV
                        import csv
                        csv_file = os.path.join(backup_folder, f"{table}.csv")
                        with open(csv_file, 'w', newline='', encoding='utf-8') as f:
                            writer = csv.DictWriter(f, fieldnames=rows[0].keys())
                            writer.writeheader()
                            writer.writerows([dict(row) for row in rows])
                            
            except Exception as e:
                logger.error(f"خطأ في تصدير جدول {table}: {e}")
    
    def backup_system_files(self, backup_folder):
        """نسخ ملفات النظام"""
        system_files = ['config/settings.py', 'requirements.txt']
        
        for file_path in system_files:
            if os.path.exists(file_path):
                try:
                    shutil.copy2(file_path, backup_folder)
                except Exception as e:
                    logger.error(f"خطأ في نسخ ملف {file_path}: {e}")
    
    def restore_backup(self, backup_folder):
        """استعادة النسخ الاحتياطي"""
        try:
            # هنا سيتم تنفيذ منطق الاستعادة
            logger.info(f"بدأت عملية الاستعادة من: {backup_folder}")
            return {
                'success': True,
                'message': "بدأت عملية الاستعادة"
            }
            
        except Exception as e:
            logger.error(f"فشل استعادة النسخ الاحتياطي: {e}")
            return {
                'success': False,
                'error': f"فشل استعادة النسخ الاحتياطي: {str(e)}"
            }
ملف customers.py له الكود التالي 
# modules/customers.py
from database.connection import db
import logging
from typing import List, Dict, Optional

logger = logging.getLogger(__name__)

class CustomerManager:
    """مدير عمليات الزبائن"""
        
    def __init__(self):
        self.table_name = "customers"

    def add_customer(self, customer_data: Dict) -> Dict:
        """إضافة زبون جديد"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                    INSERT INTO customers 
                    (sector_id, box_number, serial_number, name, phone_number,
                    current_balance, last_counter_reading, visa_balance,
                    withdrawal_amount, notes)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                    RETURNING id, name, box_number, serial_number
                """, (
                    customer_data.get('sector_id'),
                    customer_data.get('box_number', ''),
                    customer_data.get('serial_number', ''),
                    customer_data['name'],
                    customer_data.get('phone_number', ''),
                    customer_data.get('current_balance', 0),
                    customer_data.get('last_counter_reading', 0),
                    customer_data.get('visa_balance', 0),
                    customer_data.get('withdrawal_amount', 0),
                    customer_data.get('notes', '')
                ))
                
                result = cursor.fetchone()
                
                # تسجيل العملية في السجل التاريخي
                if result:
                    cursor.execute("""
                        INSERT INTO customer_history 
                        (customer_id, action_type, transaction_type, 
                        old_value, new_value, amount,
                        current_balance_before, current_balance_after,
                        notes, created_by, created_at)
                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                    """, (
                        result['id'],
                        'add_customer',
                        'new_customer',
                        0,
                        customer_data.get('current_balance', 0),
                        customer_data.get('current_balance', 0),
                        0,
                        customer_data.get('current_balance', 0),
                        f"إضافة زبون جديد: {result['name']}",
                        customer_data.get('user_id', 1)
                    ))
                
                logger.info(f"تم إضافة زبون جديد: {result['name']}")
                return {
                    'success': True,
                    'customer_id': result['id'],
                    'message': f"تم إضافة الزبون {result['name']} بنجاح"
                }
                
        except Exception as e:
            logger.error(f"خطأ في إضافة زبون: {e}")
            return {
                'success': False,
                'error': f"فشل إضافة الزبون: {str(e)}"
            }

    def get_customer(self, customer_id: int) -> Optional[Dict]:
        """الحصول على بيانات زبون"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                    SELECT c.*, s.name as sector_name
                    FROM customers c
                    LEFT JOIN sectors s ON c.sector_id = s.id
                    WHERE c.id = %s
                """, (customer_id,))
                
                customer = cursor.fetchone()
                return dict(customer) if customer else None
                
        except Exception as e:
            logger.error(f"خطأ في جلب بيانات الزبون: {e}")
            return None

    def search_customers(self, search_term: str = "", sector_id: int = None) -> List[Dict]:
        """بحث الزبائن"""
        try:
            with db.get_cursor() as cursor:
                query = """
                    SELECT c.*, s.name as sector_name
                    FROM customers c
                    LEFT JOIN sectors s ON c.sector_id = s.id
                    WHERE c.is_active = TRUE
                """
                params = []
                
                if search_term:
                    query += " AND (c.name ILIKE %s OR c.box_number ILIKE %s OR c.phone_number ILIKE %s)"
                    params.extend([f"%{search_term}%"] * 3)
                
                if sector_id:
                    query += " AND c.sector_id = %s"
                    params.append(sector_id)
                
                query += " ORDER BY c.name"
                
                cursor.execute(query, params)
                customers = cursor.fetchall()
                
                return [dict(customer) for customer in customers]
                
        except Exception as e:
            logger.error(f"خطأ في بحث الزبائن: {e}")
            return []

    def update_customer(self, customer_id: int, update_data: Dict) -> Dict:
        """تحديث بيانات زبون مع تسجيل التاريخ"""
        try:
            with db.get_cursor() as cursor:
                # 1. جلب البيانات القديمة أولاً
                cursor.execute("""
                    SELECT 
                        c.name, c.phone_number, c.current_balance,
                        c.visa_balance, c.withdrawal_amount,
                        c.last_counter_reading, c.notes,
                        c.sector_id, c.box_number, c.serial_number,
                        c.telegram_username, c.is_active
                    FROM customers c 
                    WHERE id = %s
                """, (customer_id,))
                
                old_data = cursor.fetchone()
                if not old_data:
                    return {'success': False, 'error': 'الزبون غير موجود'}
                
                # 2. تحديث بيانات الزبون
                set_clauses = []
                params = []
                
                # التحقق من الحقول وتحديثها
                fields_to_update = {
                    'name': update_data.get('name'),
                    'sector_id': update_data.get('sector_id'),
                    'box_number': update_data.get('box_number'),
                    'serial_number': update_data.get('serial_number'),
                    'phone_number': update_data.get('phone_number'),
                    'telegram_username': update_data.get('telegram_username'),
                    'current_balance': update_data.get('current_balance'),
                    'last_counter_reading': update_data.get('last_counter_reading'),
                    'visa_balance': update_data.get('visa_balance'),
                    'withdrawal_amount': update_data.get('withdrawal_amount'),
                    'notes': update_data.get('notes'),
                    'is_active': update_data.get('is_active')
                }
                
                for field, value in fields_to_update.items():
                    if value is not None:
                        # إذا كان الرصيد يتغير، نسجل التغير
                        if field in ['current_balance', 'visa_balance', 'withdrawal_amount']:
                            old_value = float(old_data.get(field, 0))
                            new_value = float(value)
                            if old_value != new_value:
                                # تسجيل التغير في السجل التاريخي
                                self._log_balance_change(
                                    customer_id, field, old_value, new_value, 
                                    update_data.get('user_id', 1), 
                                    update_data.get('notes', '')
                                )
                        
                        set_clauses.append(f"{field} = %s")
                        params.append(value)
                
                if not set_clauses:
                    return {'success': True, 'message': 'لم يتم تغيير أي بيانات'}
                
                # إضافة معرف الزبون وتاريخ التحديث
                params.append(customer_id)
                set_clauses.append("updated_at = CURRENT_TIMESTAMP")
                
                # تنفيذ التحديث
                query = f"""
                    UPDATE customers 
                    SET {', '.join(set_clauses)}
                    WHERE id = %s
                    RETURNING id, name
                """
                
                cursor.execute(query, params)
                updated_customer = cursor.fetchone()
                
                if not updated_customer:
                    return {'success': False, 'error': 'فشل تحديث الزبون'}
                
                # 3. تسجيل العملية في سجل النشاطات
                cursor.execute("""
                    INSERT INTO activity_logs (user_id, action_type, description)
                    VALUES (%s, 'update_customer', %s)
                """, (
                    update_data.get('user_id', 1),
                    f"تم تحديث بيانات الزبون {old_data['name']} (ID: {customer_id})"
                ))
                
                # 4. تسجيل التعديل في السجل التاريخي
                self._log_customer_update(customer_id, old_data, update_data)
                
                logger.info(f"تم تحديث الزبون: {updated_customer['name']}")
                return {
                    'success': True,
                    'message': f"تم تحديث بيانات الزبون {updated_customer['name']} بنجاح"
                }
                
        except Exception as e:
            logger.error(f"خطأ في تحديث الزبون: {e}")
            return {
                'success': False,
                'error': f"فشل تحديث الزبون: {str(e)}"
            }

    def _log_balance_change(self, customer_id, field, old_value, new_value, user_id, notes):
        """تسجيل تغيير الرصيد في السجل التاريخي"""
        try:
            field_names = {
                'current_balance': 'الرصيد الحالي',
                'visa_balance': 'رصيد التأشيرة',
                'withdrawal_amount': 'مبلغ السحب'
            }
            
            with db.get_cursor() as cursor:
                # الحصول على الرصيد الحالي قبل التغيير
                cursor.execute("""
                    SELECT current_balance FROM customers WHERE id = %s
                """, (customer_id,))
                current_balance_result = cursor.fetchone()
                current_balance_before = float(current_balance_result['current_balance']) if current_balance_result else 0
                
                # تسجيل التغيير
                cursor.execute("""
                    INSERT INTO customer_history 
                    (customer_id, action_type, transaction_type, 
                    old_value, new_value, amount,
                    current_balance_before, current_balance_after,
                    notes, created_by, created_at)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                """, (
                    customer_id,
                    'balance_adjustment',
                    'manual_adjustment',
                    float(old_value),
                    float(new_value),
                    float(new_value - old_value),
                    current_balance_before,
                    float(new_value) if field == 'current_balance' else current_balance_before + (new_value - old_value),
                    f"{field_names.get(field, field)}: {old_value:,.0f} → {new_value:,.0f}. {notes}",
                    user_id
                ))
                
        except Exception as e:
            logger.error(f"خطأ في تسجيل تغيير الرصيد: {e}")

    def _log_customer_update(self, customer_id, old_data, new_data):
        """تسجيل تحديث بيانات الزبون في السجل التاريخي"""
        try:
            changes = []
            
            # مقارنة الحقول وتحديد التغيرات
            for field in ['name', 'phone_number', 'notes', 'box_number', 'serial_number']:
                old_val = old_data.get(field, '')
                new_val = new_data.get(field, '')
                
                if str(old_val).strip() != str(new_val).strip():
                    field_names = {
                        'name': 'الاسم',
                        'phone_number': 'رقم الهاتف',
                        'notes': 'ملاحظات',
                        'box_number': 'رقم العلبة',
                        'serial_number': 'رقم المسلسل'
                    }
                    
                    old_display = old_val if old_val else '(فارغ)'
                    new_display = new_val if new_val else '(فارغ)'
                    
                    changes.append(f"{field_names.get(field, field)}: {old_display} → {new_display}")
            
            if changes:
                with db.get_cursor() as cursor:
                    cursor.execute("""
                        INSERT INTO customer_history 
                        (customer_id, action_type, transaction_type, 
                        details, notes, created_by, created_at)
                        VALUES (%s, %s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                    """, (
                        customer_id,
                        'customer_update',
                        'info_update',
                        ' | '.join(changes),
                        f"تحديث بيانات الزبون: {new_data.get('name', old_data.get('name', ''))}",
                        new_data.get('user_id', 1)
                    ))
                    
        except Exception as e:
            logger.error(f"خطأ في تسجيل تحديث الزبون: {e}")

    def delete_customer(self, customer_id: int, soft_delete: bool = True) -> Dict:
        """حذف الزبون (حذف ناعم أو فعلي)"""
        try:
            with db.get_cursor() as cursor:
                # جلب بيانات الزبون قبل الحذف
                cursor.execute("SELECT name FROM customers WHERE id = %s", (customer_id,))
                customer = cursor.fetchone()
                
                if not customer:
                    return {'success': False, 'error': 'الزبون غير موجود'}
                
                customer_name = customer['name']
                
                if soft_delete:
                    # حذف ناعم
                    cursor.execute("""
                        UPDATE customers 
                        SET is_active = FALSE, updated_at = CURRENT_TIMESTAMP
                        WHERE id = %s
                        RETURNING name
                    """, (customer_id,))
                else:
                    # حذف فعلي
                    cursor.execute("""
                        DELETE FROM customers 
                        WHERE id = %s
                        RETURNING name
                    """, (customer_id,))
                
                result = cursor.fetchone()
                
                if result:
                    # تسجيل الحذف في السجل التاريخي
                    cursor.execute("""
                        INSERT INTO customer_history 
                        (customer_id, action_type, transaction_type, 
                        notes, created_by, created_at)
                        VALUES (%s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                    """, (
                        customer_id,
                        'delete_customer',
                        'soft_delete' if soft_delete else 'hard_delete',
                        f"حذف الزبون: {customer_name} ({'ناعم' if soft_delete else 'فعلي'})",
                        1  # user_id افتراضي
                    ))
                    
                    logger.info(f"تم حذف الزبون: {customer_name}")
                    return {
                        'success': True,
                        'message': f"تم حذف الزبون {customer_name} بنجاح"
                    }
                else:
                    return {
                        'success': False,
                        'error': 'فشل حذف الزبون'
                    }
                    
        except Exception as e:
            logger.error(f"خطأ في حذف الزبون: {e}")
            return {
                'success': False,
                'error': f"فشل حذف الزبون: {str(e)}"
            }

    def get_customer_statistics(self) -> Dict:
        """الحصول على إحصائيات الزبائن"""
        try:
            with db.get_cursor() as cursor:
                # إجمالي الزبائن
                cursor.execute("SELECT COUNT(*) FROM customers WHERE is_active = TRUE")
                total_customers = cursor.fetchone()['count']
                
                # الزبائن برصيد سالب
                cursor.execute("""
                    SELECT COUNT(*) 
                    FROM customers 
                    WHERE is_active = TRUE AND current_balance < 0
                """)
                negative_balance = cursor.fetchone()['count']
                
                # الزبائن برصيد موجب
                cursor.execute("""
                    SELECT COUNT(*) 
                    FROM customers 
                    WHERE is_active = TRUE AND current_balance > 0
                """)
                positive_balance = cursor.fetchone()['count']
                
                # الزبائن بدون رصيد
                cursor.execute("""
                    SELECT COUNT(*) 
                    FROM customers 
                    WHERE is_active = TRUE AND current_balance = 0
                """)
                zero_balance = cursor.fetchone()['count']
                
                return {
                    'total_customers': total_customers,
                    'negative_balance': negative_balance,
                    'positive_balance': positive_balance,
                    'zero_balance': zero_balance,
                    'negative_percentage': round((negative_balance / total_customers * 100), 2) if total_customers > 0 else 0,
                    'positive_percentage': round((positive_balance / total_customers * 100), 2) if total_customers > 0 else 0
                }
                
        except Exception as e:
            logger.error(f"خطأ في جلب إحصائيات الزبائن: {e}")
            return {}

    def get_customers_by_sector(self) -> Dict:
        """الحصول على توزيع الزبائن حسب القطاع"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                    SELECT s.name as sector_name, COUNT(c.id) as customer_count,
                        SUM(c.current_balance) as total_balance
                    FROM sectors s
                    LEFT JOIN customers c ON s.id = c.sector_id AND c.is_active = TRUE
                    GROUP BY s.id, s.name
                    ORDER BY s.name
                """)
                
                results = cursor.fetchall()
                return {
                    'sectors': [dict(row) for row in results],
                    'total': sum(row['customer_count'] or 0 for row in results)
                }
            
        except Exception as e:
            logger.error(f"خطأ في جلب توزيع الزبائن: {e}")
            return {'sectors': [], 'total': 0}

    def delete_all_customers(self, confirm=True) -> Dict:
        """حذف جميع الزبائن (يستخدم مع الحذر)"""
        try:
            with db.get_cursor() as cursor:
                # الحصول على عدد الزبائن قبل الحذف
                cursor.execute("SELECT COUNT(*) as count FROM customers")
                count_before = cursor.fetchone()['count']
                
                if count_before == 0:
                    return {
                        'success': True,
                        'message': 'لا توجد زبائن لحذفها',
                        'deleted_count': 0
                    }
                
                # تسجيل جميع الزبائن المحذوفة في السجل التاريخي
                cursor.execute("""
                    SELECT id, name FROM customers
                """)
                all_customers = cursor.fetchall()
                
                for customer in all_customers:
                    cursor.execute("""
                        INSERT INTO customer_history 
                        (customer_id, action_type, transaction_type, 
                        notes, created_by, created_at)
                        VALUES (%s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                    """, (
                        customer['id'],
                        'delete_customer',
                        'bulk_delete',
                        f"حذف جماعي - الزبون: {customer['name']}",
                        1  # user_id افتراضي
                    ))
                
                # حذف جميع الزبائن
                cursor.execute("DELETE FROM customers RETURNING id, name")
                deleted_customers = cursor.fetchall()
                
                logger.info(f"تم حذف {len(deleted_customers)} زبون")
                
                # إرجاع النتيجة مع تفاصيل الحذف
                return {
                    'success': True,
                    'deleted_count': len(deleted_customers),
                    'deleted_customers': [dict(customer) for customer in deleted_customers],
                    'message': f"تم حذف {len(deleted_customers)} زبون بنجاح"
                }
                
        except Exception as e:
            logger.error(f"خطأ في حذف جميع الزبائن: {e}")
            return {
                'success': False,
                'error': f"فشل حذف الزبائن: {str(e)}"
            }

    def delete_customers_by_sector(self, sector_id: int) -> Dict:
        """حذف زبائن قطاع محدد"""
        try:
            with db.get_cursor() as cursor:
                # الحصول على اسم القطاع
                cursor.execute("SELECT name FROM sectors WHERE id = %s", (sector_id,))
                sector = cursor.fetchone()
                
                if not sector:
                    return {'success': False, 'error': 'القطاع غير موجود'}
                
                # الحصول على زبائن القطاع قبل الحذف
                cursor.execute("""
                    SELECT id, name FROM customers WHERE sector_id = %s
                """, (sector_id,))
                sector_customers = cursor.fetchall()
                
                # تسجيل الحذف في السجل التاريخي لكل زبون
                for customer in sector_customers:
                    cursor.execute("""
                        INSERT INTO customer_history 
                        (customer_id, action_type, transaction_type, 
                        notes, created_by, created_at)
                        VALUES (%s, %s, %s, %s, %s, CURRENT_TIMESTAMP)
                    """, (
                        customer['id'],
                        'delete_customer',
                        'sector_delete',
                        f"حذف قطاعي - القطاع: {sector['name']} - الزبون: {customer['name']}",
                        1  # user_id افتراضي
                    ))
                
                # حذف زبائن القطاع
                cursor.execute("""
                    DELETE FROM customers 
                    WHERE sector_id = %s 
                    RETURNING id, name
                """, (sector_id,))
                
                deleted_customers = cursor.fetchall()
                
                logger.info(f"تم حذف {len(deleted_customers)} زبون من قطاع {sector['name']}")
                
                return {
                    'success': True,
                    'deleted_count': len(deleted_customers),
                    'sector_name': sector['name'],
                    'message': f"تم حذف {len(deleted_customers)} زبون من قطاع {sector['name']}"
                }
                
        except Exception as e:
            logger.error(f"خطأ في حذف زبائن القطاع: {e}")
            return {
                'success': False,
                'error': f"فشل حذف زبائن القطاع: {str(e)}"
            }

printing.py  ملف له الكود التالي
# modules/printing.py

import arabic_reshaper
from bidi.algorithm import get_display
from PIL import Image, ImageDraw, ImageFont
from escpos.printer import Network
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class FastPrinter:
    """طابعة سريعة تشبه الكود البسيط"""
    
    def __init__(self):
        self.config = {
            'ip': '10.10.0.5',
            'port': 9100,
            'timeout': 10,
            'paper_width': 570
        }
        self.printer = None
    
    def connect(self):
        """الاتصال بالطابعة"""
        try:
            self.printer = Network(self.config['ip'], self.config['port'], 
                                 timeout=self.config['timeout'])
            return True
        except Exception as e:
            logger.error(f"خطأ في الاتصال بالطابعة: {e}")
            return False
    
    def print_fast_invoice(self, invoice_data: dict):
        """طباعة فاتورة سريعة"""
        try:
            if not self.printer and not self.connect():
                return False
            
            # معالجة النصوص العربية
            def arabic_text(text):
                if not text:
                    return ""
                reshaped = arabic_reshaper.reshape(str(text))
                return get_display(reshaped)
            
            # بيانات الفاتورة
            company = arabic_text("شركة الريان للطاقة الكهربائية")
            customer = arabic_text(f"الزبون: {invoice_data.get('customer_name', '')}")
            sector = arabic_text(f"القطاع: {invoice_data.get('sector_name', '')}")
            box = arabic_text(f"العلبة: {invoice_data.get('box_number', '')}")
            
            # القراءات
            previous = invoice_data.get('previous_reading', 0)
            new = invoice_data.get('new_reading', 0)
            consumption = invoice_data.get('consumption', 0)
            
            # المبالغ
            price = invoice_data.get('price_per_kilo', 7200)
            total = invoice_data.get('total_amount', 0)
            balance = invoice_data.get('new_balance', 0)

            # الحصول على القيم الجديدة
            kilowatt_amount = invoice_data.get('kilowatt_amount', 0)
            free_kilowatt = invoice_data.get('free_kilowatt', 0)
                
            # الطباعة
            self.printer.set(align='center')
            self.printer.textln(company + "\n")
            
            self.printer.set(align='right')
            self.printer.textln(f"فاتورة كهرباء\n")
            
            self.printer.set(align='right')
            self.printer.textln(f"التاريخ: {datetime.now().strftime('%Y/%m/%d')}\n")
            self.printer.textln(f"الوقت: {datetime.now().strftime('%H:%M:%S')}\n")
            
            self.printer.textln("-" * 32 + "\n")
            
            self.printer.textln(customer + "\n")
            self.printer.textln(sector + "\n")
            self.printer.textln(box + "\n")
            
            if invoice_data.get('serial_number'):
                serial = arabic_text(f"المسلسل: {invoice_data.get('serial_number')}")
                self.printer.textln(serial + "\n")
            
            self.printer.textln("-" * 32 + "\n")
            
            # القراءات
            self.printer.textln(f"القراءة السابقة: {previous:,.0f}\n")
            self.printer.textln(f"القراءة الجديدة: {new:,.0f}\n")
            self.printer.textln(f"الكمية: {consumption:,.1f} كيلو\n")

             # في قسم الكميات
            if free_kilowatt > 0:
                self.printer.textln(f"الكمية المدفوعة: {kilowatt_amount:,.1f} كيلو\n")
                self.printer.textln(f"المجاني: {free_kilowatt:,.1f} كيلو\n")
                self.printer.textln(f"إجمالي القطع: {(kilowatt_amount + free_kilowatt):,.1f} كيلو\n")
            else:
                self.printer.textln(f"الكمية: {kilowatt_amount:,.1f} كيلو\n")
                
            # السعر والمبلغ
            self.printer.textln(f"سعر الكيلو: {price:,.0f} ل.س\n")
            
            if invoice_data.get('discount', 0) > 0:
                discount_text = arabic_text(f"الحسم: {invoice_data.get('discount', 0):,.0f} ل.س")
                self.printer.textln(discount_text + "\n")
            
            self.printer.set(align='center', bold=True)
            self.printer.textln(f"المبلغ الإجمالي: {total:,.0f} ليرة سورية\n")
            
            self.printer.set(align='right', bold=False)
            self.printer.textln(f"الرصيد الجديد: {balance:,.0f}\n")
            
            if invoice_data.get('visa_application'):
                visa = arabic_text(f"تنزيل تأشيرة: {invoice_data.get('visa_application')}")
                self.printer.textln(visa + "\n")
            
            self.printer.textln("-" * 32 + "\n")
            
            # التذييل
            self.printer.set(align='center')
            self.printer.textln("هاتف: 0952411882\n")
            self.printer.textln("لسنا مسؤولين عن الأعطال\n")
            self.printer.textln("التي تصيب الأجهزة الكهربائية\n")
            
            self.printer.textln("\n\n")
            self.printer.cut()
            
            return True
            
        except Exception as e:
            logger.error(f"خطأ في الطباعة السريعة: {e}")
            return False
    
    def close(self):
        """إغلاق الاتصال"""
        try:
            if self.printer:
                self.printer.close()
        except:
            pass


reports.py ملف له الكود التالي 
# modules/reports.py - النسخة الكاملة
import logging
from datetime import datetime, timedelta
from typing import List, Dict, Any, Optional
from database.connection import db

logger = logging.getLogger(__name__)

class ReportManager:
    """مدير عمليات التقارير والإحصائيات"""
    
    def __init__(self):
        pass
    
    # ============== تقارير الزبائن ==============
    
    def get_customer_balance_report(self, balance_type: str = "all") -> Dict[str, Any]:
        """تقرير رصيد الزبائن
        balance_type: all, negative, positive, zero
        """
        try:
            with db.get_cursor() as cursor:
                query = """
                SELECT 
                    c.id,
                    c.name,
                    s.name as sector_name,
                    c.box_number,
                    c.serial_number,
                    c.current_balance,
                    c.phone_number,
                    c.last_counter_reading,
                    c.visa_balance,
                    c.withdrawal_amount,
                    CASE 
                        WHEN c.current_balance < 0 THEN 'سالب'
                        WHEN c.current_balance > 0 THEN 'موجب'
                        ELSE 'صفر'
                    END as balance_status
                FROM customers c
                LEFT JOIN sectors s ON c.sector_id = s.id
                WHERE c.is_active = TRUE
                """
                
                if balance_type == "negative":
                    query += " AND c.current_balance < 0"
                elif balance_type == "positive":
                    query += " AND c.current_balance > 0"
                elif balance_type == "zero":
                    query += " AND c.current_balance = 0"
                
                query += " ORDER BY c.current_balance"
                
                cursor.execute(query)
                customers = cursor.fetchall()
                
                # حساب الإجماليات
                total_balance = 0
                negative_total = 0
                positive_total = 0
                
                for customer in customers:
                    balance = customer['current_balance']
                    total_balance += balance
                    if balance < 0:
                        negative_total += balance
                    elif balance > 0:
                        positive_total += balance
                
                return {
                    'customers': [dict(c) for c in customers],
                    'total_count': len(customers),
                    'total_balance': total_balance,
                    'negative_total': negative_total,
                    'positive_total': positive_total,
                    'report_type': balance_type,
                    'generated_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
        except Exception as e:
            logger.error(f"خطأ في توليد تقرير الرصيد: {e}")
            return {'error': str(e)}
    
    def get_customers_by_sector_report(self) -> Dict[str, Any]:
        """تقرير توزيع الزبائن حسب القطاع"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                SELECT 
                    s.name as sector_name,
                    COUNT(c.id) as customer_count,
                    SUM(c.current_balance) as total_balance,
                    AVG(c.current_balance) as average_balance,
                    MIN(c.current_balance) as min_balance,
                    MAX(c.current_balance) as max_balance,
                    SUM(CASE WHEN c.current_balance < 0 THEN 1 ELSE 0 END) as negative_count,
                    SUM(CASE WHEN c.current_balance > 0 THEN 1 ELSE 0 END) as positive_count,
                    SUM(CASE WHEN c.current_balance = 0 THEN 1 ELSE 0 END) as zero_count
                FROM sectors s
                LEFT JOIN customers c ON s.id = c.sector_id AND c.is_active = TRUE
                GROUP BY s.id, s.name
                ORDER BY customer_count DESC
                """)
                
                sectors = cursor.fetchall()
                
                return {
                    'sectors': [dict(s) for s in sectors],
                    'generated_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
        except Exception as e:
            logger.error(f"خطأ في توليد تقرير القطاعات: {e}")
            return {'error': str(e)}
    
    # ============== تقارير المبيعات ==============
    
    def get_sales_report(self, start_date: str = None, end_date: str = None, 
                         group_by: str = 'daily') -> Dict[str, Any]:
        """تقرير المبيعات
        group_by: daily, monthly, yearly, sector
        """
        try:
            if not start_date:
                start_date = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
            if not end_date:
                end_date = datetime.now().strftime("%Y-%m-%d")
            
            with db.get_cursor() as cursor:
                # بناء الاستعلام حسب نوع التجميع
                if group_by == 'daily':
                    group_clause = "DATE(i.payment_date)"
                    select_fields = "DATE(i.payment_date) as period"
                elif group_by == 'monthly':
                    group_clause = "EXTRACT(YEAR FROM i.payment_date), EXTRACT(MONTH FROM i.payment_date)"
                    select_fields = "TO_CHAR(i.payment_date, 'YYYY-MM') as period"
                elif group_by == 'yearly':
                    group_clause = "EXTRACT(YEAR FROM i.payment_date)"
                    select_fields = "EXTRACT(YEAR FROM i.payment_date) as period"
                elif group_by == 'sector':
                    group_clause = "s.id"
                    select_fields = "s.name as period"
                
                query = f"""
                SELECT 
                    {select_fields},
                    COUNT(i.id) as invoice_count,
                    SUM(i.total_amount) as total_amount,
                    SUM(i.kilowatt_amount) as total_kilowatts,
                    SUM(i.free_kilowatt) as total_free,
                    SUM(i.discount) as total_discount,
                    AVG(i.total_amount) as average_amount,
                    MIN(i.total_amount) as min_amount,
                    MAX(i.total_amount) as max_amount
                FROM invoices i
                """
                
                if group_by == 'sector':
                    query += " LEFT JOIN sectors s ON i.sector_id = s.id"
                
                query += f"""
                WHERE i.payment_date BETWEEN %s AND %s
                GROUP BY {group_clause}
                ORDER BY period
                """
                
                cursor.execute(query, (start_date, end_date))
                sales_data = cursor.fetchall()
                
                # حساب الإجماليات
                cursor.execute("""
                SELECT 
                    COUNT(i.id) as total_invoices,
                    SUM(i.total_amount) as grand_total,
                    SUM(i.kilowatt_amount) as total_kilowatts,
                    SUM(i.free_kilowatt) as total_free,
                    SUM(i.discount) as total_discount
                FROM invoices i
                WHERE i.payment_date BETWEEN %s AND %s
                """, (start_date, end_date))
                
                totals = cursor.fetchone()
                
                return {
                    'period': {
                        'start_date': start_date,
                        'end_date': end_date
                    },
                    'group_by': group_by,
                    'sales_data': [dict(d) for d in sales_data],
                    'totals': dict(totals),
                    'generated_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
        except Exception as e:
            logger.error(f"خطأ في توليد تقرير المبيعات: {e}")
            return {'error': str(e)}
    
    def get_daily_sales_summary(self, date: str = None) -> Dict[str, Any]:
        """ملخص المبيعات اليومية"""
        try:
            if not date:
                date = datetime.now().strftime("%Y-%m-%d")
            
            with db.get_cursor() as cursor:
                # بيانات اليوم
                cursor.execute("""
                SELECT 
                    COUNT(*) as invoice_count,
                    SUM(total_amount) as total_amount,
                    SUM(kilowatt_amount) as total_kilowatts,
                    SUM(free_kilowatt) as total_free,
                    SUM(discount) as total_discount,
                    AVG(total_amount) as average_amount
                FROM invoices
                WHERE payment_date = %s
                """, (date,))
                
                today = cursor.fetchone()
                
                # بيانات الأمس للمقارنة
                yesterday = (datetime.strptime(date, "%Y-%m-%d") - timedelta(days=1)).strftime("%Y-%m-%d")
                
                cursor.execute("""
                SELECT 
                    COUNT(*) as invoice_count,
                    SUM(total_amount) as total_amount
                FROM invoices
                WHERE payment_date = %s
                """, (yesterday,))
                
                yesterday_data = cursor.fetchone()
                
                # حساب نسبة التغير
                if yesterday_data and yesterday_data['total_amount']:
                    change_percentage = ((today['total_amount'] or 0) - yesterday_data['total_amount']) / yesterday_data['total_amount'] * 100
                else:
                    change_percentage = 0
                
                # أفضل 5 زبائن في اليوم
                cursor.execute("""
                SELECT 
                    c.name as customer_name,
                    s.name as sector_name,
                    COUNT(i.id) as invoice_count,
                    SUM(i.total_amount) as total_amount
                FROM invoices i
                LEFT JOIN customers c ON i.customer_id = c.id
                LEFT JOIN sectors s ON i.sector_id = s.id
                WHERE i.payment_date = %s
                GROUP BY c.id, c.name, s.name
                ORDER BY total_amount DESC
                LIMIT 5
                """, (date,))
                
                top_customers = cursor.fetchall()
                
                return {
                    'date': date,
                    'today': dict(today),
                    'yesterday': dict(yesterday_data),
                    'change_percentage': round(change_percentage, 2),
                    'top_customers': [dict(c) for c in top_customers],
                    'generated_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
        except Exception as e:
            logger.error(f"خطأ في توليد ملخص المبيعات اليومية: {e}")
            return {'error': str(e)}
    
    # ============== تقارير الفواتير ==============
    
    def get_invoice_detailed_report(self, start_date: str = None, end_date: str = None,
                                   customer_id: int = None, sector_id: int = None) -> Dict[str, Any]:
        """تقرير تفصيلي للفواتير"""
        try:
            if not start_date:
                start_date = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
            if not end_date:
                end_date = datetime.now().strftime("%Y-%m-%d")
            
            with db.get_cursor() as cursor:
                query = """
                SELECT 
                    i.id,
                    i.invoice_number,
                    i.payment_date,
                    i.payment_time,
                    c.name as customer_name,
                    s.name as sector_name,
                    i.kilowatt_amount,
                    i.free_kilowatt,
                    i.price_per_kilo,
                    i.discount,
                    i.total_amount,
                    i.previous_reading,
                    i.new_reading,
                    i.current_balance,
                    u.full_name as accountant_name,
                    i.book_number,
                    i.receipt_number
                FROM invoices i
                LEFT JOIN customers c ON i.customer_id = c.id
                LEFT JOIN sectors s ON i.sector_id = s.id
                LEFT JOIN users u ON i.user_id = u.id
                WHERE i.payment_date BETWEEN %s AND %s
                """
                
                params = [start_date, end_date]
                
                if customer_id:
                    query += " AND i.customer_id = %s"
                    params.append(customer_id)
                
                if sector_id:
                    query += " AND i.sector_id = %s"
                    params.append(sector_id)
                
                query += " ORDER BY i.payment_date DESC, i.payment_time DESC"
                
                cursor.execute(query, params)
                invoices = cursor.fetchall()
                
                return {
                    'period': {
                        'start_date': start_date,
                        'end_date': end_date
                    },
                    'invoices': [dict(i) for i in invoices],
                    'total_count': len(invoices),
                    'generated_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
        except Exception as e:
            logger.error(f"خطأ في توليد تقرير الفواتير: {e}")
            return {'error': str(e)}
    
    # ============== التقارير الإحصائية ==============
    
    def get_dashboard_statistics(self) -> Dict[str, Any]:
        """إحصائيات لوحة التحكم"""
        try:
            with db.get_cursor() as cursor:
                # إجمالي الزبائن
                cursor.execute("SELECT COUNT(*) FROM customers WHERE is_active = TRUE")
                total_customers = cursor.fetchone()['count']
                
                # الفواتير اليوم
                today = datetime.now().strftime("%Y-%m-%d")
                cursor.execute("""
                SELECT COUNT(*) as count, COALESCE(SUM(total_amount), 0) as total
                FROM invoices WHERE payment_date = %s
                """, (today,))
                today_result = cursor.fetchone()
                
                # الفواتير الشهر
                first_day_of_month = datetime.now().replace(day=1).strftime("%Y-%m-%d")
                cursor.execute("""
                SELECT COUNT(*) as count, COALESCE(SUM(total_amount), 0) as total
                FROM invoices WHERE payment_date >= %s
                """, (first_day_of_month,))
                month_result = cursor.fetchone()
                
                # الرصيد السالب
                cursor.execute("""
                SELECT COUNT(*), COALESCE(SUM(current_balance), 0) as total
                FROM customers WHERE is_active = TRUE AND current_balance < 0
                """)
                negative_result = cursor.fetchone()
                
                # الرصيد الموجب
                cursor.execute("""
                SELECT COUNT(*), COALESCE(SUM(current_balance), 0) as total
                FROM customers WHERE is_active = TRUE AND current_balance > 0
                """)
                positive_result = cursor.fetchone()
                
                # أفضل القطاعات أداءً
                cursor.execute("""
                SELECT s.name, COUNT(i.id) as invoice_count, 
                       COALESCE(SUM(i.total_amount), 0) as total_amount
                FROM sectors s
                LEFT JOIN invoices i ON s.id = i.sector_id 
                    AND i.payment_date >= %s
                GROUP BY s.id, s.name
                ORDER BY total_amount DESC
                LIMIT 5
                """, (first_day_of_month,))
                top_sectors = cursor.fetchall()
                
                return {
                    'total_customers': total_customers,
                    'today_invoices': today_result['count'],
                    'today_amount': float(today_result['total']),
                    'month_invoices': month_result['count'],
                    'month_amount': float(month_result['total']),
                    'negative_count': negative_result['count'],
                    'negative_total': float(negative_result['total']),
                    'positive_count': positive_result['count'],
                    'positive_total': float(positive_result['total']),
                    'top_sectors': [dict(s) for s in top_sectors],
                    'generated_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
        except Exception as e:
            logger.error(f"خطأ في جلب إحصائيات لوحة التحكم: {e}")
            return self.get_sample_statistics()
    
    def get_sample_statistics(self) -> Dict[str, Any]:
        """إرجاع إحصائيات تجريبية في حالة الخطأ"""
        return {
            'total_customers': 150,
            'today_invoices': 25,
            'today_amount': 1250000,
            'month_invoices': 500,
            'month_amount': 25000000,
            'negative_count': 12,
            'negative_total': -50000,
            'positive_count': 138,
            'positive_total': 2550000
        }
    
    # ============== تصدير التقارير ==============
    
    def export_report_to_excel(self, report_data: Dict[str, Any], report_type: str) -> str:
        """تصدير التقرير إلى ملف Excel"""
        try:
            import pandas as pd
            import os
            from datetime import datetime
            
            # إنشاء مجلد التصدير إذا لم يكن موجوداً
            export_dir = "exports"
            os.makedirs(export_dir, exist_ok=True)
            
            # اسم الملف
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"{export_dir}/{report_type}_{timestamp}.xlsx"
            
            # تحويل البيانات إلى DataFrame
            df = pd.DataFrame()
            
            if 'customers' in report_data:
                df = pd.DataFrame(report_data['customers'])
            elif 'sales_data' in report_data:
                df = pd.DataFrame(report_data['sales_data'])
            elif 'invoices' in report_data:
                df = pd.DataFrame(report_data['invoices'])
            elif 'sectors' in report_data:
                df = pd.DataFrame(report_data['sectors'])
            
            # حفظ في Excel
            with pd.ExcelWriter(filename, engine='openpyxl') as writer:
                df.to_excel(writer, sheet_name='Report', index=False)
                
                # تنسيق الأعمدة
                worksheet = writer.sheets['Report']
                for column in worksheet.columns:
                    max_length = 0
                    column_letter = column[0].column_letter
                    for cell in column:
                        try:
                            if len(str(cell.value)) > max_length:
                                max_length = len(str(cell.value))
                        except:
                            pass
                    adjusted_width = min(max_length + 2, 50)
                    worksheet.column_dimensions[column_letter].width = adjusted_width
            
            return filename
            
        except Exception as e:
            logger.error(f"خطأ في تصدير التقرير: {e}")
            return ""

ملف fast_operations.py له الكود التالي
# modules/fast_operations.py
"""
وحدة العمليات السريعة للمهام اليومية
تشبه الكود البسيط في السرعة مع الحفاظ على PostgreSQL
"""
import logging
from datetime import datetime
from database.connection import db
import pandas as pd
from typing import List, Dict, Any

logger = logging.getLogger(__name__)

class FastOperations:
    """عمليات سريعة للاستخدام اليومي"""
    
    @staticmethod
    def fast_search_customers(search_term: str = "", sector_id: int = None, limit: int = 50) -> List[Dict]:
        """بحث سريع بالزبائن (مشابه للبحث في Excel)"""
        try:
            with db.get_cursor() as cursor:
                query = """
                    SELECT 
                        c.id, c.name, c.box_number, c.serial_number,
                        c.current_balance, c.last_counter_reading,
                        c.visa_balance, c.withdrawal_amount,
                        s.name as sector_name,
                        CONCAT(c.box_number, ' - ', c.name) as display_text
                    FROM customers c
                    LEFT JOIN sectors s ON c.sector_id = s.id
                    WHERE c.is_active = TRUE
                """
                
                params = []
                
                if search_term:
                    # بحث في الاسم أو العلبة أو المسلسل
                    query += """
                        AND (
                            c.name ILIKE %s 
                            OR c.box_number ILIKE %s 
                            OR c.serial_number ILIKE %s
                        )
                    """
                    search_pattern = f"%{search_term}%"
                    params.extend([search_pattern, search_pattern, search_pattern])
                
                if sector_id:
                    query += " AND c.sector_id = %s"
                    params.append(sector_id)
                
                query += " ORDER BY c.name LIMIT %s"
                params.append(limit)
                
                cursor.execute(query, params)
                results = cursor.fetchall()
                
                # تحويل إلى قائمة من القواميس
                return [dict(row) for row in results]
                
        except Exception as e:
            logger.error(f"خطأ في البحث السريع: {e}")
            return []
    
    @staticmethod
    def fast_get_customer_details(customer_id: int) -> Dict:
        """جلب بيانات زبون سريعاً"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("""
                    SELECT 
                        c.*, s.name as sector_name,
                        s.code as sector_code,
                        (
                            SELECT invoice_number 
                            FROM invoices 
                            WHERE customer_id = c.id 
                            ORDER BY payment_date DESC, payment_time DESC 
                            LIMIT 1
                        ) as last_invoice
                    FROM customers c
                    LEFT JOIN sectors s ON c.sector_id = s.id
                    WHERE c.id = %s
                """, (customer_id,))
                
                result = cursor.fetchone()
                return dict(result) if result else {}
                
        except Exception as e:
            logger.error(f"خطأ في جلب بيانات الزبون: {e}")
            return {}
            
    @staticmethod
    def fast_process_invoice(customer_id: int, **kwargs):
        """معالجة فاتورة سريعة"""
        try:
            # استقبال البيانات الجديدة
            kilowatt_amount = float(kwargs.get('kilowatt_amount', 0))
            free_kilowatt = float(kwargs.get('free_kilowatt', 0))
            price_per_kilo = float(kwargs.get('price_per_kilo', 7200))
            discount = float(kwargs.get('discount', 0))
            user_id = kwargs.get('user_id', 1)
            
            with db.get_cursor() as cursor:
                # جلب بيانات الزبون
                cursor.execute("""
                    SELECT
                        c.current_balance,
                        c.last_counter_reading,
                        c.sector_id,
                        c.name,
                        s.name as sector_name
                    FROM customers c
                    INNER JOIN sectors s ON c.sector_id = s.id
                    WHERE c.id = %s AND c.is_active = TRUE
                    FOR UPDATE
                """, (customer_id,))
                
                customer = cursor.fetchone()
                if not customer:
                    return {"success": False, "error": "الزبون غير موجود"}
                
                previous_reading = float(customer['last_counter_reading'] or 0)
                current_balance = float(customer['current_balance'] or 0)
                
                # الحسابات الجديدة
                new_reading = previous_reading + kilowatt_amount + free_kilowatt
                new_balance = current_balance + kilowatt_amount + free_kilowatt
                total_amount = (kilowatt_amount * price_per_kilo) - discount
                
                # إنشاء رقم فاتورة
                invoice_number = f"INV-{datetime.now().strftime('%Y%m%d%H%M%S')}-{customer_id}"
                
                # تحديث بيانات الزبون
                cursor.execute("""
                    UPDATE customers
                    SET current_balance = %s,
                        last_counter_reading = %s,
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                    RETURNING *
                """, (float(new_balance), float(new_reading), customer_id))
                
                # إدخال الفاتورة
                cursor.execute("""
                    INSERT INTO invoices (
                        customer_id, sector_id, user_id, invoice_number,
                        payment_date, payment_time, kilowatt_amount, free_kilowatt,
                        price_per_kilo, discount, total_amount,
                        previous_reading, new_reading, visa_application, customer_withdrawal,
                        current_balance, created_at
                    ) VALUES (
                        %s, %s, %s, %s,
                        CURRENT_DATE, CURRENT_TIME, %s, %s,
                        %s, %s, %s, %s, %s, %s, %s,
                        %s, CURRENT_TIMESTAMP
                    )
                    RETURNING id
                """, (
                    customer_id, customer['sector_id'], user_id, invoice_number,
                    float(kilowatt_amount), float(free_kilowatt), float(price_per_kilo),
                    float(discount), float(total_amount),
                    float(previous_reading), float(new_reading),
                    kwargs.get('visa_application', ''),
                    kwargs.get('customer_withdrawal', ''),
                    float(new_balance)
                ))
                
                invoice_id = cursor.fetchone()['id']
                
                # تسجيل النشاط
                cursor.execute("""
                    INSERT INTO activity_logs (user_id, action_type, description)
                    VALUES (%s, 'fast_invoice', %s)
                """, (user_id, f"فاتورة سريعة #{invoice_number} للزبون {customer['name']}"))
                
                return {
                    "success": True,
                    "invoice_id": invoice_id,
                    "invoice_number": invoice_number,
                    "customer_name": customer['name'],
                    "previous_reading": previous_reading,
                    "new_reading": new_reading,
                    "kilowatt_amount": kilowatt_amount,
                    "free_kilowatt": free_kilowatt,
                    "total_amount": total_amount,
                    "new_balance": new_balance,
                    "processed_at": datetime.now().strftime("%Y-%m-%d %H:%M")
                }
                    
        except Exception as e:
            logger.error(f"خطأ في المعالجة السريعة: {e}")
            return {"success": False, "error": str(e)}

    @staticmethod
    def quick_export_to_excel(data: List[Dict], filename: str) -> str:
        """تصدير سريع إلى Excel"""
        try:
            df = pd.DataFrame(data)
            df.to_excel(filename, index=False, engine='openpyxl')
            return filename
        except Exception as e:
            logger.error(f"خطأ في التصدير: {e}")
            return ""
    
    @staticmethod
    def backup_to_excel_parallel() -> bool:
        """نسخ احتياطي موازي إلى Excel (مثل النظام القديم)"""
        try:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            backup_file = f"backups/parallel_backup_{timestamp}.xlsx"
            
            with pd.ExcelWriter(backup_file, engine='openpyxl') as writer:
                # تصدير الزبائن
                with db.get_cursor() as cursor:
                    cursor.execute("SELECT * FROM customers")
                    customers = cursor.fetchall()
                    if customers:
                        df_customers = pd.DataFrame([dict(c) for c in customers])
                        df_customers.to_excel(writer, sheet_name='customers', index=False)
                
                # تصدير الفواتير الأخيرة (آخر 1000)
                with db.get_cursor() as cursor:
                    cursor.execute("""
                        SELECT i.*, c.name as customer_name, s.name as sector_name
                        FROM invoices i
                        LEFT JOIN customers c ON i.customer_id = c.id
                        LEFT JOIN sectors s ON i.sector_id = s.id
                        ORDER BY i.payment_date DESC, i.payment_time DESC
                        LIMIT 1000
                    """)
                    invoices = cursor.fetchall()
                    if invoices:
                        df_invoices = pd.DataFrame([dict(i) for i in invoices])
                        df_invoices.to_excel(writer, sheet_name='invoices', index=False)

                # في دالة backup_to_excel_parallel() بعد تصدير الفواتير
                # تصدير السجل التاريخي
                with db.get_cursor() as cursor:
                    cursor.execute('''
                        SELECT h.*, c.name as customer_name
                        FROM customer_history h
                        LEFT JOIN customers c ON h.customer_id = c.id
                        ORDER BY h.created_at DESC
                        LIMIT 5000
                    ''')
                    history = cursor.fetchall()
                    if history:
                        df_history = pd.DataFrame([dict(h) for h in history])
                        df_history.to_excel(writer, sheet_name='history', index=False)

            
            logger.info(f"تم النسخ الاحتياطي الموازي: {backup_file}")
            return True
            
        except Exception as e:
            logger.error(f"خطأ في النسخ الاحتياطي الموازي: {e}")
            return False


ملف  history_manager.py    له الكود التالي
# modules/history_manager.py - تصحيح الأخطاء

import logging
from datetime import datetime
from database.connection import db
from typing import Dict, List, Optional

logger = logging.getLogger(__name__)

class HistoryManager:
    """مدير سجل العمليات التاريخية للزبائن"""
    
    TRANSACTION_TYPES = {
        'weekly_visa': 'إضافة تأشيرة أسبوعية',
        'cash_withdrawal': 'سحب نقدي',
        'counter_reading': 'قراءة عداد',
        'discount': 'حسم',
        'balance_adjustment': 'تعديل رصيد',
        'visa_adjustment': 'تعديل تأشيرة',
        'initial_balance': 'رصيد ابتدائي',
        'manual_adjustment': 'تعديل يدوي',
        'customer_update': 'تحديث بيانات الزبون',
        'new_customer': 'زبون جديد',
        'delete_customer': 'حذف الزبون',
        'info_update': 'تحديث معلومات',
        'balance_adjustment': 'تعديل رصيد',
        'visa_adjustment': 'تعديل تأشيرة',
        'soft_delete': 'حذف ناعم',
        'hard_delete': 'حذف فعلي',
        'bulk_delete': 'حذف جماعي',
        'sector_delete': 'حذف قطاعي'
    }
    
    def _safe_format_number(self, value, default=0.0):
        """تنسيق الأرقام بشكل آمن"""
        if value is None:
            return default
        try:
            return float(value)
        except (ValueError, TypeError):
            return default
    
    def log_transaction(self, 
                       customer_id: int,
                       transaction_type: str,
                       old_value: float = 0,
                       new_value: float = 0,
                       amount: float = 0,
                       current_balance_after: float = 0,
                       notes: str = '',
                       created_by: int = None) -> Dict:
        """تسجيل عملية في السجل التاريخي"""
        
        try:
            with db.get_cursor() as cursor:
                cursor.execute('''
                    INSERT INTO customer_history 
                    (customer_id, transaction_type, old_value, new_value,
                     amount, current_balance_after, notes, created_by)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                    RETURNING id, created_at
                ''', (
                    customer_id,
                    transaction_type,
                    old_value,
                    new_value,
                    amount,
                    current_balance_after,
                    notes,
                    created_by
                ))
                
                result = cursor.fetchone()
                
                logger.info(
                    f"تم تسجيل عملية تاريخية: {transaction_type} "
                    f"للزبون {customer_id}"
                )
                
                return {
                    'success': True,
                    'transaction_id': result['id'],
                    'created_at': result['created_at']
                }
                
        except Exception as e:
            logger.error(f"خطأ في تسجيل العملية التاريخية: {e}")
            return {'success': False, 'error': str(e)}
    
    def add_weekly_visa(self, 
                       customer_id: int,
                       visa_amount: float,
                       notes: str = '',
                       user_id: int = None) -> Dict:
        """إضافة تأشيرة أسبوعية للزبون"""
        
        try:
            with db.get_cursor() as cursor:
                # 1. جلب بيانات الزبون الحالية
                cursor.execute('''
                    SELECT visa_balance, current_balance
                    FROM customers 
                    WHERE id = %s
                    FOR UPDATE
                ''', (customer_id,))
                
                customer = cursor.fetchone()
                if not customer:
                    return {'success': False, 'error': 'الزبون غير موجود'}
                
                old_visa = float(customer['visa_balance'] or 0)
                old_balance = float(customer['current_balance'] or 0)
                
                # 2. حساب القيم الجديدة
                new_visa = old_visa + visa_amount
                new_balance = old_balance + visa_amount
                
                # 3. تحديث بيانات الزبون
                cursor.execute('''
                    UPDATE customers 
                    SET visa_balance = %s,
                        current_balance = %s,
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                    RETURNING id
                ''', (new_visa, new_balance, customer_id))
                
                # 4. تسجيل العملية في السجل التاريخي
                history_result = self.log_transaction(
                    customer_id=customer_id,
                    transaction_type='weekly_visa',
                    old_value=old_visa,
                    new_value=new_visa,
                    amount=visa_amount,
                    current_balance_after=new_balance,
                    notes=f"{notes} - إضافة تأشيرة أسبوعية: {visa_amount:,.0f}",
                    created_by=user_id
                )
                
                if not history_result['success']:
                    cursor.execute("ROLLBACK")
                    return history_result
                
                return {
                    'success': True,
                    'customer_id': customer_id,
                    'old_visa': old_visa,
                    'new_visa': new_visa,
                    'old_balance': old_balance,
                    'new_balance': new_balance,
                    'amount': visa_amount,
                    'transaction_id': history_result.get('transaction_id'),
                    'message': f'تم إضافة تأشيرة أسبوعية: {visa_amount:,.0f}'
                }
                
        except Exception as e:
            logger.error(f"خطأ في إضافة التأشيرة الأسبوعية: {e}")
            return {'success': False, 'error': str(e)}
    
    def add_cash_withdrawal(self,
                          customer_id: int,
                          withdrawal_amount: float,
                          notes: str = '',
                          user_id: int = None) -> Dict:
        """إضافة سحب نقدي للزبون"""
        
        try:
            with db.get_cursor() as cursor:
                # 1. جلب بيانات الزبون الحالية
                cursor.execute('''
                    SELECT withdrawal_amount, current_balance
                    FROM customers 
                    WHERE id = %s
                    FOR UPDATE
                ''', (customer_id,))
                
                customer = cursor.fetchone()
                if not customer:
                    return {'success': False, 'error': 'الزبون غير موجود'}
                
                old_withdrawal = float(customer['withdrawal_amount'] or 0)
                old_balance = float(customer['current_balance'] or 0)
                
                # 2. حساب القيم الجديدة
                new_withdrawal = old_withdrawal + withdrawal_amount
                new_balance = old_balance - withdrawal_amount  # السحب يقلل الرصيد
                
                # 3. تحديث بيانات الزبون
                cursor.execute('''
                    UPDATE customers 
                    SET withdrawal_amount = %s,
                        current_balance = %s,
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                    RETURNING id
                ''', (new_withdrawal, new_balance, customer_id))
                
                # 4. تسجيل العملية في السجل التاريخي
                history_result = self.log_transaction(
                    customer_id=customer_id,
                    transaction_type='cash_withdrawal',
                    old_value=old_withdrawal,
                    new_value=new_withdrawal,
                    amount=withdrawal_amount,
                    current_balance_after=new_balance,
                    notes=f"{notes} - سحب نقدي: {withdrawal_amount:,.0f}",
                    created_by=user_id
                )
                
                if not history_result['success']:
                    cursor.execute("ROLLBACK")
                    return history_result
                
                return {
                    'success': True,
                    'customer_id': customer_id,
                    'old_withdrawal': old_withdrawal,
                    'new_withdrawal': new_withdrawal,
                    'old_balance': old_balance,
                    'new_balance': new_balance,
                    'amount': withdrawal_amount,
                    'transaction_id': history_result.get('transaction_id'),
                    'message': f'تم إضافة سحب نقدي: {withdrawal_amount:,.0f}'
                }
                
        except Exception as e:
            logger.error(f"خطأ في إضافة السحب النقدي: {e}")
            return {'success': False, 'error': str(e)}
    
    def update_counter_reading(self,
                             customer_id: int,
                             new_reading: float,
                             notes: str = '',
                             user_id: int = None) -> Dict:
        """تحديث قراءة العداد"""
        
        try:
            with db.get_cursor() as cursor:
                # 1. جلب بيانات الزبون الحالية
                cursor.execute('''
                    SELECT last_counter_reading, current_balance
                    FROM customers 
                    WHERE id = %s
                    FOR UPDATE
                ''', (customer_id,))
                
                customer = cursor.fetchone()
                if not customer:
                    return {'success': False, 'error': 'الزبون غير موجود'}
                
                old_reading = float(customer['last_counter_reading'] or 0)
                current_balance = float(customer['current_balance'] or 0)
                
                if new_reading < old_reading:
                    return {
                        'success': False,
                        'error': 'القراءة الجديدة أقل من القراءة السابقة'
                    }
                
                # 2. تحديث بيانات الزبون
                cursor.execute('''
                    UPDATE customers 
                    SET last_counter_reading = %s,
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = %s
                    RETURNING id, current_balance
                ''', (new_reading, customer_id))
                
                updated_customer = cursor.fetchone()
                if updated_customer:
                    current_balance = float(updated_customer['current_balance'] or 0)
                
                # 3. تسجيل العملية في السجل التاريخي
                history_result = self.log_transaction(
                    customer_id=customer_id,
                    transaction_type='counter_reading',
                    old_value=old_reading,
                    new_value=new_reading,
                    amount=new_reading - old_reading,  # كمية الاستهلاك
                    current_balance_after=current_balance,
                    notes=f"{notes} - تحديث قراءة العداد: {old_reading:,.0f} → {new_reading:,.0f}",
                    created_by=user_id
                )
                
                if not history_result['success']:
                    cursor.execute("ROLLBACK")
                    return history_result
                
                return {
                    'success': True,
                    'customer_id': customer_id,
                    'old_reading': old_reading,
                    'new_reading': new_reading,
                    'consumption': new_reading - old_reading,
                    'current_balance': current_balance,
                    'transaction_id': history_result.get('transaction_id'),
                    'message': f'تم تحديث قراءة العداد: {old_reading:,.0f} → {new_reading:,.0f}'
                }
                
        except Exception as e:
            logger.error(f"خطأ في تحديث قراءة العداد: {e}")
            return {'success': False, 'error': str(e)}
    
    def get_customer_history(self, 
                           customer_id: int,
                           limit: int = 100,
                           offset: int = 0) -> Dict:
        """جلب السجل التاريخي للزبون"""
        
        try:
            with db.get_cursor() as cursor:
                # 1. جلب إجمالي عدد السجلات
                cursor.execute('''
                    SELECT COUNT(*) as total_count
                    FROM customer_history
                    WHERE customer_id = %s
                ''', (customer_id,))
                
                total = cursor.fetchone()['total_count']
                
                # 2. جلب السجلات
                cursor.execute('''
                    SELECT 
                        h.id,
                        h.transaction_type,
                        h.old_value,
                        h.new_value,
                        h.amount,
                        h.current_balance_after,
                        h.notes,
                        h.created_at,
                        u.full_name as created_by_name
                    FROM customer_history h
                    LEFT JOIN users u ON h.created_by = u.id
                    WHERE h.customer_id = %s
                    ORDER BY h.created_at DESC
                    LIMIT %s OFFSET %s
                ''', (customer_id, limit, offset))
                
                history = cursor.fetchall()
                
                # 3. تحويل الأرقام وتنسيق البيانات
                formatted_history = []
                for record in history:
                    formatted_record = dict(record)
                    
                    # تحويل القيم الرقمية بشكل آمن
                    formatted_record['old_value'] = self._safe_format_number(formatted_record['old_value'])
                    formatted_record['new_value'] = self._safe_format_number(formatted_record['new_value'])
                    formatted_record['amount'] = self._safe_format_number(formatted_record['amount'])
                    formatted_record['current_balance_after'] = self._safe_format_number(formatted_record['current_balance_after'])
                    
                    # تنسيق نوع العملية
                    transaction_type = formatted_record['transaction_type']
                    formatted_record['transaction_type_arabic'] = \
                        self.TRANSACTION_TYPES.get(transaction_type, transaction_type)
                    
                    # تنسيق التواريخ
                    if formatted_record['created_at']:
                        formatted_record['created_at_formatted'] = \
                            formatted_record['created_at'].strftime('%Y-%m-%d %H:%M')
                    else:
                        formatted_record['created_at_formatted'] = ''
                    
                    formatted_history.append(formatted_record)
                
                return {
                    'success': True,
                    'customer_id': customer_id,
                    'history': formatted_history,
                    'total_count': total,
                    'limit': limit,
                    'offset': offset
                }
                
        except Exception as e:
            logger.error(f"خطأ في جلب السجل التاريخي: {e}")
            return {'success': False, 'error': str(e)}
        
    def get_history_summary(self, customer_id: int) -> Dict:
        """جلب ملخص السجل التاريخي للزبون"""
        
        try:
            with db.get_cursor() as cursor:
                cursor.execute('''
                    SELECT 
                        COUNT(*) as total_transactions,
                        COALESCE(SUM(CASE WHEN transaction_type = 'weekly_visa' THEN amount ELSE 0 END), 0) as total_visa,
                        COALESCE(SUM(CASE WHEN transaction_type = 'cash_withdrawal' THEN amount ELSE 0 END), 0) as total_withdrawal,
                        MIN(created_at) as first_transaction,
                        MAX(created_at) as last_transaction
                    FROM customer_history
                    WHERE customer_id = %s
                ''', (customer_id,))
                
                result = cursor.fetchone()
                
                if result:
                    summary = dict(result)
                    
                    # استخدام _safe_format_number للقيم الرقمية
                    summary['total_visa'] = self._safe_format_number(summary.get('total_visa', 0))
                    summary['total_withdrawal'] = self._safe_format_number(summary.get('total_withdrawal', 0))
                    
                    # تنسيق التواريخ إذا كانت موجودة
                    if summary.get('first_transaction'):
                        summary['first_transaction'] = summary['first_transaction'].strftime('%Y-%m-%d %H:%M')
                    else:
                        summary['first_transaction'] = 'غير متوفر'
                        
                    if summary.get('last_transaction'):
                        summary['last_transaction'] = summary['last_transaction'].strftime('%Y-%m-%d %H:%M')
                    else:
                        summary['last_transaction'] = 'غير متوفر'
                    
                    return {
                        'success': True,
                        'customer_id': customer_id,
                        'summary': summary
                    }
                else:
                    return {
                        'success': True,
                        'customer_id': customer_id,
                        'summary': {
                            'total_transactions': 0,
                            'total_visa': 0,
                            'total_withdrawal': 0,
                            'first_transaction': 'غير متوفر',
                            'last_transaction': 'غير متوفر'
                        }
                    }
                    
        except Exception as e:
            logger.error(f"خطأ في جلب ملخص السجل: {e}")
            return {'success': False, 'error': str(e)}


-- setup_database_fixed.sql
-- إنشاء قاعدة البيانات باستخدام template0 (محايد اللغات)

-- 1. إنشاء قاعدة البيانات
CREATE DATABASE electricity_billing
WITH
OWNER = postgres
ENCODING = 'UTF8'
LC_COLLATE = 'C'        -- استخدام إعداد محايد
LC_CTYPE = 'C'          -- استخدام إعداد محايد
TEMPLATE = template0     -- مهم: استخدام القالب المحايد
CONNECTION LIMIT = -1;

-- 2. إنشاء المستخدم
CREATE USER billing_user WITH PASSWORD 'SecurePassword123!';

-- 3. الاتصال بقاعدة البيانات الجديدة
\c electricity_billing

-- 4. منح الصلاحيات
GRANT ALL PRIVILEGES ON DATABASE electricity_billing TO billing_user;
GRANT ALL ON SCHEMA public TO billing_user;

-- 5. إنشاء امتدادات
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 6. التعليق
COMMENT ON DATABASE electricity_billing IS 'قاعدة بيانات نظام إدارة فواتير مولدة الريان';

مجلد ui يحوي الملفات التالية
__init__.py ملف فارغ تماما
ملف activity_log_ui.py له الكود التالي
# ui/activity_log_ui.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class ActivityLogUI:
    def __init__(self, parent_frame):
        self.parent = parent_frame
        self.create_widgets()
    
    def create_widgets(self):
        """إنشاء واجهة سجل النشاط"""
        for widget in self.parent.winfo_children():
            widget.destroy()
        
        frame = ttk.Frame(self.parent)
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = ttk.Label(frame, text="سجل النشاط", font=("Arial", 20, "bold"))
        title.pack(pady=10)
        
        # شريط البحث
        search_frame = ttk.Frame(frame)
        search_frame.pack(fill='x', pady=10)
        
        ttk.Label(search_frame, text="بحث:").pack(side='left', padx=5)
        self.search_entry = ttk.Entry(search_frame, width=40)
        self.search_entry.pack(side='left', padx=5)
        ttk.Button(search_frame, text="بحث", command=self.search_logs).pack(side='left', padx=5)
        
        # جدول سجل النشاط
        columns = ('id', 'user', 'action', 'timestamp', 'details')
        self.tree = ttk.Treeview(frame, columns=columns, show='headings', height=15)
        
        # تعريف العناوين
        self.tree.heading('id', text='#')
        self.tree.heading('user', text='المستخدم')
        self.tree.heading('action', text='الإجراء')
        self.tree.heading('timestamp', text='التاريخ والوقت')
        self.tree.heading('details', text='التفاصيل')
        
        self.tree.pack(fill='both', expand=True, pady=10)
        
        # تحميل بيانات تجريبية
        self.load_sample_data()
    
    def load_sample_data(self):
        """تحميل بيانات تجريبية"""
        sample_data = [
            (1, 'admin', 'تسجيل دخول', '2024-01-10 13:13:53', 'تم تسجيل الدخول إلى النظام'),
            (2, 'admin', 'فتح الزبائن', '2024-01-10 13:15:23', 'عرض قائمة الزبائن'),
            (3, 'admin', 'فتح الفواتير', '2024-01-10 13:15:49', 'عرض قائمة الفواتير'),
        ]
        
        for data in sample_data:
            self.tree.insert('', 'end', values=data)
    
    def search_logs(self):
        """بحث في سجلات النشاط"""
        search_term = self.search_entry.get()
        messagebox.showinfo("بحث", f"سيتم البحث عن: {search_term}")
archive_ui.py  له الكود التالي
# ui/archive_ui.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class ArchiveUI:
    def __init__(self, parent_frame):
        self.parent = parent_frame
        self.create_widgets()
    
    def create_widgets(self):
        """إنشاء واجهة الأرشيف"""
        # مسح المحتوى القديم
        for widget in self.parent.winfo_children():
            widget.destroy()
        
        frame = ttk.Frame(self.parent)
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = ttk.Label(frame, text="الأرشيف - الفواتير المؤرشفة", font=("Arial", 20, "bold"))
        title.pack(pady=10)
        
        # شريط البحث
        search_frame = ttk.Frame(frame)
        search_frame.pack(fill='x', pady=10)
        
        ttk.Label(search_frame, text="بحث:").pack(side='left', padx=5)
        self.search_entry = ttk.Entry(search_frame, width=40)
        self.search_entry.pack(side='left', padx=5)
        ttk.Button(search_frame, text="بحث", command=self.search_archive).pack(side='left', padx=5)
        ttk.Button(search_frame, text="عرض الكل", command=self.load_all).pack(side='left', padx=5)
        
        # جدول الأرشيف
        columns = ('id', 'customer_name', 'invoice_number', 'amount', 'date', 'status')
        self.tree = ttk.Treeview(frame, columns=columns, show='headings', height=15)
        
        # تعريف العناوين
        self.tree.heading('id', text='المعرف')
        self.tree.heading('customer_name', text='اسم الزبون')
        self.tree.heading('invoice_number', text='رقم الفاتورة')
        self.tree.heading('amount', text='المبلغ')
        self.tree.heading('date', text='التاريخ')
        self.tree.heading('status', text='الحالة')
        
        self.tree.pack(fill='both', expand=True, pady=10)
        
        # أزرار التحكم
        btn_frame = ttk.Frame(frame)
        btn_frame.pack(pady=10)
        
        ttk.Button(btn_frame, text="عرض التفاصيل", command=self.view_details).pack(side='left', padx=5)
        ttk.Button(btn_frame, text="استعادة", command=self.restore_item).pack(side='left', padx=5)
        ttk.Button(btn_frame, text="تصدير إلى Excel", command=self.export_to_excel).pack(side='left', padx=5)
        ttk.Button(btn_frame, text="طباعة", command=self.print_report).pack(side='left', padx=5)
    
    def search_archive(self):
        """بحث في الأرشيف"""
        search_term = self.search_entry.get()
        logger.info(f"بحث في الأرشيف عن: {search_term}")
        messagebox.showinfo("بحث", f"سيتم البحث عن: {search_term}")
    
    def load_all(self):
        """تحميل جميع العناصر"""
        logger.info("تحميل كافة العناصر المؤرشفة")
        # هنا سيتم جلب البيانات من قاعدة البيانات
    
    def view_details(self):
        """عرض تفاصيل العنصر المحدد"""
        selected = self.tree.selection()
        if not selected:
            messagebox.showwarning("تحذير", "يرجى اختيار عنصر من القائمة")
            return
        logger.info("عرض تفاصيل العنصر المحدد")
    
    def restore_item(self):
        """استعادة العنصر المحدد"""
        selected = self.tree.selection()
        if not selected:
            messagebox.showwarning("تحذير", "يرجى اختيار عنصر من القائمة")
            return
        logger.info("استعادة العنصر المحدد")
    
    def export_to_excel(self):
        """تصدير إلى Excel"""
        logger.info("تصدير الأرشيف إلى Excel")
        messagebox.showinfo("تصدير", "سيتم تصدير البيانات إلى ملف Excel")
    
    def print_report(self):
        """طباعة تقرير الأرشيف"""
        logger.info("طباعة تقرير الأرشيف")
customer_details.py له الكود التالي
# ui/customer_details.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class CustomerDetails:
    """عرض تفاصيل الزبون"""
    
    def __init__(self, parent, customer_data):
        self.parent = parent
        self.customer_data = customer_data
        
        self.create_dialog()
        self.create_widgets()
        
        self.dialog.grab_set()
    
    def create_dialog(self):
        """إنشاء النافذة المنبثقة"""
        self.dialog = tk.Toplevel(self.parent)
        self.dialog.title(f"تفاصيل الزبون - {self.customer_data['name']}")
        self.dialog.geometry("700x600")
        self.dialog.resizable(True, True)
        self.dialog.configure(bg='#f5f7fa')
        
        # مركزية النافذة
        self.dialog.update_idletasks()
        width = self.dialog.winfo_width()
        height = self.dialog.winfo_height()
        x = (self.dialog.winfo_screenwidth() // 2) - (width // 2)
        y = (self.dialog.winfo_screenheight() // 2) - (height // 2)
        self.dialog.geometry(f'700x600+{x}+{y}')
    
    def create_widgets(self):
        """إنشاء عناصر العرض"""
        # إطار العنوان
        title_frame = tk.Frame(self.dialog, bg='#9b59b6', height=80)
        title_frame.pack(fill='x')
        title_frame.pack_propagate(False)
        
        title_label = tk.Label(title_frame, 
                              text=f"تفاصيل الزبون: {self.customer_data['name']}",
                              font=('Arial', 18, 'bold'),
                              bg='#9b59b6', fg='white')
        title_label.pack(expand=True)
        
        # دفتر الملاحظات للتبويب
        notebook = ttk.Notebook(self.dialog)
        notebook.pack(fill='both', expand=True, padx=10, pady=10)
        
        # معلومات أساسية
        basic_tab = ttk.Frame(notebook)
        self.create_basic_info_tab(basic_tab)
        notebook.add(basic_tab, text='معلومات أساسية')
        
        # معلومات مالية
        financial_tab = ttk.Frame(notebook)
        self.create_financial_info_tab(financial_tab)
        notebook.add(financial_tab, text='معلومات مالية')
        
        # معلومات العداد
        counter_tab = ttk.Frame(notebook)
        self.create_counter_info_tab(counter_tab)
        notebook.add(counter_tab, text='معلومات العداد')
        
        # أزرار التحكم
        self.create_buttons()
    
    def create_basic_info_tab(self, parent):
        """إنشاء تبويب المعلومات الأساسية"""
        # إطار مع تمرير
        canvas = tk.Canvas(parent, bg='white', highlightthickness=0)
        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=canvas.yview)
        content_frame = tk.Frame(canvas, bg='white')
        
        canvas.create_window((0, 0), window=content_frame, anchor='nw')
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # تحديث منطقة التمرير
        content_frame.bind('<Configure>', lambda e: canvas.configure(scrollregion=canvas.bbox('all')))
        
        # تعريف المعلومات الأساسية
        basic_info = [
            ('اسم الزبون', self.customer_data.get('name', '')),
            ('القطاع', self.customer_data.get('sector_name', 'غير محدد')),
            ('رقم العلبة', self.customer_data.get('box_number', '')),
            ('المسلسل', self.customer_data.get('serial_number', '')),
            ('رقم الهاتف', self.customer_data.get('phone_number', '')),
            ('حساب التيليغرام', self.customer_data.get('telegram_username', '')),
            ('الحالة', 'نشط' if self.customer_data.get('is_active', True) else 'غير نشط'),
            ('تاريخ التسجيل', self.format_date(self.customer_data.get('created_at'))),
            ('آخر تحديث', self.format_date(self.customer_data.get('updated_at')))
        ]
        
        # عرض المعلومات
        for i, (label, value) in enumerate(basic_info):
            # إطار السطر
            row_frame = tk.Frame(content_frame, bg='white')
            row_frame.pack(fill='x', padx=20, pady=10)
            
            # التسمية
            lbl = tk.Label(row_frame, text=label + ":",
                          font=('Arial', 11, 'bold'),
                          bg='white', fg='#2c3e50',
                          width=20, anchor='e')
            lbl.pack(side='left', padx=5)
            
            # القيمة
            val = tk.Label(row_frame, text=value or '---',
                          font=('Arial', 11),
                          bg='#f8f9fa', fg='#495057',
                          relief='ridge', anchor='w',
                          padx=10, pady=5)
            val.pack(side='left', fill='x', expand=True, padx=5)
        
        # الملاحظات
        notes_frame = tk.Frame(content_frame, bg='white')
        notes_frame.pack(fill='x', padx=20, pady=20)
        
        notes_label = tk.Label(notes_frame, text="ملاحظات:",
                              font=('Arial', 11, 'bold'),
                              bg='white', fg='#2c3e50')
        notes_label.pack(anchor='w', pady=(0, 5))
        
        notes_text = tk.Text(notes_frame, height=6,
                            font=('Arial', 11),
                            bg='#f8f9fa', fg='#495057',
                            wrap='word', state='disabled')
        notes_text.pack(fill='x', padx=5)
        
        notes = self.customer_data.get('notes', '')
        notes_text.config(state='normal')
        notes_text.insert('1.0', notes or 'لا توجد ملاحظات')
        notes_text.config(state='disabled')
        
        # تعبئة وإظهار
        canvas.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def create_financial_info_tab(self, parent):
        """إنشاء تبويب المعلومات المالية"""
        canvas = tk.Canvas(parent, bg='white', highlightthickness=0)
        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=canvas.yview)
        content_frame = tk.Frame(canvas, bg='white')
        
        canvas.create_window((0, 0), window=content_frame, anchor='nw')
        canvas.configure(yscrollcommand=scrollbar.set)
        
        content_frame.bind('<Configure>', lambda e: canvas.configure(scrollregion=canvas.bbox('all')))
        
        # المعلومات المالية
        balance = self.customer_data.get('current_balance', 0)
        balance_color = '#e74c3c' if balance < 0 else '#27ae60' if balance > 0 else '#7f8c8d'
        balance_status = 'سالب' if balance < 0 else 'موجب' if balance > 0 else 'صفر'
        
        financial_info = [
            ('الرصيد الحالي', f"{balance:,.0f} كيلو واط", balance_color),
            ('حالة الرصيد', balance_status, balance_color),
            ('رصيد التأشيرة', f"{self.customer_data.get('visa_balance', 0):,.0f}", '#3498db'),
            ('سحب المشترك', f"{self.customer_data.get('withdrawal_amount', 0):,.0f}", '#9b59b6')
        ]
        
        # عرض المعلومات
        for i, (label, value, color) in enumerate(financial_info):
            row_frame = tk.Frame(content_frame, bg='white')
            row_frame.pack(fill='x', padx=20, pady=15)
            
            lbl = tk.Label(row_frame, text=label + ":",
                          font=('Arial', 12, 'bold'),
                          bg='white', fg='#2c3e50',
                          width=20, anchor='e')
            lbl.pack(side='left', padx=5)
            
            val = tk.Label(row_frame, text=value,
                          font=('Arial', 12, 'bold'),
                          bg='#f8f9fa', fg=color,
                          relief='solid', anchor='center',
                          padx=20, pady=10)
            val.pack(side='left', fill='x', expand=True, padx=5)
        
        # رسالة إرشادية بناءً على الرصيد
        advice_frame = tk.Frame(content_frame, bg='white')
        advice_frame.pack(fill='x', padx=20, pady=30)
        
        if balance < 0:
            advice_text = "⚠️ هذا الزبون لديه رصيد سالب. يرجى متابعته للسداد."
            advice_color = '#e74c3c'
        elif balance > 100000:
            advice_text = "✓ رصيد ممتاز. يمكن منحه مزايا إضافية."
            advice_color = '#27ae60'
        else:
            advice_text = "✓ الرصيد ضمن المعدل الطبيعي."
            advice_color = '#3498db'
        
        advice_label = tk.Label(advice_frame, text=advice_text,
                               font=('Arial', 11, 'italic'),
                               bg='white', fg=advice_color,
                               wraplength=400)
        advice_label.pack()
        
        canvas.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def create_counter_info_tab(self, parent):
        """إنشاء تبويب معلومات العداد"""
        canvas = tk.Canvas(parent, bg='white', highlightthickness=0)
        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=canvas.yview)
        content_frame = tk.Frame(canvas, bg='white')
        
        canvas.create_window((0, 0), window=content_frame, anchor='nw')
        canvas.configure(yscrollcommand=scrollbar.set)
        
        content_frame.bind('<Configure>', lambda e: canvas.configure(scrollregion=canvas.bbox('all')))
        
        # معلومات العداد
        counter_info = [
            ('آخر قراءة عداد', f"{self.customer_data.get('last_counter_reading', 0):,.0f}"),
            ('متوسط الاستهلاك الشهري', 'تحت التطوير'),
            ('آخر فاتورة', 'تحت التطوير'),
            ('تاريخ آخر قراءة', 'تحت التطوير')
        ]
        
        for i, (label, value) in enumerate(counter_info):
            row_frame = tk.Frame(content_frame, bg='white')
            row_frame.pack(fill='x', padx=20, pady=15)
            
            lbl = tk.Label(row_frame, text=label + ":",
                          font=('Arial', 11, 'bold'),
                          bg='white', fg='#2c3e50',
                          width=25, anchor='e')
            lbl.pack(side='left', padx=5)
            
            val = tk.Label(row_frame, text=value,
                          font=('Arial', 11),
                          bg='#f8f9fa', fg='#495057',
                          relief='ridge', anchor='w',
                          padx=15, pady=8)
            val.pack(side='left', fill='x', expand=True, padx=5)
        
        # إحصائيات الفواتير (سيتم تطويرها لاحقاً)
        stats_frame = tk.Frame(content_frame, bg='white')
        stats_frame.pack(fill='x', padx=20, pady=30)
        
        stats_label = tk.Label(stats_frame, 
                              text="إحصائيات الفواتير قيد التطوير\nسيتم عرض تاريخ الفواتير واستهلاك الزبون",
                              font=('Arial', 11, 'italic'),
                              bg='white', fg='#7f8c8d',
                              wraplength=400)
        stats_label.pack()
        
        canvas.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def create_buttons(self):
        """إنشاء أزرار التحكم"""
        buttons_frame = tk.Frame(self.dialog, bg='#f5f7fa')
        buttons_frame.pack(fill='x', pady=10, padx=20)
        
        # زر الطباعة (سيتم تطويره لاحقاً)
        print_btn = tk.Button(buttons_frame, text="🖨️ طباعة التقرير",
                             bg='#3498db', fg='white',
                             font=('Arial', 11),
                             padx=20, pady=8, cursor='hand2')
        print_btn.pack(side='right', padx=5)
        
        # زر الإغلاق
        close_btn = tk.Button(buttons_frame, text="إغلاق",
                             command=self.dialog.destroy,
                             bg='#95a5a6', fg='white',
                             font=('Arial', 11),
                             padx=30, pady=8, cursor='hand2')
        close_btn.pack(side='left', padx=5)
    
    def format_date(self, date_value):
        """تنسيق التاريخ"""
        if not date_value:
            return 'غير محدد'
        
        try:
            if isinstance(date_value, str):
                return date_value
            
            if hasattr(date_value, 'strftime'):
                return date_value.strftime("%Y-%m-%d %H:%M")
        except:
            pass
        
        return str(date_value)

ملف customer_form.py له الكود التالي
# ui/customer_form.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging

logger = logging.getLogger(__name__)

class CustomerForm:
    """نموذج إضافة وتعديل الزبون"""
    
    def __init__(self, parent, title, sectors, customer_data=None):
        self.parent = parent
        self.title = title
        self.sectors = sectors
        self.customer_data = customer_data
        self.result = None
        
        self.create_dialog()
        self.create_widgets()
        self.load_customer_data()
        
        self.dialog.grab_set()
        self.dialog.wait_window()
    
    def create_dialog(self):
        """إنشاء النافذة المنبثقة"""
        self.dialog = tk.Toplevel(self.parent)
        self.dialog.title(self.title)
        self.dialog.geometry("500x650")
        self.dialog.resizable(False, False)
        self.dialog.configure(bg='#f5f7fa')
        
        # مركزية النافذة
        self.dialog.update_idletasks()
        width = self.dialog.winfo_width()
        height = self.dialog.winfo_height()
        x = (self.dialog.winfo_screenwidth() // 2) - (width // 2)
        y = (self.dialog.winfo_screenheight() // 2) - (height // 2)
        self.dialog.geometry(f'500x650+{x}+{y}')
        
        # ربط زر الإغلاق
        self.dialog.protocol("WM_DELETE_WINDOW", self.cancel)
    
    def create_widgets(self):
        """إنشاء عناصر النموذج"""
        # إطار العنوان
        title_frame = tk.Frame(self.dialog, bg='#3498db', height=70)
        title_frame.pack(fill='x')
        title_frame.pack_propagate(False)
        
        title_label = tk.Label(title_frame, text=self.title,
                              font=('Arial', 18, 'bold'),
                              bg='#3498db', fg='white')
        title_label.pack(expand=True)
        
        # إطار النموذج الرئيسي
        main_frame = tk.Frame(self.dialog, bg='#f5f7fa', padx=20, pady=20)
        main_frame.pack(fill='both', expand=True)
        
        # إنشاء الحقول
        self.create_fields(main_frame)
        
        # أزرار التحكم
        self.create_buttons(main_frame)
    
    def create_fields(self, parent):
        """إنشاء حقول الإدخال"""
        # إطار الحقول مع تمرير
        canvas = tk.Canvas(parent, bg='#f5f7fa', highlightthickness=0)
        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=canvas.yview)
        
        fields_frame = tk.Frame(canvas, bg='#f5f7fa')
        
        canvas.create_window((0, 0), window=fields_frame, anchor='nw')
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # تحديث منطقة التمرير
        fields_frame.bind('<Configure>', lambda e: canvas.configure(scrollregion=canvas.bbox('all')))
        
        # تعريف الحقول
        fields = [
            ('sector', 'القطاع *', 'combobox', {'values': [s['name'] for s in self.sectors]}),
            ('name', 'اسم الزبون *', 'entry', {}),
            ('box_number', 'رقم العلبة', 'entry', {}),
            ('serial_number', 'المسلسل', 'entry', {}),
            ('phone_number', 'رقم الهاتف', 'entry', {}),
            ('current_balance', 'الرصيد الحالي', 'entry', {'default': '0'}),
            ('last_counter_reading', 'آخر قراءة عداد', 'entry', {'default': '0'}),
            ('visa_balance', 'رصيد التأشيرة', 'entry', {'default': '0'}),
            ('withdrawal_amount', 'سحب المشترك', 'entry', {'default': '0'}),
            ('notes', 'ملاحظات', 'textarea', {'height': 4})
        ]
        
        self.field_vars = {}
        
        for i, (field_name, label, field_type, options) in enumerate(fields):
            # تسمية الحقل
            lbl = tk.Label(fields_frame, text=label,
                          font=('Arial', 11, 'bold'),
                          bg='#f5f7fa', fg='#2c3e50',
                          anchor='e')
            lbl.grid(row=i, column=0, sticky='e', padx=5, pady=8)
            
            # حقل الإدخال
            if field_type == 'entry':
                var = tk.StringVar(value=options.get('default', ''))
                entry = ttk.Entry(fields_frame, textvariable=var,
                                 font=('Arial', 11))
                entry.grid(row=i, column=1, sticky='ew', padx=5, pady=8)
                self.field_vars[field_name] = var
                
            elif field_type == 'combobox':
                var = tk.StringVar()
                combo = ttk.Combobox(fields_frame, textvariable=var,
                                    font=('Arial', 11), state='readonly')
                combo['values'] = options.get('values', [])
                combo.grid(row=i, column=1, sticky='ew', padx=5, pady=8)
                self.field_vars[field_name] = var
                
            elif field_type == 'textarea':
                text_frame = tk.Frame(fields_frame, bg='white', relief='sunken', borderwidth=1)
                text_frame.grid(row=i, column=1, sticky='nsew', padx=5, pady=8)
                
                text_widget = tk.Text(text_frame, height=options.get('height', 3),
                                     font=('Arial', 11), wrap='word',
                                     bg='white', fg='#2c3e50')
                text_widget.pack(fill='both', expand=True)
                
                scrollbar_text = ttk.Scrollbar(text_frame, orient='vertical',
                                              command=text_widget.yview)
                scrollbar_text.pack(side='right', fill='y')
                text_widget.configure(yscrollcommand=scrollbar_text.set)
                
                self.field_vars[field_name] = text_widget
        
        # جعل العمود الثاني قابلاً للتوسع
        fields_frame.columnconfigure(1, weight=1)
        
        # تعبئة وإظهار
        canvas.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def create_buttons(self, parent):
        """إنشاء أزرار التحكم"""
        buttons_frame = tk.Frame(parent, bg='#f5f7fa')
        buttons_frame.pack(fill='x', pady=20)
        
        # زر الحفظ
        save_btn = tk.Button(buttons_frame, text="💾 حفظ",
                           command=self.save,
                           bg='#27ae60', fg='white',
                           font=('Arial', 12, 'bold'),
                           padx=30, pady=10, cursor='hand2')
        save_btn.pack(side='right', padx=10)
        
        # زر الإلغاء
        cancel_btn = tk.Button(buttons_frame, text="❌ إلغاء",
                              command=self.cancel,
                              bg='#e74c3c', fg='white',
                              font=('Arial', 12),
                              padx=30, pady=10, cursor='hand2')
        cancel_btn.pack(side='left', padx=10)
    
    def load_customer_data(self):
        """تحميل بيانات الزبون في حالة التعديل"""
        if not self.customer_data:
            return
        
        # تعبئة الحقول ببيانات الزبون
        for field_name, widget in self.field_vars.items():
            value = self.customer_data.get(field_name, '')
            
            if isinstance(widget, tk.StringVar):
                widget.set(str(value))
            elif isinstance(widget, tk.Text):
                widget.delete('1.0', 'end')
                widget.insert('1.0', str(value))
    
    def validate(self):
        """التحقق من صحة البيانات"""
        # التحقق من الحقول المطلوبة
        if not self.field_vars['sector'].get():
            messagebox.showerror("خطأ", "الرجاء اختيار القطاع")
            return False
        
        if not self.field_vars['name'].get().strip():
            messagebox.showerror("خطأ", "اسم الزبون مطلوب")
            return False
        
        # التحقق من القيم الرقمية
        numeric_fields = ['current_balance', 'last_counter_reading', 
                         'visa_balance', 'withdrawal_amount']
        
        for field in numeric_fields:
            try:
                value = self.field_vars[field].get()
                if value:
                    float(value)
            except ValueError:
                messagebox.showerror("خطأ", f"القيمة في '{field}' يجب أن تكون رقمية")
                return False
        
        return True
    
    def save(self):
        """حفظ البيانات"""
        if not self.validate():
            return
        
        try:
            # الحصول على معرف القطاع
            sector_name = self.field_vars['sector'].get()
            sector_id = None
            
            for sector in self.sectors:
                if sector['name'] == sector_name:
                    sector_id = sector['id']
                    break
            
            if not sector_id:
                messagebox.showerror("خطأ", "القطاع المحدد غير صالح")
                return
            
            # تجميع البيانات
            self.result = {
                'sector_id': sector_id,
                'name': self.field_vars['name'].get().strip(),
                'box_number': self.field_vars['box_number'].get().strip(),
                'serial_number': self.field_vars['serial_number'].get().strip(),
                'phone_number': self.field_vars['phone_number'].get().strip(),
                'current_balance': float(self.field_vars['current_balance'].get() or 0),
                'last_counter_reading': float(self.field_vars['last_counter_reading'].get() or 0),
                'visa_balance': float(self.field_vars['visa_balance'].get() or 0),
                'withdrawal_amount': float(self.field_vars['withdrawal_amount'].get() or 0),
                'notes': self.field_vars['notes'].get('1.0', 'end-1c').strip()
            }
            
            self.dialog.destroy()
            
        except Exception as e:
            logger.error(f"خطأ في حفظ البيانات: {e}")
            messagebox.showerror("خطأ", f"فشل حفظ البيانات: {str(e)}")
    
    def cancel(self):
        """إلغاء العملية"""
        self.result = None
        self.dialog.destroy()
ملف customer_ui.py له الكود التالي
# ui/customer_ui.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime
from typing import List, Dict, Optional

logger = logging.getLogger(__name__)

class CustomerUI(tk.Frame):
    """واجهة إدارة الزبائن الكاملة"""
    
    def __init__(self, parent, user_data):
        super().__init__(parent)
        self.user_data = user_data
        self.customer_manager = None
        self.sectors = []
        
        self.load_customer_manager()
        self.load_sectors()
        
        self.create_widgets()
        self.load_customers()
    
    def load_customer_manager(self):
        """تحميل مدير الزبائن"""
        try:
            from modules.customers import CustomerManager
            self.customer_manager = CustomerManager()
        except ImportError as e:
            logger.error(f"خطأ في تحميل مدير الزبائن: {e}")
            messagebox.showerror("خطأ", "لا يمكن تحميل وحدة الزبائن")
    
    def load_sectors(self):
        """تحميل قائمة القطاعات"""
        try:
            from database.connection import db
            with db.get_cursor() as cursor:
                cursor.execute("SELECT id, name FROM sectors WHERE is_active = TRUE ORDER BY name")
                self.sectors = cursor.fetchall()
        except Exception as e:
            logger.error(f"خطأ في تحميل القطاعات: {e}")
            self.sectors = []
    
    def create_widgets(self):
        """إنشاء عناصر الواجهة"""
        # شريط الأدوات العلوي
        self.create_toolbar()
        
        # شريط البحث والتصفية
        self.create_search_bar()
        
        # شجرة عرض الزبائن
        self.create_customer_tree()
        
        # شريط الحالة السفلي
        self.create_statusbar()
    
        # ui/customer_ui.py - إضافة زر جديد في create_toolbar
    def create_toolbar(self):
        """إنشاء شريط الأدوات العلوي"""
        toolbar = tk.Frame(self, bg='#2c3e50', height=60)
        toolbar.pack(fill='x', padx=0, pady=0)
        toolbar.pack_propagate(False)
        
        # عنوان الشريط
        title_label = tk.Label(toolbar, 
                            text="إدارة الزبائن",
                            font=('Arial', 16, 'bold'),
                            bg='#2c3e50', fg='white')
        title_label.pack(side='left', padx=20)
        
        # أزرار الأدوات
        buttons_frame = tk.Frame(toolbar, bg='#2c3e50')
        buttons_frame.pack(side='right', padx=20)
        
        # إذا كان المستخدم مديراً، أضف زر الحذف الكامل
        if self.user_data.get('role') == 'admin':
            buttons = [
                ("➕ إضافة زبون جديد", self.add_customer, "#27ae60"),
                ("✏️ تعديل المحدد", self.edit_customer, "#3498db"),
                ("🗑️ حذف المحدد", self.delete_customer, "#e74c3c"),
                ("🔄 تحديث القائمة", self.refresh_customers, "#95a5a6"),
                ("📋 عرض التفاصيل", self.show_customer_details, "#9b59b6"),
                ("📜 السجل التاريخي", self.show_customer_history, "#8e44ad"),
                ("🗑️🔥 حذف وإعادة الاستيراد", self.delete_and_reimport, "#e74c3c", 'bold')  # زر جديد
            ]
        else:
            buttons = [
                ("➕ إضافة زبون جديد", self.add_customer, "#27ae60"),
                ("✏️ تعديل المحدد", self.edit_customer, "#3498db"),
                ("🗑️ حذف المحدد", self.delete_customer, "#e74c3c"),
                ("🔄 تحديث القائمة", self.refresh_customers, "#95a5a6"),
                ("📋 عرض التفاصيل", self.show_customer_details, "#9b59b6")
            ]
        
        for button_info in buttons:
            if len(button_info) == 4:  # زر مع تنسيق خاص
                text, command, color, font_weight = button_info
            else:
                text, command, color = button_info
                font_weight = 'normal'
            
            btn = tk.Button(buttons_frame, text=text, command=command,
                        bg=color, fg='white',
                        font=('Arial', 10, font_weight),
                        padx=12, pady=6, cursor='hand2')
            btn.pack(side='left', padx=5)
        
        # إذا كان المستخدم مديراً، أضف زر حذف القطاع
        if self.user_data.get('role') == 'admin':
            tk.Button(buttons_frame, text="🗑️ حذف قطاع",
                    command=self.delete_sector_customers,
                    bg='#c0392b', fg='white',
                    font=('Arial', 10),
                    padx=12, pady=6, cursor='hand2').pack(side='left', padx=5)

    # إضافة دوال جديدة في customer_ui.py
    def delete_and_reimport(self):
        """حذف جميع الزبائن وإعادة الاستيراد من Excel"""
        if not self.check_admin_permission():
            return
        
        # تحذير شديد
        warning_msg = """
        ⚠️  تحذير شديد - هذا الإجراء خطير!
        
        سيؤدي هذا إلى:
        1. حذف جميع الزبائن من قاعدة البيانات
        2. حذف جميع الفواتير المرتبطة بهم
        3. فقدان جميع البيانات التاريخية
        
        هل أنت متأكد تماماً من رغبتك في المتابعة؟
        """
        
        confirm = messagebox.askyesno("تحذير شديد", warning_msg)
        if not confirm:
            return
        
        # تأكيد إضافي
        double_check = messagebox.askyesno("تأكيد نهائي", 
                                        "⚠️ تأكيد نهائي: هل أنت متأكد 100%؟\n"
                                        "هذا الإجراء لا يمكن التراجع عنه!")
        if not double_check:
            return
        
        try:
            # 1. عرض نافذة اختيار مجلد Excel
            from tkinter import filedialog
            excel_folder = filedialog.askdirectory(
                title="اختر مجلد ملفات Excel"
            )
            
            if not excel_folder:
                return
            
            # 2. التحقق من وجود ملفات Excel
            import os
            excel_files = [f for f in os.listdir(excel_folder) if f.endswith('.xlsx')]
            if not excel_files:
                messagebox.showerror("خطأ", "لا توجد ملفات Excel في المجلد المحدد")
                return
            
            # 3. عرض الملفات التي سيتم استيرادها
            files_msg = f"سيتم استيراد {len(excel_files)} ملف:\n\n"
            for file in excel_files:
                files_msg += f"• {file}\n"
            
            if not messagebox.askyesno("تأكيد الملفات", files_msg + "\nهل تريد المتابعة؟"):
                return
            
            # 4. حذف جميع الزبائن
            delete_result = self.customer_manager.delete_all_customers()
            
            if not delete_result.get('success'):
                messagebox.showerror("خطأ", f"فشل حذف الزبائن: {delete_result.get('error')}")
                return
            
            # 5. استيراد البيانات الجديدة
            from database.migrations import ExcelMigration
            
            # شريط تقدم
            progress_window = tk.Toplevel(self)
            progress_window.title("جاري الاستيراد...")
            progress_window.geometry("400x150")
            progress_window.resizable(False, False)
            
            progress_label = tk.Label(progress_window, 
                                    text="جاري استيراد البيانات من Excel...",
                                    font=('Arial', 12))
            progress_label.pack(pady=20)
            
            progress_bar = ttk.Progressbar(progress_window, 
                                        mode='indeterminate',
                                        length=300)
            progress_bar.pack(pady=10)
            progress_bar.start()
            
            status_label = tk.Label(progress_window, 
                                text="يرجى الانتظار...",
                                font=('Arial', 10))
            status_label.pack()
            
            progress_window.update()
            
            # تنفيذ الاستيراد
            migrator = ExcelMigration(excel_folder)
            success = migrator.migrate_all_data()
            
            progress_bar.stop()
            progress_window.destroy()
            
            if success:
                # 6. تحديث القائمة
                self.refresh_customers()
                
                # 7. عرض تقرير النتائج
                report = f"""
                ✅ تمت العملية بنجاح!
                
                نتائج العملية:
                • تم حذف {delete_result.get('deleted_count', 0)} زبون
                • تم استيراد {len(excel_files)} ملف Excel
                
                يمكنك الآن:
                1. مراجعة البيانات المستوردة
                2. التحقق من دقة المعلومات
                3. بدء استخدام النظام
                """
                
                messagebox.showinfo("تمت العملية", report)
                logger.info(f"تم حذف وإعادة استيراد {delete_result.get('deleted_count', 0)} زبون")
                
            else:
                messagebox.showerror("خطأ", "فشل استيراد البيانات من Excel")
                
        except Exception as e:
            logger.error(f"خطأ في حذف وإعادة الاستيراد: {e}")
            messagebox.showerror("خطأ", f"فشل العملية: {str(e)}")

    def delete_sector_customers(self):
        """حذف زبائن قطاع معين"""
        if not self.check_admin_permission():
            return
        
        # نافذة اختيار القطاع
        sector_dialog = tk.Toplevel(self)
        sector_dialog.title("حذف زبائن قطاع")
        sector_dialog.geometry("400x200")
        sector_dialog.resizable(False, False)
        
        tk.Label(sector_dialog, 
                text="اختر القطاع لحذف زبائنه:",
                font=('Arial', 12, 'bold')).pack(pady=10)
        
        sector_var = tk.StringVar()
        sector_combo = ttk.Combobox(sector_dialog, 
                                textvariable=sector_var,
                                values=[s['name'] for s in self.sectors],
                                state='readonly',
                                font=('Arial', 11),
                                width=30)
        sector_combo.pack(pady=10)
        
        # زر التأكيد
        def confirm_delete():
            sector_name = sector_var.get()
            if not sector_name:
                messagebox.showwarning("تحذير", "يرجى اختيار قطاع")
                return
            
            # تحذير
            warning = f"""
            ⚠️ تحذير!
            
            سيتم حذف جميع زبائن قطاع: {sector_name}
            هل أنت متأكد؟
            """
            
            if messagebox.askyesno("تحذير", warning):
                # البحث عن معرف القطاع
                sector_id = None
                for sector in self.sectors:
                    if sector['name'] == sector_name:
                        sector_id = sector['id']
                        break
                
                if sector_id:
                    result = self.customer_manager.delete_customers_by_sector(sector_id)
                    if result.get('success'):
                        messagebox.showinfo("نجاح", result['message'])
                        self.refresh_customers()
                        sector_dialog.destroy()
                    else:
                        messagebox.showerror("خطأ", result.get('error', 'فشل الحذف'))
        
        btn_frame = tk.Frame(sector_dialog)
        btn_frame.pack(pady=20)
        
        tk.Button(btn_frame, text="حذف", command=confirm_delete,
                bg='#e74c3c', fg='white',
                font=('Arial', 11)).pack(side='left', padx=10)
        
        tk.Button(btn_frame, text="إلغاء", 
                command=sector_dialog.destroy,
                bg='#95a5a6', fg='white',
                font=('Arial', 11)).pack(side='left', padx=10)

    def check_admin_permission(self):
        """التحقق من صلاحيات المدير"""
        if self.user_data.get('role') != 'admin':
            messagebox.showerror("صلاحيات", 
                            "هذا الإجراء متاح فقط للمديرين")
            return False
        return True

        
    def create_search_bar(self):
        """إنشاء شريط البحث والتصفية"""
        search_frame = tk.Frame(self, bg='#f1f8ff', relief='groove', borderwidth=2)
        search_frame.pack(fill='x', padx=10, pady=10)
        
        # البحث بالاسم
        tk.Label(search_frame, text="🔍 البحث:", 
                font=('Arial', 11, 'bold'), 
                bg='#f1f8ff').pack(side='left', padx=10)
        
        self.search_var = tk.StringVar()
        search_entry = ttk.Entry(search_frame, textvariable=self.search_var,
                                font=('Arial', 11), width=30)
        search_entry.pack(side='left', padx=5)
        search_entry.bind('<KeyRelease>', self.on_search_changed)
        
        # تصفية بالقطاع
        tk.Label(search_frame, text="القطاع:", 
                font=('Arial', 11, 'bold'), 
                bg='#f1f8ff').pack(side='left', padx=(20,5))
        
        self.sector_var = tk.StringVar()
        self.sector_combo = ttk.Combobox(search_frame, textvariable=self.sector_var,
                                        width=15, state='readonly', font=('Arial', 11))
        self.sector_combo['values'] = ['الكل'] + [s['name'] for s in self.sectors]
        self.sector_combo.set('الكل')
        self.sector_combo.pack(side='left', padx=5)
        self.sector_combo.bind('<<ComboboxSelected>>', self.on_filter_changed)
        
        # تصفية بالرصيد
        tk.Label(search_frame, text="حالة الرصيد:", 
                font=('Arial', 11, 'bold'), 
                bg='#f1f8ff').pack(side='left', padx=(20,5))
        
        self.balance_var = tk.StringVar()
        balance_combo = ttk.Combobox(search_frame, textvariable=self.balance_var,
                                    width=12, state='readonly', font=('Arial', 11))
        balance_combo['values'] = ['الكل', 'سالب فقط', 'موجب فقط', 'صفر فقط']
        balance_combo.set('الكل')
        balance_combo.pack(side='left', padx=5)
        balance_combo.bind('<<ComboboxSelected>>', self.on_filter_changed)
        
        # زر بحث متقدم
        adv_search_btn = tk.Button(search_frame, text="بحث متقدم",
                                  bg='#7f8c8d', fg='white',
                                  font=('Arial', 10),
                                  padx=15, pady=4)
        adv_search_btn.pack(side='right', padx=10)
    
    def create_customer_tree(self):
        """إنشاء شجرة عرض الزبائن"""
        # إطار يحتوي على الشجرة وشريط التمرير
        tree_frame = tk.Frame(self)
        tree_frame.pack(fill='both', expand=True, padx=10, pady=5)
        
        # شريط تمرير عمودي
        v_scrollbar = ttk.Scrollbar(tree_frame, orient='vertical')
        v_scrollbar.pack(side='right', fill='y')
        
        # شريط تمرير أفقي
        h_scrollbar = ttk.Scrollbar(tree_frame, orient='horizontal')
        h_scrollbar.pack(side='bottom', fill='x')
        
        # إنشاء الشجرة
        columns = ('id', 'name', 'sector', 'box', 'serial', 'balance', 'phone', 'visa', 'status')
        
        self.tree = ttk.Treeview(tree_frame, columns=columns,
                                yscrollcommand=v_scrollbar.set,
                                xscrollcommand=h_scrollbar.set,
                                selectmode='browse',
                                show='headings',
                                height=20)
        
        v_scrollbar.config(command=self.tree.yview)
        h_scrollbar.config(command=self.tree.xview)
        
        # تعريف رؤوس الأعمدة
        columns_config = [
            ('id', 'ID', 50, 'center'),
            ('name', 'اسم الزبون', 200, 'w'),
            ('sector', 'القطاع', 120, 'center'),
            ('box', 'رقم العلبة', 90, 'center'),
            ('serial', 'المسلسل', 90, 'center'),
            ('balance', 'الرصيد الحالي', 120, 'center'),
            ('phone', 'رقم الهاتف', 120, 'center'),
            ('visa', 'رصيد التأشيرة', 120, 'center'),
            ('status', 'الحالة', 80, 'center')
        ]
        
        for col_id, heading, width, anchor in columns_config:
            self.tree.heading(col_id, text=heading)
            self.tree.column(col_id, width=width, anchor=anchor)
        
        self.tree.pack(fill='both', expand=True)
        
        # إضافة تنسيقات للألوان
        self.tree.tag_configure('negative', foreground='#e74c3c')
        self.tree.tag_configure('positive', foreground='#27ae60')
        self.tree.tag_configure('zero', foreground='#7f8c8d')
        self.tree.tag_configure('inactive', foreground='#95a5a6')
        
        # ربط الأحداث
        self.tree.bind('<Double-Button-1>', self.on_double_click)
        self.tree.bind('<<TreeviewSelect>>', self.on_selection_changed)
    
    def create_statusbar(self):
        """إنشاء شريط الحالة السفلي"""
        self.statusbar = tk.Frame(self, bg='#34495e', height=30)
        self.statusbar.pack(fill='x', padx=10, pady=5)
        self.statusbar.pack_propagate(False)
        
        # معلومات الحالة
        self.status_label = tk.Label(self.statusbar,
                                    text="جاهز | عدد الزبائن: 0",
                                    bg='#34495e', fg='white',
                                    font=('Arial', 10))
        self.status_label.pack(side='left', padx=10)
        
        # معلومات الإحصائيات
        self.stats_label = tk.Label(self.statusbar,
                                   text="",
                                   bg='#34495e', fg='#bdc3c7',
                                   font=('Arial', 9))
        self.stats_label.pack(side='right', padx=10)
    
    def load_customers(self, search_term="", sector_id=None, balance_filter="الكل"):
        """تحميل قائمة الزبائن مع إمكانية البحث والتصفية"""
        if not self.customer_manager:
            self.show_error_message("مدير الزبائن غير متاح")
            return
        
        # مسح البيانات الحالية
        for item in self.tree.get_children():
            self.tree.delete(item)
        
        try:
            # جلب الزبائن من قاعدة البيانات
            customers = self.customer_manager.search_customers(
                search_term=search_term,
                sector_id=sector_id
            )
            
            # تطبيق فلتر الرصيد
            if balance_filter == "سالب فقط":
                customers = [c for c in customers if c.get('current_balance', 0) < 0]
            elif balance_filter == "موجب فقط":
                customers = [c for c in customers if c.get('current_balance', 0) > 0]
            elif balance_filter == "صفر فقط":
                customers = [c for c in customers if c.get('current_balance', 0) == 0]
            
            # إضافة الزبائن إلى الشجرة
            customer_count = 0
            balance_stats = {'negative': 0, 'positive': 0, 'zero': 0, 'total_balance': 0}
            
            for customer in customers:
                customer_id = customer['id']
                name = customer['name']
                sector = customer.get('sector_name', 'غير محدد')
                box = customer.get('box_number', '')
                serial = customer.get('serial_number', '')
                balance = customer.get('current_balance', 0)
                phone = customer.get('phone_number', '')
                visa = customer.get('visa_balance', 0)
                is_active = customer.get('is_active', True)
                
                # تحديد اللون بناءً على الرصيد
                tags = []
                if balance < 0:
                    tags.append('negative')
                    balance_stats['negative'] += 1
                elif balance > 0:
                    tags.append('positive')
                    balance_stats['positive'] += 1
                else:
                    tags.append('zero')
                    balance_stats['zero'] += 1
                
                if not is_active:
                    tags.append('inactive')
                
                balance_stats['total_balance'] += balance
                
                # إضافة الزبون للشجرة
                self.tree.insert("", "end", values=(
                    customer_id,
                    name,
                    sector,
                    box,
                    serial,
                    f"{balance:,.0f} كيلو واط",
                    phone,
                    f"{visa:,.0f}",
                    "نشط" if is_active else "غير نشط"
                ), tags=tuple(tags))
                
                customer_count += 1
            
            # تحديث شريط الحالة
            self.status_label.config(text=f"عدد الزبائن: {customer_count}")
            
            # تحديث الإحصائيات
            stats_text = (f"رصيد سالب: {balance_stats['negative']} | "
                         f"رصيد موجب: {balance_stats['positive']} | "
                         f"إجمالي الرصيد: {balance_stats['total_balance']:,.0f} كيلو واط")
            self.stats_label.config(text=stats_text)
            
        except Exception as e:
            logger.error(f"خطأ في تحميل الزبائن: {e}")
            self.show_error_message(f"خطأ في تحميل البيانات: {str(e)}")
    
    def on_search_changed(self, event=None):
        """عند تغيير نص البحث"""
        search_term = self.search_var.get().strip()
        sector_name = self.sector_var.get()
        balance_filter = self.balance_var.get()
        
        # تحويل اسم القطاع إلى ID
        sector_id = None
        if sector_name and sector_name != 'الكل':
            for sector in self.sectors:
                if sector['name'] == sector_name:
                    sector_id = sector['id']
                    break
        
        self.load_customers(search_term, sector_id, balance_filter)
    
    def on_filter_changed(self, event=None):
        """عند تغيير عوامل التصفية"""
        self.on_search_changed()
    
    def on_double_click(self, event):
        """عند النقر المزدوج على صف"""
        self.show_customer_details()
    
    def on_selection_changed(self, event):
        """عند تغيير العنصر المحدد"""
        selection = self.tree.selection()
        if selection:
            item = self.tree.item(selection[0])
            customer_name = item['values'][1]
            self.status_label.config(text=f"محدد: {customer_name}")
    
    def get_selected_customer_id(self):
        """الحصول على معرف الزبون المحدد"""
        selection = self.tree.selection()
        if not selection:
            return None
        
        item = self.tree.item(selection[0])
        return item['values'][0]  # العمود الأول هو ID
    
    def add_customer(self):
        """فتح نموذج إضافة زبون جديد"""
        from ui.customer_form import CustomerForm
        form = CustomerForm(self, "إضافة زبون جديد", self.sectors)
        
        if form.result:
            # حفظ الزبون الجديد في قاعدة البيانات
            try:
                result = self.customer_manager.add_customer(form.result)
                if result.get('success'):
                    messagebox.showinfo("نجاح", result['message'])
                    self.refresh_customers()
                else:
                    messagebox.showerror("خطأ", result.get('error', 'فشل إضافة الزبون'))
            except Exception as e:
                logger.error(f"خطأ في إضافة الزبون: {e}")
                messagebox.showerror("خطأ", f"فشل إضافة الزبون: {str(e)}")
    
    def edit_customer(self):
        """فتح نموذج تعديل الزبون المحدد"""
        customer_id = self.get_selected_customer_id()
        if not customer_id:
            messagebox.showwarning("تحذير", "يرجى تحديد زبون أولاً")
            return
        
        try:
            # جلب بيانات الزبون
            customer = self.customer_manager.get_customer(customer_id)
            if not customer:
                messagebox.showerror("خطأ", "الزبون غير موجود")
                return
            
            from ui.customer_form import CustomerForm
            form = CustomerForm(self, "تعديل بيانات الزبون", self.sectors, customer)
            
            if form.result:
                # تحديث بيانات الزبون
                result = self.customer_manager.update_customer(customer_id, form.result)
                if result.get('success'):
                    messagebox.showinfo("نجاح", result['message'])
                    self.refresh_customers()
                else:
                    messagebox.showerror("خطأ", result.get('error', 'فشل تحديث الزبون'))
                    
        except Exception as e:
            logger.error(f"خطأ في تعديل الزبون: {e}")
            messagebox.showerror("خطأ", f"فشل تعديل الزبون: {str(e)}")
    
    def delete_customer(self):
        """حذف الزبون المحدد"""
        customer_id = self.get_selected_customer_id()
        if not customer_id:
            messagebox.showwarning("تحذير", "يرجى تحديد زبون أولاً")
            return
        
        # تأكيد الحذف
        confirm = messagebox.askyesno(
            "تأكيد الحذف",
            "هل أنت متأكد من حذف هذا الزبون؟\n\n"
            "سيتم إلغاء تفعيل الزبون (حذف ناعم)."
        )
        
        if not confirm:
            return
        
        try:
            result = self.customer_manager.delete_customer(customer_id)
            if result.get('success'):
                messagebox.showinfo("نجاح", result['message'])
                self.refresh_customers()
            else:
                messagebox.showerror("خطأ", result.get('error', 'فشل حذف الزبون'))
                
        except Exception as e:
            logger.error(f"خطأ في حذف الزبون: {e}")
            messagebox.showerror("خطأ", f"فشل حذف الزبون: {str(e)}")
    
    def show_customer_details(self):
        """عرض تفاصيل الزبون المحدد"""
        customer_id = self.get_selected_customer_id()
        if not customer_id:
            messagebox.showwarning("تحذير", "يرجى تحديد زبون أولاً")
            return
        
        try:
            customer = self.customer_manager.get_customer(customer_id)
            if not customer:
                messagebox.showerror("خطأ", "الزبون غير موجود")
                return
            
            from ui.customer_details import CustomerDetails
            CustomerDetails(self, customer)
            
        except Exception as e:
            logger.error(f"خطأ في عرض التفاصيل: {e}")
            messagebox.showerror("خطأ", f"فشل عرض التفاصيل: {str(e)}")
    
    def refresh_customers(self):
        """تحديث قائمة الزبائن"""
        self.load_customers()
        self.status_label.config(text="تم تحديث القائمة")
    
    def show_error_message(self, message):
        """عرض رسالة خطأ"""
        messagebox.showerror("خطأ", message)
    # ثم أضف الدالة الجديدة:
    def show_customer_history(self):
        """عرض السجل التاريخي للزبون"""
        customer_id = self.get_selected_customer_id()
        if not customer_id:
            messagebox.showwarning("تحذير", "يرجى تحديد زبون أولاً")
            return
        
        try:
            # جلب بيانات الزبون
            customer = self.customer_manager.get_customer(customer_id)
            if not customer:
                messagebox.showerror("خطأ", "الزبون غير موجود")
                return
            
            from ui.customer_history_ui import CustomerHistoryUI
            CustomerHistoryUI(self, customer, self.user_data)
            
        except Exception as e:
            logger.error(f"خطأ في عرض السجل التاريخي: {e}")
            messagebox.showerror("خطأ", f"فشل عرض السجل: {str(e)}")


ملف invoice_form.py له الكود التالي
# ui/invoice_form.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class InvoiceForm:
    """نموذج إنشاء فاتورة جديدة"""
    
    def __init__(self, parent, title, sectors, customers, user_data):
        self.parent = parent
        self.title = title
        self.sectors = sectors
        self.customers = customers
        self.user_data = user_data
        self.result = None
        
        self.selected_customer = None
        self.calculation_result = None
        
        self.create_dialog()
        self.create_widgets()
        
        self.dialog.grab_set()
        self.dialog.wait_window()
    
    def create_dialog(self):
        """إنشاء النافذة المنبثقة"""
        self.dialog = tk.Toplevel(self.parent)
        self.dialog.title(self.title)
        self.dialog.geometry("800x700")
        self.dialog.resizable(True, True)
        self.dialog.configure(bg='#f5f7fa')
        
        # مركزية النافذة
        self.dialog.update_idletasks()
        width = self.dialog.winfo_width()
        height = self.dialog.winfo_height()
        x = (self.dialog.winfo_screenwidth() // 2) - (width // 2)
        y = (self.dialog.winfo_screenheight() // 2) - (height // 2)
        self.dialog.geometry(f'800x700+{x}+{y}')
        
        # ربط زر الإغلاق
        self.dialog.protocol("WM_DELETE_WINDOW", self.cancel)
    
    def create_widgets(self):
        """إنشاء عناصر النموذج"""
        # إطار العنوان
        title_frame = tk.Frame(self.dialog, bg='#2ecc71', height=80)
        title_frame.pack(fill='x')
        title_frame.pack_propagate(False)
        
        title_label = tk.Label(title_frame, text=self.title,
                              font=('Arial', 20, 'bold'),
                              bg='#2ecc71', fg='white')
        title_label.pack(expand=True)
        
        # إطار المحتوى الرئيسي
        main_frame = tk.Frame(self.dialog, bg='#f5f7fa')
        main_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # دفتر الملاحظات للتبويب
        notebook = ttk.Notebook(main_frame)
        notebook.pack(fill='both', expand=True)
        
        # تبويب اختيار الزبون
        customer_tab = ttk.Frame(notebook)
        self.create_customer_tab(customer_tab)
        notebook.add(customer_tab, text='اختيار الزبون')
        
        # تبويب بيانات الدفع
        payment_tab = ttk.Frame(notebook)
        self.create_payment_tab(payment_tab)
        notebook.add(payment_tab, text='بيانات الدفع')
        
        # تبويب المعاينة
        preview_tab = ttk.Frame(notebook)
        self.create_preview_tab(preview_tab)
        notebook.add(preview_tab, text='معاينة الحساب')
        
        # أزرار التحكم
        self.create_buttons(main_frame)
    
    def create_customer_tab(self, parent):
        """إنشاء تبويب اختيار الزبون"""
        # إطار البحث
        search_frame = tk.Frame(parent, bg='#f5f7fa', padx=20, pady=20)
        search_frame.pack(fill='x')
        
        tk.Label(search_frame, text="🔍 البحث عن الزبون:",
                font=('Arial', 12, 'bold'),
                bg='#f5f7fa').pack(anchor='w')
        
        self.customer_search_var = tk.StringVar()
        search_entry = ttk.Entry(search_frame, textvariable=self.customer_search_var,
                                font=('Arial', 12), width=40)
        search_entry.pack(fill='x', pady=10)
        search_entry.bind('<KeyRelease>', self.search_customers)
        
        # قائمة الزبائن
        list_frame = tk.Frame(parent, bg='white', relief='sunken', borderwidth=1)
        list_frame.pack(fill='both', expand=True, padx=20, pady=(0, 20))
        
        # شريط التمرير
        scrollbar = ttk.Scrollbar(list_frame)
        scrollbar.pack(side='right', fill='y')
        
        # قائمة
        self.customer_listbox = tk.Listbox(list_frame, 
                                          font=('Arial', 11),
                                          yscrollcommand=scrollbar.set,
                                          selectmode='single',
                                          height=10)
        self.customer_listbox.pack(fill='both', expand=True)
        self.customer_listbox.bind('<<ListboxSelect>>', self.on_customer_selected)
        
        scrollbar.config(command=self.customer_listbox.yview)
        
        # تعبئة القائمة الأولية
        self.populate_customer_list()
    
    def search_customers(self, event=None):
        """بحث الزبائن"""
        search_term = self.customer_search_var.get().lower()
        self.customer_listbox.delete(0, tk.END)
        
        for customer in self.customers:
            if (search_term in customer.get('name', '').lower() or 
                search_term in customer.get('box_number', '').lower() or
                search_term in str(customer.get('id', '')).lower()):
                
                display_text = f"{customer['id']} - {customer['name']} | علبة: {customer.get('box_number', '')} | رصيد: {customer.get('current_balance', 0):,.0f} كيلو واط"
                self.customer_listbox.insert(tk.END, display_text)
                self.customer_listbox.customer_data = getattr(self.customer_listbox, 'customer_data', []) + [customer]
    
    def populate_customer_list(self):
        """تعبئة قائمة الزبائن"""
        self.customer_listbox.delete(0, tk.END)
        self.customer_listbox.customer_data = []
        
        for customer in self.customers[:50]:  # عرض أول 50 زبون فقط
            display_text = f"{customer['id']} - {customer['name']} | علبة: {customer.get('box_number', '')} | رصيد: {customer.get('current_balance', 0):,.0f} كيلو واط"
            self.customer_listbox.insert(tk.END, display_text)
            self.customer_listbox.customer_data.append(customer)
    
    def on_customer_selected(self, event):
        """عند اختيار زبون"""
        selection = self.customer_listbox.curselection()
        if selection:
            index = selection[0]
            self.selected_customer = self.customer_listbox.customer_data[index]
            self.display_customer_info()
    
    def display_customer_info(self):
        """عرض معلومات الزبون المحدد"""
        if not self.selected_customer:
            return
        
        # إطار معلومات الزبون
        if hasattr(self, 'info_frame'):
            self.info_frame.destroy()
        
        self.info_frame = tk.Frame(self.dialog, bg='#e8f4fc', relief='ridge', borderwidth=2)
        self.info_frame.place(x=20, y=150, width=760, height=100)
        
        info_text = f"""
        👤 الزبون: {self.selected_customer['name']}
        📍 القطاع: {self.selected_customer.get('sector_name', 'غير محدد')}
        📦 العلبة: {self.selected_customer.get('box_number', '')} | المسلسل: {self.selected_customer.get('serial_number', '')}
        💰 الرصيد الحالي: {self.selected_customer.get('current_balance', 0):,.0f} كيلو واط
        📊 آخر قراءة عداد: {self.selected_customer.get('last_counter_reading', 0):,.0f}
        """
        
        info_label = tk.Label(self.info_frame, text=info_text,
                             font=('Arial', 11),
                             bg='#e8f4fc', fg='#2c3e50',
                             justify='left')
        info_label.pack(padx=10, pady=10)
    
    def create_payment_tab(self, parent):
        """إنشاء تبويب بيانات الدفع"""
        # إطار الحقول
        fields_frame = tk.Frame(parent, bg='#f5f7fa', padx=30, pady=20)
        fields_frame.pack(fill='both', expand=True)
        
        # تعريف الحقول الجديدة
        fields = [
            ('kilowatt_amount', 'كمية الدفع (كيلو)', 'entry', {'width': 15}),
            ('free_kilowatt', 'المجاني (كيلو)', 'entry', {'width': 15, 'default': '0'}),
            ('price_per_kilo', 'سعر الكيلو (ل.س)', 'entry', {'width': 15, 'default': '7200'}),
            ('discount', 'الحسم (ل.س)', 'entry', {'width': 15, 'default': '0'}),
            ('book_number', 'رقم الدفتر', 'entry', {'width': 20}),
            ('receipt_number', 'رقم الوصل', 'entry', {'width': 20}),
            ('visa_application', 'تنزيل تأشيرة', 'entry', {'width': 20}),
            ('customer_withdrawal', 'سحب المشترك', 'entry', {'width': 20})
        ]
    
        self.payment_vars = {}
        
        for i, (field_name, label, field_type, options) in enumerate(fields):
            row = i // 2
            col = (i % 2) * 2
            
            # تسمية الحقل
            lbl = tk.Label(fields_frame, text=label + ":",
                          font=('Arial', 11, 'bold'),
                          bg='#f5f7fa', fg='#2c3e50',
                          anchor='e')
            lbl.grid(row=row, column=col, sticky='e', padx=10, pady=12)
            
            # حقل الإدخال
            if field_type == 'entry':
                var = tk.StringVar(value=options.get('default', ''))
                entry = ttk.Entry(fields_frame, textvariable=var,
                                 font=('Arial', 11),
                                 width=options.get('width', 20))
                entry.grid(row=row, column=col+1, sticky='w', padx=10, pady=12)
                self.payment_vars[field_name] = var
        
        # زر حساب الفاتورة
        calc_btn = tk.Button(fields_frame, text="🧮 حساب الفاتورة",
                           command=self.calculate_invoice,
                           bg='#3498db', fg='white',
                           font=('Arial', 12, 'bold'),
                           padx=20, pady=10)
        calc_btn.grid(row=len(fields)//2 + 1, column=0, columnspan=4, pady=30)
    
    def calculate_invoice(self):
        """حساب الفاتورة"""
        if not self.selected_customer:
            messagebox.showwarning("تحذير", "يرجى اختيار زبون أولاً")
            return
        
        # التحقق من الحقول المطلوبة
        if not self.payment_vars['kilowatt_amount'].get():
            messagebox.showerror("خطأ", "كمية الدفع مطلوبة")
            return
        
        try:
            # تحميل مدير الفواتير
            from modules.invoices import InvoiceManager
            invoice_manager = InvoiceManager()
            
            # تجميع بيانات الدفع
            payment_data = {
                'kilowatt_amount': float(self.payment_vars['kilowatt_amount'].get()),
                'free_kilowatt': float(self.payment_vars['free_kilowatt'].get() or 0),
                'price_per_kilo': float(self.payment_vars['price_per_kilo'].get() or 7200),
                'discount': float(self.payment_vars['discount'].get() or 0)
            }
            
            # حساب الفاتورة
            self.calculation_result = invoice_manager.calculate_invoice(
                self.selected_customer,
                payment_data
            )
            
            if self.calculation_result:
                # تحديث تبويب المعاينة
                self.update_preview_tab()
                messagebox.showinfo("نجاح", "تم حساب الفاتورة بنجاح")
            else:
                messagebox.showerror("خطأ", "فشل حساب الفاتورة")
                
        except ValueError as e:
            messagebox.showerror("خطأ", "يرجى إدخال أرقام صحيحة في الحقول الرقمية")
        except Exception as e:
            logger.error(f"خطأ في حساب الفاتورة: {e}")
            messagebox.showerror("خطأ", f"فشل حساب الفاتورة: {str(e)}")
    
    def create_preview_tab(self, parent):
        """إنشاء تبويب معاينة الحساب"""
        self.preview_frame = tk.Frame(parent, bg='white')
        self.preview_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # رسالة افتراضية
        self.preview_label = tk.Label(self.preview_frame,
                                     text="سيظهر هنا تفاصيل الفاتورة بعد الحساب",
                                     font=('Arial', 14),
                                     bg='white', fg='#7f8c8d')
        self.preview_label.pack(expand=True)
    
    def update_preview_tab(self):
        """تحديث تبويب المعاينة بالحسابات"""
        if not self.calculation_result or not self.selected_customer:
            return
        
        # مسح المحتوى القديم
        for widget in self.preview_frame.winfo_children():
            widget.destroy()
        
        # إنشاء عرض تفصيلي
        details_frame = tk.Frame(self.preview_frame, bg='#f8f9fa', relief='solid', borderwidth=1)
        details_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # معلومات الزبون
        customer_info = f"""
        الزبون: {self.selected_customer['name']}
        القطاع: {self.selected_customer.get('sector_name', 'غير محدد')}
        العلبة: {self.selected_customer.get('box_number', '')} | المسلسل: {self.selected_customer.get('serial_number', '')}
        الرصيد السابق: {self.selected_customer.get('current_balance', 0):,.0f} كيلو واط
        """
        
        customer_label = tk.Label(details_frame, text=customer_info,
                                 font=('Arial', 11),
                                 bg='#f8f9fa', fg='#2c3e50',
                                 justify='left', anchor='w')
        customer_label.pack(padx=20, pady=10, anchor='w')
        
        # تفاصيل الحساب
        calc = self.calculation_result
        calculation_info = f"""
        ─────────────────────────────────────
        📊 تفاصيل الفاتورة:
        
        • كمية الدفع: {calc['kilowatt_amount']:,.1f} كيلو
        • المجاني: {calc['free_kilowatt']:,.1f} كيلو
        • الإجمالي المقطوع: {calc['consumed_kilowatt']:,.1f} كيلو
        • سعر الكيلو: {calc['price_per_kilo']:,.0f} ل.س
        • المبلغ قبل الحسم: {calc['net_amount']:,.0f} ل.س
        • الحسم: {calc['discount']:,.0f} ل.س
        
        ─────────────────────────────────────
        💰 المبلغ الإجمالي: {calc['total_amount']:,.0f} ليرة سورية
        ─────────────────────────────────────
        
        📈 قراءات العداد:
        • القراءة السابقة: {calc['previous_reading']:,.0f}
        • القراءة الجديدة: {calc['new_reading']:,.0f}
        • الكمية المقطوعة: {calc['consumed_kilowatt']:,.1f} كيلو
        
        💳 الرصيد الجديد: {calc['current_balance']:,.0f} كيلو واط
        🔑 كود التيليغرام: {calc.get('telegram_password', '')}
        """
        
        calculation_label = tk.Label(details_frame, text=calculation_info,
                                    font=('Arial', 11),
                                    bg='#f8f9fa', fg='#2c3e50',
                                    justify='left', anchor='w')
        calculation_label.pack(padx=20, pady=10, anchor='w')
    
    def create_buttons(self, parent):
        """إنشاء أزرار التحكم"""
        buttons_frame = tk.Frame(parent, bg='#f5f7fa')
        buttons_frame.pack(fill='x', pady=20)
        
        # زر حفظ وإنشاء الفاتورة
        save_btn = tk.Button(buttons_frame, text="💾 حفظ وإنشاء الفاتورة",
                           command=self.save_invoice,
                           bg='#27ae60', fg='white',
                           font=('Arial', 12, 'bold'),
                           padx=30, pady=12, cursor='hand2')
        save_btn.pack(side='right', padx=10)
        
        # زر الإلغاء
        cancel_btn = tk.Button(buttons_frame, text="❌ إلغاء",
                              command=self.cancel,
                              bg='#e74c3c', fg='white',
                              font=('Arial', 12),
                              padx=30, pady=12, cursor='hand2')
        cancel_btn.pack(side='left', padx=10)
    
    def save_invoice(self):
        """حفظ وإنشاء الفاتورة"""
        if not self.selected_customer:
            messagebox.showerror("خطأ", "يرجى اختيار زبون أولاً")
            return
        
        if not self.calculation_result:
            messagebox.showerror("خطأ", "يرجى حساب الفاتورة أولاً")
            return
        
        # تأكيد الإنشاء
        confirm = messagebox.askyesno(
            "تأكيد الإنشاء",
            "هل تريد إنشاء هذه الفاتورة؟\n\n"
            "سيتم تحديث قراءة العداد والرصيد للزبون."
        )
        
        if not confirm:
            return
        
        try:
            # الحصول على معرف القطاع
            sector_id = None
            for sector in self.sectors:
                if sector['name'] == self.selected_customer.get('sector_name', ''):
                    sector_id = sector['id']
                    break
            
            if not sector_id:
                messagebox.showerror("خطأ", "القطاع غير صالح")
                return
            
            # تجميع بيانات الفاتورة
            invoice_data = {
                'customer_id': self.selected_customer['id'],
                'customer_name': self.selected_customer['name'],
                'sector_id': sector_id,
                'user_id': self.user_data['id'],
                'kilowatt_amount': self.calculation_result['kilowatt_amount'],
                'free_kilowatt': self.calculation_result['free_kilowatt'],
                'price_per_kilo': self.calculation_result['price_per_kilo'],
                'discount': self.calculation_result['discount'],
                'total_amount': self.calculation_result['total_amount'],
                'previous_reading': self.calculation_result['previous_reading'],
                'new_reading': self.calculation_result['new_reading'],
                'current_balance': self.calculation_result['current_balance'],
                'telegram_password': self.calculation_result.get('telegram_password', ''),
                'book_number': self.payment_vars['book_number'].get(),
                'receipt_number': self.payment_vars['receipt_number'].get(),
                'visa_application': self.payment_vars['visa_application'].get(),
                'customer_withdrawal': self.payment_vars['customer_withdrawal'].get()
            }
            
            # إنشاء الفاتورة
            from modules.invoices import InvoiceManager
            invoice_manager = InvoiceManager()
            result = invoice_manager.create_invoice(invoice_data)
            
            if result.get('success'):
                self.result = result
                self.dialog.destroy()
            else:
                messagebox.showerror("خطأ", result.get('error', 'فشل إنشاء الفاتورة'))
                
        except Exception as e:
            logger.error(f"خطأ في إنشاء الفاتورة: {e}")
            messagebox.showerror("خطأ", f"فشل إنشاء الفاتورة: {str(e)}")
    
    def cancel(self):
        """إلغاء العملية"""
        self.result = None
        self.dialog.destroy()


لف invoice_preview.py له الكود التالي
# ui/invoice_preview.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime
from PIL import Image, ImageTk

logger = logging.getLogger(__name__)

class InvoicePreview:
    """معاينة الفاتورة قبل الطباعة"""
    
    def __init__(self, parent, invoice_data, user_data):
        self.parent = parent
        self.invoice_data = invoice_data
        self.user_data = user_data
        
        self.create_dialog()
        self.create_widgets()
        
        self.dialog.grab_set()
    
    def create_dialog(self):
        """إنشاء النافذة المنبثقة"""
        self.dialog = tk.Toplevel(self.parent)
        self.dialog.title(f"معاينة الفاتورة - {self.invoice_data.get('invoice_number', '')}")
        self.dialog.geometry("900x700")
        self.dialog.resizable(True, True)
        self.dialog.configure(bg='#f5f7fa')
        
        # مركزية النافذة
        self.dialog.update_idletasks()
        width = self.dialog.winfo_width()
        height = self.dialog.winfo_height()
        x = (self.dialog.winfo_screenwidth() // 2) - (width // 2)
        y = (self.dialog.winfo_screenheight() // 2) - (height // 2)
        self.dialog.geometry(f'900x700+{x}+{y}')
    
    def create_widgets(self):
        """إنشاء عناصر المعاينة"""
        # إطار العنوان
        title_frame = tk.Frame(self.dialog, bg='#9b59b6', height=70)
        title_frame.pack(fill='x')
        title_frame.pack_propagate(False)
        
        title_label = tk.Label(title_frame, 
                              text=f"معاينة الفاتورة - {self.invoice_data.get('invoice_number', '')}",
                              font=('Arial', 18, 'bold'),
                              bg='#9b59b6', fg='white')
        title_label.pack(expand=True)
        
        # إطار المحتوى الرئيسي
        main_frame = tk.Frame(self.dialog, bg='#f5f7fa')
        main_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # إنشاء عرض الفاتورة
        self.create_invoice_display(main_frame)
        
        # أزرار التحكم
        self.create_buttons(main_frame)
    
    def create_invoice_display(self, parent):
        """إنشاء عرض الفاتورة"""
        # إطار مع تمرير
        canvas = tk.Canvas(parent, bg='white', highlightthickness=0)
        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=canvas.yview)
        content_frame = tk.Frame(canvas, bg='white')
        
        canvas.create_window((0, 0), window=content_frame, anchor='nw')
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # تحديث منطقة التمرير
        content_frame.bind('<Configure>', lambda e: canvas.configure(scrollregion=canvas.bbox('all')))
        
        # محاكاة تصميم الفاتورة المطبوعة
        self.create_invoice_layout(content_frame)
        
        # تعبئة وإظهار
        canvas.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def create_invoice_layout(self, parent):
        """إنشاء تخطيط الفاتورة"""
        # عرض المعلومات بشكل مشابه للطباعة
        
        # رأس الفاتورة
        header_frame = tk.Frame(parent, bg='white', relief='solid', borderwidth=2)
        header_frame.pack(fill='x', padx=10, pady=10)
        
        tk.Label(header_frame, text="شركة الريان للطاقة الكهربائية",
                font=('Arial', 20, 'bold'),
                bg='white', fg='#2c3e50').pack(pady=5)
        
        tk.Label(header_frame, text="فاتورة استهلاك كهرباء",
                font=('Arial', 16),
                bg='white', fg='#2c3e50').pack()
        
        tk.Label(header_frame, text="نسخة المعاينة",
                font=('Arial', 12),
                bg='white', fg='#7f8c8d').pack()
        
        tk.Label(header_frame, 
                text=f"التاريخ: {self.invoice_data.get('payment_date', '')} - الوقت: {self.invoice_data.get('payment_time', '')}",
                font=('Arial', 11),
                bg='white', fg='#34495e').pack(pady=5)
        
        # خط فاصل
        tk.Frame(parent, height=2, bg='#34495e').pack(fill='x', padx=20, pady=10)
        
        # معلومات الزبون
        info_frame = tk.Frame(parent, bg='#f8f9fa', relief='ridge', borderwidth=1)
        info_frame.pack(fill='x', padx=20, pady=10)
        
        customer_info = f"""
        اسم الزبون: {self.invoice_data.get('customer_name', '')}
        القطاع: {self.invoice_data.get('sector_name', '')}
        العلبة: {self.invoice_data.get('box_number', '')} | المسلسل: {self.invoice_data.get('serial_number', '')}
        رقم الدفتر: {self.invoice_data.get('book_number', '')} | رقم الوصل: {self.invoice_data.get('receipt_number', '')}
        """
        
        tk.Label(info_frame, text=customer_info,
                font=('Arial', 11),
                bg='#f8f9fa', fg='#2c3e50',
                justify='left', anchor='w').pack(padx=10, pady=10)
        
        # تفاصيل الدفع
        payment_frame = tk.Frame(parent, bg='white')
        payment_frame.pack(fill='x', padx=20, pady=15)
        
        # جدول تفاصيل الدفع
        details = [
            ("الكمية المدفوعة:", f"{float(self.invoice_data.get('kilowatt_amount', 0)):,.1f} كيلو"),
            ("الكمية المجانية:", f"{float(self.invoice_data.get('free_kilowatt', 0)):,.1f} كيلو"),
            ("الإجمالي المقطوع:", f"{float(self.invoice_data.get('kilowatt_amount', 0)) + float(self.invoice_data.get('free_kilowatt', 0)):,.1f} كيلو"),
            ("سعر الكيلو:", f"{float(self.invoice_data.get('price_per_kilo', 0)):,.0f} ل.س"),
            ("الحسم:", f"{float(self.invoice_data.get('discount', 0)):,.0f} ل.س"),
            ("المبلغ قبل الحسم:", f"{float(self.invoice_data.get('kilowatt_amount', 0)) * float(self.invoice_data.get('price_per_kilo', 0)):,.0f} ل.س")
        ]
        
        for label, value in details:
            row_frame = tk.Frame(payment_frame, bg='white')
            row_frame.pack(fill='x', pady=3)
            
            tk.Label(row_frame, text=label,
                    font=('Arial', 11, 'bold'),
                    bg='white', fg='#2c3e50',
                    width=20, anchor='w').pack(side='left')
            
            tk.Label(row_frame, text=value,
                    font=('Arial', 11),
                    bg='white', fg='#34495e',
                    anchor='w').pack(side='left')
        
        # خط فاصل
        tk.Frame(parent, height=1, bg='#bdc3c7').pack(fill='x', padx=20, pady=10)
        
        # المبلغ الإجمالي
        total_frame = tk.Frame(parent, bg='#2ecc71', relief='solid', borderwidth=2)
        total_frame.pack(fill='x', padx=20, pady=10)
        
        tk.Label(total_frame, text="المبلغ الإجمالي:",
                font=('Arial', 16, 'bold'),
                bg='#2ecc71', fg='white').pack(pady=5)
        
        tk.Label(total_frame, text=f"{float(self.invoice_data.get('total_amount', 0)):,.0f} ليرة سورية",
                font=('Arial', 20, 'bold'),
                bg='#2ecc71', fg='white').pack(pady=5)
        
        # قراءات العداد
        counter_frame = tk.Frame(parent, bg='#e8f4fc', relief='solid', borderwidth=1)
        counter_frame.pack(fill='x', padx=20, pady=15)
        
        counter_info = f"""
        قراءة العداد:
        • القراءة السابقة: {float(self.invoice_data.get('previous_reading', 0)):,.0f}
        • القراءة الجديدة: {float(self.invoice_data.get('new_reading', 0)):,.0f}
        • الكمية المقطوعة: {float(self.invoice_data.get('kilowatt_amount', 0)) + float(self.invoice_data.get('free_kilowatt', 0)):,.1f} كيلو
        • الرصيد الجديد: {float(self.invoice_data.get('current_balance', 0)):,.0f} ل.س
        """
        
        tk.Label(counter_frame, text=counter_info,
                font=('Arial', 11),
                bg='#e8f4fc', fg='#2c3e50',
                justify='left', anchor='w').pack(padx=10, pady=10)
        
        # معلومات إضافية
        if self.invoice_data.get('visa_application') or self.invoice_data.get('customer_withdrawal'):
            extra_frame = tk.Frame(parent, bg='#fff9e6', relief='solid', borderwidth=1)
            extra_frame.pack(fill='x', padx=20, pady=10)
            
            extra_info = []
            if self.invoice_data.get('visa_application'):
                extra_info.append(f"تنزيل تأشيرة: {self.invoice_data.get('visa_application')}")
            if self.invoice_data.get('customer_withdrawal'):
                extra_info.append(f"سحب المشترك: {self.invoice_data.get('customer_withdrawal')}")
            if self.invoice_data.get('telegram_password'):
                extra_info.append(f"كود التيليغرام: {self.invoice_data.get('telegram_password')}")
            
            if extra_info:
                tk.Label(extra_frame, text="\n".join(extra_info),
                        font=('Arial', 10),
                        bg='#fff9e6', fg='#d35400',
                        justify='left', anchor='w').pack(padx=10, pady=10)
        
        # تذييل الفاتورة
        footer_frame = tk.Frame(parent, bg='#f5f5f5', relief='solid', borderwidth=1)
        footer_frame.pack(fill='x', padx=20, pady=15)
        
        footer_text = f"""
        المحاسب: {self.invoice_data.get('accountant_name', '')}
        هاتف: 0952411882
        أرضي: 310344
        
        ملاحظة: لسنا مسؤولين عن الأعطال التي تصيب الأجهزة الكهربائية
        """
        
        tk.Label(footer_frame, text=footer_text,
                font=('Arial', 10),
                bg='#f5f5f5', fg='#7f8c8d',
                justify='center').pack(padx=10, pady=10)
    
    def create_buttons(self, parent):
        """إنشاء أزرار التحكم"""
        buttons_frame = tk.Frame(parent, bg='#f5f7fa')
        buttons_frame.pack(fill='x', pady=20)
        
        # زر الطباعة
        print_btn = tk.Button(buttons_frame, text="🖨️ طباعة الفاتورة",
                             command=self.print_invoice,
                             bg='#3498db', fg='white',
                             font=('Arial', 12, 'bold'),
                             padx=30, pady=10, cursor='hand2')
        print_btn.pack(side='right', padx=10)
        
        # زر الطباعة بدون رصيد
        print_no_balance_btn = tk.Button(buttons_frame, text="🖨️ طباعة بدون رصيد",
                                       command=self.print_without_balance,
                                       bg='#9b59b6', fg='white',
                                       font=('Arial', 12),
                                       padx=20, pady=10, cursor='hand2')
        print_no_balance_btn.pack(side='right', padx=10)
        
        # زر الإغلاق
        close_btn = tk.Button(buttons_frame, text="إغلاق",
                             command=self.dialog.destroy,
                             bg='#95a5a6', fg='white',
                             font=('Arial', 12),
                             padx=30, pady=10, cursor='hand2')
        close_btn.pack(side='left', padx=10)
    
    def print_invoice(self):
        """طباعة الفاتورة"""
        try:
            from utils.printer import InvoicePrinter
            printer = InvoicePrinter()
            
            if printer.print_invoice(self.invoice_data):
                messagebox.showinfo("نجاح", "تم إرسال الفاتورة للطابعة بنجاح")
            else:
                messagebox.showerror("خطأ", "فشل إرسال الفاتورة للطابعة")
                
        except Exception as e:
            logger.error(f"خطأ في الطباعة: {e}")
            messagebox.showerror("خطأ", f"فشل الطباعة: {str(e)}")
    
    def print_without_balance(self):
        """طباعة الفاتورة بدون عرض الرصيد"""
        try:
            # نسخ بيانات الفاتورة
            invoice_copy = self.invoice_data.copy()
            invoice_copy['current_balance'] = 0  # إخفاء الرصيد
            
            from utils.printer import InvoicePrinter
            printer = InvoicePrinter()
            
            if printer.print_invoice(invoice_copy):
                messagebox.showinfo("نجاح", "تم طباعة الفاتورة بدون رصيد")
            else:
                messagebox.showerror("خطأ", "فشل الطباعة")
                
        except Exception as e:
            logger.error(f"خطأ في الطباعة بدون رصيد: {e}")
            messagebox.showerror("خطأ", f"فشل الطباعة: {str(e)}")
ملف invoice_ui.py له الكود التالي
# ui/invoice_ui.py
# السطر 1 في invoice_ui.py يصبح:
from auth import require_permission, Permission
# بدلاً من:
# from auth.permissions import require_permission, Permission
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime, timedelta
from modules.invoices import InvoiceManager
from modules.customers import CustomerManager
from database.connection import db

logger = logging.getLogger(__name__)

class InvoiceUI(tk.Frame):
    """واجهة إدارة الفواتير"""

    def __init__(self, parent, user_data):
        super().__init__(parent)
        self.user_data = user_data
        self.invoice_manager = InvoiceManager()
        self.customer_manager = CustomerManager()
        
        # إعدادات العرض
        self.current_page = 1
        self.page_size = 50
        self.search_filters = {}
        
        self.create_widgets()
        self.load_invoices()
        self.load_customers_for_filter()
        self.load_sectors_for_filter()
    
    def create_widgets(self):
        """إنشاء عناصر الواجهة"""
        # الجزء العلوي: أدوات البحث والتصفية
        self.create_search_toolbar()
        
        # الجزء الأوسط: جدول الفواتير
        self.create_invoice_table()
        
        # الجزء السفلي: التحكم بالصفحات
        self.create_pagination()
        
        # الجزء الجانبي: تفاصيل الفاتورة
        self.create_detail_panel()
        
        # شريط الأدوات السفلي
        self.create_bottom_toolbar()
    
    def create_search_toolbar(self):
        """إنشاء شريط أدوات البحث"""
        toolbar = tk.Frame(self, bg='#f8f9fa', padx=10, pady=10)
        toolbar.pack(fill='x')
        
        # البحث بالتاريخ
        tk.Label(toolbar, text="من تاريخ:", bg='#f8f9fa').pack(side='left')
        self.start_date_entry = tk.Entry(toolbar, width=12)
        self.start_date_entry.insert(0, (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d"))
        self.start_date_entry.pack(side='left', padx=5)
        
        tk.Label(toolbar, text="إلى تاريخ:", bg='#f8f9fa').pack(side='left')
        self.end_date_entry = tk.Entry(toolbar, width=12)
        self.end_date_entry.insert(0, datetime.now().strftime("%Y-%m-%d"))
        self.end_date_entry.pack(side='left', padx=5)
        
        # البحث بالزبون
        tk.Label(toolbar, text="الزبون:", bg='#f8f9fa').pack(side='left')
        self.customer_combo = ttk.Combobox(toolbar, width=20, state='readonly')
        self.customer_combo.pack(side='left', padx=5)
        
        # البحث بالقطاع
        tk.Label(toolbar, text="القطاع:", bg='#f8f9fa').pack(side='left')
        self.sector_combo = ttk.Combobox(toolbar, width=15, state='readonly')
        self.sector_combo.pack(side='left', padx=5)
        
        # زر البحث
        search_btn = tk.Button(toolbar, text="بحث", command=self.apply_filters,
                              bg='#3498db', fg='white')
        search_btn.pack(side='left', padx=10)
        
        # زر إعادة التعيين
        reset_btn = tk.Button(toolbar, text="إعادة تعيين", command=self.reset_filters,
                             bg='#95a5a6', fg='white')
        reset_btn.pack(side='left')
    
    def create_invoice_table(self):
        """إنشاء جدول الفواتير"""
        table_frame = tk.Frame(self)
        table_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # شريط التمرير
        scrollbar = ttk.Scrollbar(table_frame)
        scrollbar.pack(side='right', fill='y')
        
        # تعريف الأعمدة
        columns = ('id', 'invoice_number', 'date', 'customer', 'sector', 
                  'amount', 'status', 'accountant')
        
        self.tree = ttk.Treeview(table_frame, columns=columns, 
                                yscrollcommand=scrollbar.set,
                                selectmode='browse', height=20)
        
        scrollbar.config(command=self.tree.yview)
        
        # تخصيص الأعمدة
        self.tree.column('#0', width=0, stretch=False)
        self.tree.column('id', width=50, anchor='center')
        self.tree.column('invoice_number', width=150, anchor='center')
        self.tree.column('date', width=100, anchor='center')
        self.tree.column('customer', width=180, anchor='w')
        self.tree.column('sector', width=100, anchor='center')
        self.tree.column('amount', width=120, anchor='center')
        self.tree.column('status', width=100, anchor='center')
        self.tree.column('accountant', width=120, anchor='w')
        
        # عناوين الأعمدة
        self.tree.heading('id', text='ID')
        self.tree.heading('invoice_number', text='رقم الفاتورة')
        self.tree.heading('date', text='التاريخ')
        self.tree.heading('customer', text='الزبون')
        self.tree.heading('sector', text='القطاع')
        self.tree.heading('amount', text='المبلغ')
        self.tree.heading('status', text='الحالة')
        self.tree.heading('accountant', text='المحاسب')
        
        self.tree.pack(fill='both', expand=True)
        
        # ربط حدث التحديد
        self.tree.bind('<<TreeviewSelect>>', self.on_invoice_select)
    
    def create_pagination(self):
        """إنشاء عناصر التحكم بالصفحات"""
        pagination_frame = tk.Frame(self, bg='#ecf0f1', pady=10)
        pagination_frame.pack(fill='x')
        
        self.page_label = tk.Label(pagination_frame, 
                                  text="الصفحة 1 من 1", 
                                  bg='#ecf0f1')
        self.page_label.pack(side='left', padx=10)
        
        nav_buttons = [
            ("⏪ الأولى", self.first_page),
            ("◀ السابقة", self.prev_page),
            ("▶ التالية", self.next_page),
            ("⏩ الأخيرة", self.last_page)
        ]
        
        for text, command in nav_buttons:
            btn = tk.Button(pagination_frame, text=text, command=command,
                          bg='#7f8c8d', fg='white', font=('Arial', 9))
            btn.pack(side='left', padx=2)
    
    def create_detail_panel(self):
        """إنشاء لوحة تفاصيل الفاتورة"""
        self.detail_frame = tk.Frame(self, width=350, bg='white',
                                    relief='sunken', borderwidth=2)
        self.detail_frame.pack_propagate(False)
    
    def create_bottom_toolbar(self):
        """إنشاء شريط الأدوات السفلي"""
        toolbar = tk.Frame(self, bg='#2c3e50', pady=8)
        toolbar.pack(fill='x', side='bottom')
        
        actions = [
            ("➕ فاتورة جديدة", self.create_new_invoice, '#27ae60'),
            ("✏️ تعديل الفاتورة", self.edit_invoice, '#3498db'),
            ("🗑️ حذف الفاتورة", self.delete_invoice, '#e74c3c'),
            ("🖨️ طباعة الفاتورة", self.print_invoice, '#9b59b6'),
            ("📊 ملخص اليوم", self.show_daily_summary, '#f39c12'),
            ("📈 تقرير الفواتير", self.generate_report, '#16a085')
        ]
        
        for text, command, color in actions:
            btn = tk.Button(toolbar, text=text, command=command,
                          bg=color, fg='white', font=('Arial', 10))
            btn.pack(side='left', padx=5)
    
    def load_customers_for_filter(self):
        """تحميل قائمة الزبائن للفلترة"""
        try:
            customers = self.customer_manager.search_customers()
            customer_list = ["الكل"]
            self.customer_filter_dict = {"الكل": None}
            
            for customer in customers:
                display_name = f"{customer['name']} - {customer.get('box_number', '')}"
                customer_list.append(display_name)
                self.customer_filter_dict[display_name] = customer['id']
            
            self.customer_combo['values'] = customer_list
            self.customer_combo.current(0)
            
        except Exception as e:
            logger.error(f"خطأ في تحميل الزبائن للفلترة: {e}")
    
    def load_sectors_for_filter(self):
        """تحميل القطاعات للفلترة"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("SELECT id, name FROM sectors ORDER BY name")
                sectors = cursor.fetchall()
                
                sector_list = ["الكل"]
                self.sector_filter_dict = {"الكل": None}
                
                for sector in sectors:
                    sector_list.append(sector['name'])
                    self.sector_filter_dict[sector['name']] = sector['id']
                
                self.sector_combo['values'] = sector_list
                self.sector_combo.current(0)
                
        except Exception as e:
            logger.error(f"خطأ في تحميل القطاعات للفلترة: {e}")
    
    def load_invoices(self):
        """تحميل الفواتير للعرض"""
        try:
            # مسح البيانات القديمة
            for item in self.tree.get_children():
                self.tree.delete(item)
            
            # حساب الإزاحة
            offset = (self.current_page - 1) * self.page_size
            
            # تطبيق الفلاتر
            filters = self.search_filters.copy()
            filters['limit'] = self.page_size
            filters['offset'] = offset
            
            # جلب الفواتير
            invoices = self.invoice_manager.search_invoices(**filters)
            
            # إضافة البيانات للشجرة
            for invoice in invoices:
                self.tree.insert('', 'end', 
                               values=(invoice['id'],
                                       invoice['invoice_number'],
                                       invoice['payment_date'],
                                       invoice.get('customer_name', ''),
                                       invoice.get('sector_name', ''),
                                       f"{invoice['total_amount']:,.0f}",
                                       invoice['status'],
                                       invoice.get('accountant_name', '')),
                               tags=(invoice['status'],))
            
            # تحديث تسمية الصفحة
            # (لاحظ: نحن بحاجة إلى معرفة العدد الإجمالي، لكن search_invoices لا ترجعها حالياً)
            # سنضيف منطقاً للحصول على العدد الإجمالي في الخطوة القادمة
            
            # تلوين الصفوف حسب الحالة
            self.tree.tag_configure('active', background='#e8f5e9')
            self.tree.tag_configure('cancelled', background='#ffebee')
            
        except Exception as e:
            logger.error(f"خطأ في تحميل الفواتير: {e}")
            messagebox.showerror("خطأ", f"فشل تحميل الفواتير: {str(e)}")
    
    def apply_filters(self):
        """تطبيق الفلاتر"""
        self.search_filters = {}
        
        # تاريخ البدء
        start_date = self.start_date_entry.get().strip()
        if start_date:
            self.search_filters['start_date'] = start_date
        
        # تاريخ الانتهاء
        end_date = self.end_date_entry.get().strip()
        if end_date:
            self.search_filters['end_date'] = end_date
        
        # الزبون
        customer = self.customer_combo.get()
        if customer != "الكل":
            customer_id = self.customer_filter_dict.get(customer)
            if customer_id:
                self.search_filters['customer_id'] = customer_id
        
        # القطاع
        sector = self.sector_combo.get()
        if sector != "الكل":
            sector_id = self.sector_filter_dict.get(sector)
            if sector_id:
                self.search_filters['sector_id'] = sector_id
        
        # إعادة تحميل الفواتير
        self.current_page = 1
        self.load_invoices()
    
    def reset_filters(self):
        """إعادة تعيين الفلاتر"""
        self.start_date_entry.delete(0, 'end')
        self.start_date_entry.insert(0, (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d"))
        
        self.end_date_entry.delete(0, 'end')
        self.end_date_entry.insert(0, datetime.now().strftime("%Y-%m-%d"))
        
        self.customer_combo.current(0)
        self.sector_combo.current(0)
        
        self.search_filters = {}
        self.current_page = 1
        self.load_invoices()
    
    def on_invoice_select(self, event):
        """عند اختيار فاتورة من القائمة"""
        selection = self.tree.selection()
        if not selection:
            return
        
        item = self.tree.item(selection[0])
        invoice_id = item['values'][0]
        
        # تحميل تفاصيل الفاتورة
        self.show_invoice_details(invoice_id)
    
    def show_invoice_details(self, invoice_id):
        """عرض تفاصيل الفاتورة"""
        try:
            # مسح اللوحة القديمة
            for widget in self.detail_frame.winfo_children():
                widget.destroy()
            
            # إظهار اللوحة
            self.detail_frame.pack(side='right', fill='y', padx=(0, 10), pady=10)
            
            # جلب بيانات الفاتورة
            invoice = self.invoice_manager.get_invoice(invoice_id)
            if not invoice:
                return
            
            # إنشاء محتوى اللوحة
            title = tk.Label(self.detail_frame, text="تفاصيل الفاتورة",
                           font=('Arial', 14, 'bold'), bg='white', fg='#2c3e50')
            title.pack(pady=(10, 5))
            
            # إنشاء إطار التفاصيل
            details_frame = tk.Frame(self.detail_frame, bg='white')
            details_frame.pack(fill='both', expand=True, padx=10)
            
            # عرض البيانات
            details = [
                ("رقم الفاتورة:", invoice['invoice_number']),
                ("التاريخ:", str(invoice['payment_date'])),
                ("الوقت:", str(invoice['payment_time'])),
                ("الزبون:", invoice.get('customer_name', 'غير محدد')),
                ("القطاع:", invoice.get('sector_name', 'غير محدد')),
                ("المحاسب:", invoice.get('accountant_name', 'غير محدد')),
                ("كيلوات الدفع:", f"{invoice['kilowatt_amount']:,.2f}"),
                ("كيلوات مجانية:", f"{invoice['free_kilowatt']:,.2f}"),
                ("سعر الكيلو:", f"{invoice['price_per_kilo']:,.0f}"),
                ("الخصم:", f"{invoice['discount']:,.0f}"),
                ("المبلغ الإجمالي:", f"{invoice['total_amount']:,.0f}"),
                ("القراءة السابقة:", f"{invoice['previous_reading']:,.2f}"),
                ("القراءة الجديدة:", f"{invoice['new_reading']:,.2f}"),
                ("الرصيد الحالي:", f"{invoice['current_balance']:,.0f}"),
                ("الحالة:", invoice['status'])
            ]
            
            for label, value in details:
                frame = tk.Frame(details_frame, bg='white')
                frame.pack(fill='x', pady=2)
                
                lbl = tk.Label(frame, text=label, font=('Arial', 10, 'bold'),
                             bg='white', width=15, anchor='w')
                lbl.pack(side='left')
                
                val = tk.Label(frame, text=value, font=('Arial', 10),
                             bg='white', fg='#555', anchor='w')
                val.pack(side='left', fill='x', expand=True)
            
            # معلومات إضافية
            if invoice.get('visa_application'):
                tk.Label(details_frame, text=f"تنزيل تأشيرة: {invoice['visa_application']}",
                        bg='white', font=('Arial', 10)).pack(anchor='w', pady=2)
            
            if invoice.get('customer_withdrawal'):
                tk.Label(details_frame, text=f"سحب المشترك: {invoice['customer_withdrawal']}",
                        bg='white', font=('Arial', 10)).pack(anchor='w', pady=2)
            
            if invoice.get('book_number'):
                tk.Label(details_frame, text=f"رقم الدفتر: {invoice['book_number']}",
                        bg='white', font=('Arial', 10)).pack(anchor='w', pady=2)
            
            if invoice.get('receipt_number'):
                tk.Label(details_frame, text=f"رقم الوصل: {invoice['receipt_number']}",
                        bg='white', font=('Arial', 10)).pack(anchor='w', pady=2)
            
            # أزرار خاصة بالفاتورة
            action_frame = tk.Frame(self.detail_frame, bg='white', pady=10)
            action_frame.pack(fill='x', padx=10)
            
            if invoice['status'] == 'active':
                tk.Button(action_frame, text="🖨️ طباعة الفاتورة", 
                         command=lambda: self.print_invoice(invoice_id),
                         bg='#3498db', fg='white').pack(fill='x', pady=2)
                
                tk.Button(action_frame, text="✏️ تعديل الفاتورة", 
                         command=lambda: self.edit_invoice(invoice_id),
                         bg='#f39c12', fg='white').pack(fill='x', pady=2)
                
                tk.Button(action_frame, text="❌ إلغاء الفاتورة", 
                         command=lambda: self.cancel_invoice(invoice_id),
                         bg='#e74c3c', fg='white').pack(fill='x', pady=2)
            else:
                tk.Label(action_frame, text="الفاتورة ملغية", 
                        bg='white', fg='red', font=('Arial', 12, 'bold')).pack()
                
        except Exception as e:
            logger.error(f"خطأ في عرض تفاصيل الفاتورة: {e}")
    
    def create_new_invoice(self):
        """إنشاء فاتورة جديدة"""
        try:
            require_permission(Permission.CREATE_BILLS)
        except PermissionError as e:
            messagebox.showerror("صلاحيات", str(e))
            return

        dialog = CreateInvoiceDialog(self, self.user_data)
        self.wait_window(dialog)

        if dialog.result:
            self.load_invoices()
            messagebox.showinfo("نجاح", "تم إنشاء الفاتورة بنجاح")
    
    def edit_invoice(self, invoice_id=None):
        """تعديل فاتورة موجودة"""
        try:
            require_permission(Permission.EDIT_BILLS)
        except PermissionError as e:
            messagebox.showerror("صلاحيات", str(e))
            return

        if not invoice_id:
            selection = self.tree.selection()
            if not selection:
                messagebox.showwarning("تحذير", "يرجى اختيار فاتورة للتعديل")
                return
            item = self.tree.item(selection[0])
            invoice_id = item['values'][0]

        dialog = EditInvoiceDialog(self, invoice_id, self.user_data)
        self.wait_window(dialog)

        if dialog.result:
            self.load_invoices()
            messagebox.showinfo("نجاح", "تم تعديل الفاتورة بنجاح")
    
    def delete_invoice(self):
        """حذف فاتورة"""
        try:
            require_permission(Permission.EDIT_BILLS)
        except PermissionError as e:
            messagebox.showerror("صلاحيات", str(e))
            return

        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("تحذير", "يرجى اختيار فاتورة للحذف")
            return

        item = self.tree.item(selection[0])
        invoice_id = item['values'][0]
        invoice_number = item['values'][1]

        if not messagebox.askyesno("تأكيد الحذف", f"هل أنت متأكد من حذف الفاتورة {invoice_number}؟"):
            return

        try:
            result = self.invoice_manager.delete_invoice(invoice_id)
            if result['success']:
                self.load_invoices()
                self.detail_frame.pack_forget()
                messagebox.showinfo("نجاح", result['message'])
            else:
                messagebox.showerror("خطأ", result['error'])
        except Exception as e:
            logger.error(f"خطأ في حذف الفاتورة: {e}")
            messagebox.showerror("خطأ", f"فشل حذف الفاتورة: {str(e)}")
    
    def print_invoice(self, invoice_id=None):
        """طباعة الفاتورة"""
        try:
            require_permission(Permission.VIEW_REPORTS)
        except PermissionError as e:
            messagebox.showerror("صلاحيات", str(e))
            return

        if not invoice_id:
            selection = self.tree.selection()
            if not selection:
                messagebox.showwarning("تحذير", "يرجى اختيار فاتورة للطباعة")
                return
            item = self.tree.item(selection[0])
            invoice_id = item['values'][0]

        try:
            messagebox.showinfo("طباعة", f"سيتم طباعة الفاتورة #{invoice_id}")
        except Exception as e:
            logger.error(f"خطأ في طباعة الفاتورة: {e}")
            messagebox.showerror("خطأ", f"فشل طباعة الفاتورة: {str(e)}")
    
    def cancel_invoice(self, invoice_id):
        """إلغاء الفاتورة"""
        try:
            require_permission(Permission.EDIT_BILLS)
        except PermissionError as e:
            messagebox.showerror("صلاحيات", str(e))
            return

        if not messagebox.askyesno("تأكيد الإلغاء", "هل أنت متأكد من إلغاء هذه الفاتورة؟"):
            return

        try:
            result = self.invoice_manager.update_invoice(invoice_id, {'status': 'cancelled'})
            if result['success']:
                self.load_invoices()
                self.show_invoice_details(invoice_id)
                messagebox.showinfo("نجاح", result['message'])
            else:
                messagebox.showerror("خطأ", result['error'])
        except Exception as e:
            logger.error(f"خطأ في إلغاء الفاتورة: {e}")
            messagebox.showerror("خطأ", f"فشل إلغاء الفاتورة: {str(e)}")
    
    def show_daily_summary(self):
        """عرض ملخص المبيعات اليومية"""
        try:
            summary = self.invoice_manager.get_daily_summary()
            
            summary_text = f"""
            ملخص المبيعات اليومية:
            
            التاريخ: {summary.get('date', 'غير محدد')}
            عدد الفواتير: {summary.get('total_invoices', 0):,}
            إجمالي المبيعات: {summary.get('total_amount', 0):,.0f} ل.س
            إجمالي الكيلوات: {summary.get('total_kilowatts', 0):,.2f}
            كيلوات مجانية: {summary.get('total_free_kilowatts', 0):,.2f}
            إجمالي الخصم: {summary.get('total_discount', 0):,.0f} ل.س
            """
            
            messagebox.showinfo("ملخص اليوم", summary_text)
            
        except Exception as e:
            logger.error(f"خطأ في عرض الملخص اليومي: {e}")
            messagebox.showerror("خطأ", "فشل تحميل الملخص اليومي")
    
    def generate_report(self):
        """توليد تقرير عن الفواتير"""
        messagebox.showinfo("تقرير الفواتير", "سيتم توليد تقرير الفواتير")
        # سيتم ربط هذا بوحدة التقارير لاحقاً
    
    # دوال التحكم بالصفحات
    def first_page(self):
        self.current_page = 1
        self.load_invoices()
    
    def prev_page(self):
        if self.current_page > 1:
            self.current_page -= 1
            self.load_invoices()
    
    def next_page(self):
        # هنا نحتاج إلى معرفة العدد الإجمالي للصفحات
        # سنقوم بتعديل load_invoices لتعيد العدد الإجمالي
        self.current_page += 1
        self.load_invoices()
    
    def last_page(self):
        # هنا نحتاج إلى معرفة العدد الإجمالي للصفحات
        self.current_page = 10  # قيمة افتراضية
        self.load_invoices()

class CreateInvoiceDialog(tk.Toplevel):
    """نافذة إنشاء فاتورة جديدة"""
    def __init__(self, parent, user_data):
        super().__init__(parent)
        self.title("إنشاء فاتورة جديدة")
        self.geometry("700x800")
        self.user_data = user_data
        self.result = False
        
        self.customer_manager = CustomerManager()
        self.invoice_manager = InvoiceManager()
        
        self.create_widgets()
        self.center_window()
        self.load_customers()
        self.load_sectors()
    
    def center_window(self):
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f'{width}x{height}+{x}+{y}')
    
    def create_widgets(self):
        main_frame = tk.Frame(self, padx=20, pady=20)
        main_frame.pack(fill='both', expand=True)
        
        tk.Label(main_frame, text="إنشاء فاتورة جديدة", 
                font=('Arial', 16, 'bold')).pack(pady=(0, 20))
        
        # إنشاء عناصر النموذج
        self.fields = {}
        
        # قسم معلومات الزبون
        customer_frame = tk.LabelFrame(main_frame, text="معلومات الزبون", padx=10, pady=10)
        customer_frame.pack(fill='x', pady=5)
        
        tk.Label(customer_frame, text="الزبون:").grid(row=0, column=0, sticky='w', pady=5)
        self.customer_var = tk.StringVar()
        self.customer_combo = ttk.Combobox(customer_frame, textvariable=self.customer_var, 
                                          width=30, state='readonly')
        self.customer_combo.grid(row=0, column=1, pady=5)
        self.customer_combo.bind('<<ComboboxSelected>>', self.on_customer_select)
        
        tk.Label(customer_frame, text="القطاع:").grid(row=1, column=0, sticky='w', pady=5)
        self.sector_var = tk.StringVar()
        self.sector_combo = ttk.Combobox(customer_frame, textvariable=self.sector_var, 
                                        width=30, state='readonly')
        self.sector_combo.grid(row=1, column=1, pady=5)
        
        # قسم معلومات الفاتورة
        invoice_frame = tk.LabelFrame(main_frame, text="معلومات الفاتورة", padx=10, pady=10)
        invoice_frame.pack(fill='x', pady=5)
        
        fields_config = [
            ("تاريخ الدفع:", "payment_date", "entry"),
            ("وقت الدفع:", "payment_time", "entry"),
            ("القراءة السابقة:", "previous_reading", "entry"),
            ("القراءة الجديدة:", "new_reading", "entry"),
            ("كمية الدفع (كيلووات):", "kilowatt_amount", "entry"),
            ("المجاني (كيلووات):", "free_kilowatt", "entry"),
            ("سعر الكيلو:", "price_per_kilo", "entry"),
            ("الخصم:", "discount", "entry"),
            ("المبلغ الإجمالي:", "total_amount", "entry"),
            ("تنزيل تأشيرة:", "visa_application", "entry"),
            ("سحب المشترك:", "customer_withdrawal", "entry"),
            ("رقم الدفتر:", "book_number", "entry"),
            ("رقم الوصل:", "receipt_number", "entry"),
            ("كلمة مرور التيليغرام:", "telegram_password", "entry"),
            ("الملاحظات:", "notes", "text")
        ]
        
        for i, (label, field_name, field_type) in enumerate(fields_config):
            tk.Label(invoice_frame, text=label).grid(row=i, column=0, sticky='w', pady=5)
            
            if field_type == 'entry':
                entry = tk.Entry(invoice_frame, width=30)
                entry.grid(row=i, column=1, pady=5)
                self.fields[field_name] = entry
            elif field_type == 'text':
                text = tk.Text(invoice_frame, height=3, width=30)
                text.grid(row=i, column=1, pady=5)
                self.fields[field_name] = text
        
        # تعيين القيم الافتراضية
        self.fields['payment_date'].insert(0, datetime.now().strftime("%Y-%m-%d"))
        self.fields['payment_time'].insert(0, datetime.now().strftime("%H:%M"))
        self.fields['price_per_kilo'].insert(0, "7200")
        
        # أزرار الحفظ والإلغاء
        btn_frame = tk.Frame(main_frame, pady=20)
        btn_frame.pack(fill='x')
        
        tk.Button(btn_frame, text="حفظ", command=self.save,
                 bg='#27ae60', fg='white').pack(side='right', padx=5)
        tk.Button(btn_frame, text="إلغاء", command=self.cancel,
                 bg='#e74c3c', fg='white').pack(side='right')
    
    def load_customers(self):
        """تحميل قائمة الزبائن"""
        try:
            customers = self.customer_manager.search_customers()
            customer_list = []
            self.customer_dict = {}
            
            for customer in customers:
                display_name = f"{customer['name']} - علبة: {customer.get('box_number', '')} - رصيد: {customer.get('current_balance', 0):,.0f}"
                customer_list.append(display_name)
                self.customer_dict[display_name] = customer
            
            self.customer_combo['values'] = customer_list
            
        except Exception as e:
            logger.error(f"خطأ في تحميل الزبائن: {e}")
    
    def load_sectors(self):
        """تحميل قائمة القطاعات"""
        try:
            with db.get_cursor() as cursor:
                cursor.execute("SELECT id, name FROM sectors ORDER BY name")
                sectors = cursor.fetchall()
                
                sector_list = [sector['name'] for sector in sectors]
                self.sector_dict = {sector['name']: sector['id'] for sector in sectors}
                
                self.sector_combo['values'] = sector_list
                
        except Exception as e:
            logger.error(f"خطأ في تحميل القطاعات: {e}")
    
    def on_customer_select(self, event):
        """عند اختيار زبون"""
        selected = self.customer_var.get()
        customer = self.customer_dict.get(selected)
        
        if customer:
            # تعبئة بيانات الزبون
            self.sector_var.set(customer.get('sector_name', ''))
            
            # تعبئة القراءة السابقة
            self.fields['previous_reading'].delete(0, 'end')
            self.fields['previous_reading'].insert(0, str(customer.get('last_counter_reading', 0)))
            
            # تعبئة الرصيد الحالي
            self.fields['total_amount'].delete(0, 'end')
            self.fields['total_amount'].insert(0, str(customer.get('current_balance', 0)))
    
    def save(self):
        """حفظ الفاتورة"""
        try:
            # جمع البيانات من الحقول
            invoice_data = {}
            
            # بيانات الزبون
            selected_customer = self.customer_var.get()
            if not selected_customer:
                messagebox.showerror("خطأ", "يرجى اختيار زبون")
                return
            
            customer = self.customer_dict.get(selected_customer)
            invoice_data['customer_id'] = customer['id']
            
            # بيانات القطاع
            selected_sector = self.sector_var.get()
            if not selected_sector:
                messagebox.showerror("خطأ", "يرجى اختيار قطاع")
                return
            
            invoice_data['sector_id'] = self.sector_dict.get(selected_sector)
            
            # بيانات المستخدم
            invoice_data['user_id'] = self.user_data['id']
            
            # البيانات الأخرى
            for field_name, widget in self.fields.items():
                if isinstance(widget, tk.Entry):
                    value = widget.get().strip()
                elif isinstance(widget, tk.Text):
                    value = widget.get("1.0", "end-1c").strip()
                else:
                    continue
                
                # تحويل القيم الرقمية
                if field_name in ['previous_reading', 'new_reading', 'kilowatt_amount',
                                'free_kilowatt', 'price_per_kilo', 'discount', 'total_amount']:
                    try:
                        value = float(value) if value else 0.0
                    except ValueError:
                        value = 0.0
                
                invoice_data[field_name] = value
            
            # حساب الكيلوات إذا كانت القراءات موجودة
            if 'previous_reading' in invoice_data and 'new_reading' in invoice_data:
                if not invoice_data.get('kilowatt_amount'):
                    kilowatt_amount = invoice_data['new_reading'] - invoice_data['previous_reading']
                    invoice_data['kilowatt_amount'] = max(kilowatt_amount, 0)
                    self.fields['kilowatt_amount'].delete(0, 'end')
                    self.fields['kilowatt_amount'].insert(0, str(invoice_data['kilowatt_amount']))
            
            # حساب المبلغ الإجمالي إذا لم يكن موجوداً
            if not invoice_data.get('total_amount') and invoice_data.get('kilowatt_amount'):
                kilowatt_amount = invoice_data.get('kilowatt_amount', 0)
                free_kilowatt = invoice_data.get('free_kilowatt', 0)
                price_per_kilo = invoice_data.get('price_per_kilo', 0)
                discount = invoice_data.get('discount', 0)
                
                total = (kilowatt_amount - free_kilowatt) * price_per_kilo - discount
                invoice_data['total_amount'] = max(total, 0)
                self.fields['total_amount'].delete(0, 'end')
                self.fields['total_amount'].insert(0, str(invoice_data['total_amount']))
            
            # حساب الرصيد الجديد للزبون
            customer_balance = customer.get('current_balance', 0)
            invoice_amount = invoice_data.get('total_amount', 0)
            invoice_data['current_balance'] = customer_balance + invoice_amount
            
            # إنشاء الفاتورة
            result = self.invoice_manager.create_invoice(invoice_data)
            
            if result['success']:
                self.result = True
                self.destroy()
            else:
                messagebox.showerror("خطأ", result['error'])
                
        except Exception as e:
            logger.error(f"خطأ في حفظ الفاتورة: {e}")
            messagebox.showerror("خطأ", f"فشل حفظ الفاتورة: {str(e)}")
    
    def cancel(self):
        """إلغاء العملية"""
        self.destroy()

class EditInvoiceDialog(CreateInvoiceDialog):
    """نافذة تعديل فاتورة"""
    def __init__(self, parent, invoice_id, user_data):
        self.invoice_id = invoice_id
        super().__init__(parent, user_data)
        self.title("تعديل فاتورة")
        
        # تحميل بيانات الفاتورة الحالية
        self.load_invoice_data()
    
    def load_invoice_data(self):
        """تحميل بيانات الفاتورة للعرض"""
        try:
            invoice = self.invoice_manager.get_invoice(self.invoice_id)
            if not invoice:
                messagebox.showerror("خطأ", "الفاتورة غير موجودة")
                self.destroy()
                return
            
            # تعبئة بيانات الزبون
            customer_name = invoice.get('customer_name', '')
            box_number = invoice.get('box_number', '')
            customer_balance = invoice.get('current_balance', 0)
            display_name = f"{customer_name} - علبة: {box_number} - رصيد: {customer_balance:,.0f}"
            
            self.customer_var.set(display_name)
            
            # تعبئة بيانات القطاع
            self.sector_var.set(invoice.get('sector_name', ''))
            
            # تعبئة الحقول الأخرى
            for field_name, widget in self.fields.items():
                value = invoice.get(field_name, '')
                
                if isinstance(widget, tk.Entry):
                    widget.delete(0, 'end')
                    widget.insert(0, str(value))
                elif isinstance(widget, tk.Text):
                    widget.delete("1.0", "end")
                    widget.insert("1.0", str(value))
                    
        except Exception as e:
            logger.error(f"خطأ في تحميل بيانات الفاتورة: {e}")
            messagebox.showerror("خطأ", "فشل تحميل بيانات الفاتورة")
    
    def save(self):
        """حفظ التعديلات"""
        try:
            # جمع البيانات من الحقول
            update_data = {}
            
            # بيانات القطاع
            selected_sector = self.sector_var.get()
            if selected_sector:
                update_data['sector_id'] = self.sector_dict.get(selected_sector)
            
            # البيانات الأخرى
            for field_name, widget in self.fields.items():
                if isinstance(widget, tk.Entry):
                    value = widget.get().strip()
                elif isinstance(widget, tk.Text):
                    value = widget.get("1.0", "end-1c").strip()
                else:
                    continue
                
                # تحويل القيم الرقمية
                if field_name in ['previous_reading', 'new_reading', 'kilowatt_amount',
                                'free_kilowatt', 'price_per_kilo', 'discount', 'total_amount']:
                    try:
                        value = float(value) if value else 0.0
                    except ValueError:
                        value = 0.0
                
                update_data[field_name] = value
            
            # تحديث الفاتورة
            result = self.invoice_manager.update_invoice(self.invoice_id, update_data)
            
            if result['success']:
                self.result = True
                self.destroy()
            else:
                messagebox.showerror("خطأ", result['error'])
                
        except Exception as e:
            logger.error(f"خطأ في تحديث الفاتورة: {e}")
            messagebox.showerror("خطأ", f"فشل تحديث الفاتورة: {str(e)}")
login_window.py له الكود التنالي 
# ui/login_window.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from auth.authentication import auth

logger = logging.getLogger(__name__)

class LoginWindow:
    def __init__(self):
        self.window = tk.Tk()
        self.setup_window()
        self.create_widgets()
    
    def setup_window(self):
        """إعداد النافذة"""
        self.window.title("نظام إدارة الفواتير - تسجيل الدخول")
        self.window.geometry("500x400")
        self.window.configure(bg="#f0f8ff")
        self.window.resizable(False, False)
        
        # مركزية النافذة
        self.center_window()
    
    def center_window(self):
        """مركزية النافذة"""
        self.window.update_idletasks()
        width = self.window.winfo_width()
        height = self.window.winfo_height()
        x = (self.window.winfo_screenwidth() // 2) - (width // 2)
        y = (self.window.winfo_screenheight() // 2) - (height // 2)
        self.window.geometry(f'{width}x{height}+{x}+{y}')
    
    def create_widgets(self):
        """إنشاء عناصر الواجهة"""
        # الإطار الرئيسي
        main_frame = ttk.Frame(self.window, padding="30")
        main_frame.pack(fill='both', expand=True)
        
        # العنوان
        title_label = ttk.Label(main_frame,
                               text="مولدة الريان للطاقة الكهربائية",
                               font=("Arial", 20, "bold"),
                               foreground="#2c3e50")
        title_label.pack(pady=(0, 30))
        
        # نموذج تسجيل الدخول
        self.create_login_form(main_frame)
    
    def create_login_form(self, parent):
        """إنشاء نموذج تسجيل الدخول"""
        form_frame = ttk.Frame(parent)
        form_frame.pack(fill='x', pady=10)
        
        # اسم المستخدم
        ttk.Label(form_frame, text="اسم المستخدم:",
                 font=("Arial", 12)).grid(row=0, column=0,
                                         padx=5, pady=10,
                                         sticky='e')
        
        self.username_entry = ttk.Entry(form_frame,
                                       font=("Arial", 12),
                                       width=25)
        self.username_entry.grid(row=0, column=1,
                                padx=5, pady=10,
                                sticky='w')
        
        # كلمة المرور
        ttk.Label(form_frame, text="كلمة المرور:",
                 font=("Arial", 12)).grid(row=1, column=0,
                                         padx=5, pady=10,
                                         sticky='e')
        
        self.password_entry = ttk.Entry(form_frame,
                                       show="*",
                                       font=("Arial", 12),
                                       width=25)
        self.password_entry.grid(row=1, column=1,
                                padx=5, pady=10,
                                sticky='w')
        
        # زر تسجيل الدخول
        login_button = tk.Button(parent,
                                text="تسجيل الدخول",
                                font=("Arial", 14, "bold"),
                                bg="#3498db",
                                fg="white",
                                activebackground="#2980b9",
                                cursor="hand2",
                                command=self.authenticate,
                                padx=30,
                                pady=8)
        login_button.pack(pady=30)
        
        # ربط زر Enter بتسجيل الدخول
        self.password_entry.bind('<Return>', lambda e: self.authenticate())
    
    def authenticate(self):
        """المصادقة"""
        username = self.username_entry.get().strip()
        password = self.password_entry.get().strip()
        
        if not username or not password:
            messagebox.showerror("خطأ", "يرجى إدخال اسم المستخدم وكلمة المرور")
            return
        
        # استدعاء دالة تسجيل الدخول من auth
        user = auth.login(username, password)

        if user and 'error' not in user:
            # إغلاق نافذة تسجيل الدخول
            self.window.destroy()

            # استيراد MainWindow بعد إغلاق نافذة تسجيل الدخول لتجنب الاستيراد الدائري
            from ui.main_window import MainWindow
            main_window = MainWindow(user)
            main_window.run()
        else:
            messagebox.showerror("خطأ", user['error'] if user and 'error' in user else "اسم المستخدم أو كلمة المرور غير صحيحة")
    
    def run(self):
        """تشغيل النافذة"""
        self.window.mainloop()

ملف main_window.py له الكود التالي
# ui/main_window.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime
from config.settings import APP_NAME, VERSION, COMPANY_NAME
from ui.archive_ui import ArchiveUI
from tkinter import filedialog
from utils.excel_handler import ExcelHandler
import os

logger = logging.getLogger(__name__)

class MainWindow:
    def __init__(self, user_data):
        self.user_data = user_data
        self.root = tk.Tk()
        self.root.title(f"{APP_NAME} v{VERSION}")
        self.root.state('zoomed')
        
        self.setup_styles()
        self.create_widgets()
        self.setup_menu()
        self.setup_statusbar()
        
        # تحميل لوحة التحكم كواجهة افتراضية
        self.show_dashboard()
    
    def setup_styles(self):
        """إعداد الأنماط"""
        self.style = ttk.Style()
        self.style.theme_use('clam')
        
        # تخصيص الأنماط
        self.style.configure('Title.TLabel', 
                           font=('Arial', 16, 'bold'),
                           background='#2c3e50',
                           foreground='white')
        
        self.style.configure('Header.TFrame',
                           background='#2c3e50')
        
        self.style.configure('Sidebar.TFrame',
                           background='#34495e')
        
        self.style.configure('Content.TFrame',
                           background='#ecf0f1')
        
        self.style.configure('Sidebar.TButton',
                           font=('Arial', 12),
                           background='#34495e',
                           foreground='white',
                           borderwidth=0)
        
        self.style.map('Sidebar.TButton',
                      background=[('active', '#3498db')])
    
    def create_widgets(self):
        """إنشاء عناصر الواجهة"""
        # الإطار الرئيسي
        self.main_frame = ttk.Frame(self.root)
        self.main_frame.pack(fill='both', expand=True)
        
        # رأس الصفحة
        self.create_header()
        
        # منطقة المحتوى
        self.create_content_area()
    
    def create_header(self):
        """إنشاء رأس الصفحة"""
        header_frame = ttk.Frame(self.main_frame, style='Header.TFrame')
        header_frame.pack(fill='x', pady=0)
        
        # العنوان
        title_label = ttk.Label(header_frame, 
                               text="مولدة الريان للطاقة الكهربائية",
                               style='Title.TLabel')
        title_label.pack(pady=15)
        
        # معلومات المستخدم
        user_frame = ttk.Frame(header_frame, style='Header.TFrame')
        user_frame.pack(side='right', padx=20)
        
        user_label = ttk.Label(user_frame,
                              text=f"👤 {self.user_data['full_name']} - {self.user_data['role']}",
                              style='Title.TLabel',
                              font=('Arial', 11))
        user_label.pack()
        
        time_label = ttk.Label(user_frame,
                              text=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                              style='Title.TLabel',
                              font=('Arial', 10))
        time_label.pack()
    
    def create_content_area(self):
        """إنشاء منطقة المحتوى"""
        # الشريط الجانبي
        self.sidebar_frame = ttk.Frame(self.main_frame, 
                                      style='Sidebar.TFrame',
                                      width=250)
        self.sidebar_frame.pack(side='left', fill='y')
        self.sidebar_frame.pack_propagate(False)
        
        # إضافة الأزرار الجانبية
        self.create_sidebar_buttons()
        
        # منطقة المحتوى الرئيسية
        self.content_frame = ttk.Frame(self.main_frame, 
                                      style='Content.TFrame')
        self.content_frame.pack(side='left', fill='both', expand=True)
    
    def create_sidebar_buttons(self):
        """إنشاء أزرار الشريط الجانبي"""
        modules = [
            ("🏠 الرئيسية", "dashboard"),
            ("👥 الزبائن", "customers"),
            ("🧾 الفواتير", "invoices"),
            ("📊 التقارير", "reports"),
            ("💰 المحاسبة", "accounting"),
            ("🗃️ الأرشيف", "archive"),
            ("🔄 مدير الاستيراد", "import_manager"),  # أضف هذا السطر هنا
            ("👤 المستخدمين", "users"),
            ("📝 سجل النشاط", "activity_log"),
            ("⚙️ الإعدادات", "settings"),
            ("🔄 النسخ الاحتياطي", "backup"),
            ("❌ خروج", "logout")
        ]
        
        for i, (text, command) in enumerate(modules):
            btn = ttk.Button(self.sidebar_frame,
                        text=text,
                        style='Sidebar.TButton',
                        command=lambda cmd=command: self.handle_sidebar_click(cmd))
            btn.pack(fill='x', padx=10, pady=5, ipady=10)

    def handle_sidebar_click(self, command):
        """معالجة النقر على أزرار الشريط الجانبي"""
        if command == "logout":
            self.logout()
        elif command == "dashboard":
            self.show_dashboard()
        elif command == "customers":
            self.show_customers_ui()
        elif command == "invoices":
            self.show_invoices_ui()
        elif command == "reports":
            self.show_reports_ui()
        elif command == "archive":
            if self.check_permission('view_archive'):
                self.show_archive_ui()
            else:
                messagebox.showerror("خطأ", "ليس لديك صلاحية الدخول إلى هذا القسم")
        elif command == "users":
            if self.check_permission('manage_users'):
                self.show_users_ui()
            else:
                messagebox.showerror("خطأ", "ليس لديك صلاحية الدخول إلى هذا القسم")
        elif command == "activity_log":
            if self.check_permission('view_activity_log'):
                self.show_activity_log_ui()
            else:
                messagebox.showerror("خطأ", "ليس لديك صلاحية الدخول إلى هذا القسم")
        elif command == "backup":
            self.perform_backup()
        elif command == "accounting":
            self.show_accounting_ui()
        elif command == "settings":
            if self.check_permission('manage_settings'):
                self.show_settings_ui()
            else:
                messagebox.showerror("خطأ", "ليس لديك صلاحية الدخول إلى هذا القسم")
         # ... الكود الحالي ...
        elif command == "import_manager":
            if self.check_permission('manage_import'):
                self.show_import_manager()
            else:
                messagebox.showerror("خطأ", "ليس لديك صلاحية الدخول إلى هذا القسم")

    def show_import_manager(self):
        """عرض واجهة مدير الاستيراد"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        from ui.import_manager import ImportManagerUI
        import_manager = ImportManagerUI(self.content_frame, self.user_data)
        
        # في ui/main_window.py في الدالة show_accounting_ui
    def show_accounting_ui(self):
        """عرض واجهة المحاسبة"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()

        try:
            from ui.accounting_ui import AccountingUI
            accounting_ui = AccountingUI(self.content_frame, self.user_data)
            accounting_ui.pack(fill='both', expand=True)
            logger.info("تم تحميل واجهة المحاسبة بنجاح")
        except ImportError as e:
            logger.error(f"خطأ في تحميل واجهة المحاسبة: {e}")
            self.show_simple_accounting_ui()
        
    def show_dashboard(self):
        """عرض لوحة التحكم"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        dashboard_frame = tk.Frame(self.content_frame, bg='white')
        dashboard_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = tk.Label(dashboard_frame,
                        text="لوحة التحكم - نظرة عامة",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=20)
        
        # عرض الإحصائيات
        self.show_simple_statistics(dashboard_frame)
        
        # عرض ميزات قيد التطوير
        self.show_coming_features(dashboard_frame)

    def show_archive_ui(self):
        """عرض واجهة الأرشيف"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        archive_ui = ArchiveUI(self.content_frame)
        logger.info("تم تحميل واجهة الأرشيف بنجاح")

    def show_users_ui(self):
        """عرض واجهة المستخدمين"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        try:
            # حاول استيراد user_management_ui أولاً
            from ui.user_management_ui import UsersUI
            users_ui = UsersUI(self.content_frame)
            logger.info("تم تحميل واجهة المستخدمين بنجاح")
        except ImportError:
            try:
                # إذا فشل، حاول استيراد users_ui
                from ui.users_ui import UsersUI
                users_ui = UsersUI(self.content_frame)
                logger.info("تم تحميل واجهة المستخدمين من users_ui")
            except ImportError as e:
                logger.error(f"خطأ في تحميل واجهة المستخدمين: {e}")
                # عرض واجهة بديلة
                self.show_simple_users_ui()

    def show_simple_users_ui(self):
        """عرض واجهة مستخدمين مبسطة"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        frame = tk.Frame(self.content_frame, bg='white')
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = tk.Label(frame, text="إدارة المستخدمين",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=10)
        
        msg = tk.Label(frame,
                      text="وحدة إدارة المستخدمين قيد التطوير\nسيتم إضافتها قريباً",
                      font=('Arial', 14),
                      bg='white', fg='#7f8c8d')
        msg.pack(pady=50)
        
        back_btn = tk.Button(frame, text="← العودة للرئيسية",
                           command=self.show_dashboard,
                           bg='#3498db', fg='white',
                           font=('Arial', 12))
        back_btn.pack(pady=20)

    def show_activity_log_ui(self):
        """عرض واجهة سجل النشاط"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        try:
            from ui.activity_log_ui import ActivityLogUI
            activity_ui = ActivityLogUI(self.content_frame)
            logger.info("تم تحميل واجهة سجل النشاط بنجاح")
        except ImportError as e:
            logger.error(f"خطأ في تحميل سجل النشاط: {e}")
            self.show_simple_activity_log_ui()

    def show_simple_activity_log_ui(self):
        """عرض واجهة سجل نشاط مبسطة"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        frame = tk.Frame(self.content_frame, bg='white')
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = tk.Label(frame, text="سجل النشاط",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=10)
        
        msg = tk.Label(frame,
                      text="وحدة سجل النشاط قيد التطوير\nسيتم إضافتها قريباً",
                      font=('Arial', 14),
                      bg='white', fg='#7f8c8d')
        msg.pack(pady=50)
        
        back_btn = tk.Button(frame, text="← العودة للرئيسية",
                           command=self.show_dashboard,
                           bg='#3498db', fg='white',
                           font=('Arial', 12))
        back_btn.pack(pady=20)

    def show_settings_ui(self):
        """عرض واجهة الإعدادات"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        try:
            from ui.settings_ui import SettingsUI
            settings_ui = SettingsUI(self.content_frame)
            logger.info("تم تحميل واجهة الإعدادات بنجاح")
        except ImportError as e:
            logger.error(f"خطأ في تحميل الإعدادات: {e}")
            self.show_simple_settings_ui()

    def show_simple_settings_ui(self):
        """عرض واجهة إعدادات مبسطة"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        frame = tk.Frame(self.content_frame, bg='white')
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = tk.Label(frame, text="الإعدادات",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=10)
        
        msg = tk.Label(frame,
                      text="وحدة الإعدادات قيد التطوير\nسيتم إضافتها قريباً",
                      font=('Arial', 14),
                      bg='white', fg='#7f8c8d')
        msg.pack(pady=50)
        
        back_btn = tk.Button(frame, text="← العودة للرئيسية",
                           command=self.show_dashboard,
                           bg='#3498db', fg='white',
                           font=('Arial', 12))
        back_btn.pack(pady=20)
        
    def show_simple_statistics(self, parent):
        """عرض إحصائيات مبسطة"""
        stats_frame = tk.Frame(parent, bg='white')
        stats_frame.pack(fill='x', pady=20)
        
        try:
            from modules.reports import ReportManager
            reports = ReportManager()
            statistics = reports.get_dashboard_statistics()
        except ImportError as e:
            logger.warning(f"وحدة التقارير غير متوفرة: {e}")
            # إحصائيات تجريبية
            statistics = {
                "إجمالي الزبائن": "150",
                "الفواتير اليوم": "25",
                "المبلغ اليوم": "1,250,000 ل.س",
                "الرصيد السالب": "12",
                "الرصيد الموجب": "138",
                "الفواتير الشهر": "500",
                "المبلغ الشهري": "25,000,000 ل.س",
                "المتوسط اليومي": "833,333 ل.س"
            }
        
        # عرض الإحصائيات في شكل بطاقات
        for i, (title, value) in enumerate(statistics.items()):
            card = self.create_stat_card(stats_frame, title, value)
            card.grid(row=i//4, column=i%4, padx=10, pady=10, sticky='nsew')
            
        for i in range(4):
            stats_frame.columnconfigure(i, weight=1)
    
    def create_stat_card(self, parent, title, value):
        """إنشاء بطاقة إحصائية"""
        card_frame = tk.Frame(parent, bg='#f8f9fa', relief='raised', borderwidth=1)
        
        title_label = tk.Label(card_frame, text=title,
                              font=('Arial', 12, 'bold'),
                              bg='#f8f9fa', fg='#495057')
        title_label.pack(pady=(10, 5))
        
        value_label = tk.Label(card_frame, text=str(value),
                              font=('Arial', 14, 'bold'),
                              bg='#f8f9fa', fg='#2c3e50')
        value_label.pack(pady=(5, 10))
        
        return card_frame
    
    def show_coming_features(self, parent):
        """عرض الميزات القادمة"""
        features_frame = tk.Frame(parent, bg='white')
        features_frame.pack(fill='x', pady=30)
        
        tk.Label(features_frame, 
                text="الميزات قيد التطوير:",
                font=('Arial', 16, 'bold'),
                bg='white', fg='#2c3e50').pack(pady=10)
        
        features = [
            "✅ إدارة الزبائن المتكاملة",
            "✅ نظام الفواتير والطباعة",
            "✅ التقارير والإحصائيات",
            "✅ نظام الصلاحيات المتقدم",
            "✅ النسخ الاحتياطي التلقائي",
            "⏳ نظام المحاسبة المتكامل",
            "⏳ سجل النشاط التفصيلي",
            "⏳ إدارة المستخدمين"
        ]
        
        for feature in features:
            tk.Label(features_frame, 
                    text=f"• {feature}",
                    font=('Arial', 12),
                    bg='white', fg='#7f8c8d',
                    anchor='w').pack(fill='x', padx=20, pady=2)
    
    def show_simple_customers_ui(self):
        """عرض واجهة زبائن مبسطة"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        frame = tk.Frame(self.content_frame, bg='white')
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = tk.Label(frame, text="إدارة الزبائن",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=10)
        
        msg = tk.Label(frame,
                      text="عذراً، واجهة الزبائن الرئيسية غير متاحة حالياً.\nسيتم إضافتها قريباً.",
                      font=('Arial', 14),
                      bg='white', fg='#7f8c8d')
        msg.pack(pady=50)
        
        back_btn = tk.Button(frame, text="← العودة للرئيسية",
                           command=self.show_dashboard,
                           bg='#3498db', fg='white',
                           font=('Arial', 12))
        back_btn.pack(pady=20)
    
    def show_simple_invoices_ui(self):
        """عرض واجهة فواتير مبسطة"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        frame = tk.Frame(self.content_frame, bg='white')
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = tk.Label(frame, text="إدارة الفواتير",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=10)
        
        msg = tk.Label(frame,
                      text="عذراً، واجهة الفواتير الرئيسية غير متاحة حالياً.\nسيتم إضافتها قريباً.",
                      font=('Arial', 14),
                      bg='white', fg='#7f8c8d')
        msg.pack(pady=50)
        
        back_btn = tk.Button(frame, text="← العودة للرئيسية",
                           command=self.show_dashboard,
                           bg='#3498db', fg='white',
                           font=('Arial', 12))
        back_btn.pack(pady=20)
    
    def show_simple_report_ui(self):
        """عرض واجهة تقارير مبسطة"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        frame = tk.Frame(self.content_frame, bg='white')
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = tk.Label(frame, text="التقارير والإحصائيات",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=10)
        
        msg = tk.Label(frame,
                      text="عذراً، واجهة التقارير الرئيسية غير متاحة حالياً.\nسيتم إضافتها قريباً.",
                      font=('Arial', 14),
                      bg='white', fg='#7f8c8d')
        msg.pack(pady=50)
        
        back_btn = tk.Button(frame, text="← العودة للرئيسية",
                           command=self.show_dashboard,
                           bg='#3498db', fg='white',
                           font=('Arial', 12))
        back_btn.pack(pady=20)
    
    def show_customers_ui(self):
        """عرض واجهة الزبائن"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
    
        try:
            from ui.customer_ui import CustomerUI
            customer_ui = CustomerUI(self.content_frame, self.user_data)
            customer_ui.pack(fill='both', expand=True)
        
            logger.info("تم تحميل واجهة الزبائن بنجاح")
        
        except ImportError as e:
            logger.error(f"خطأ في تحميل واجهة الزبائن: {e}")
            # عرض واجهة بديلة
            self.show_simple_customers_ui()
    
    def show_invoices_ui(self):
        """عرض واجهة الفواتير"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
    
        try:
            from ui.invoice_ui import InvoiceUI
            invoice_ui = InvoiceUI(self.content_frame, self.user_data)
            invoice_ui.pack(fill='both', expand=True)
        
            logger.info("تم تحميل واجهة الفواتير بنجاح")
        
        except ImportError as e:
            logger.error(f"خطأ في تحميل واجهة الفواتير: {e}")
            # عرض واجهة بديلة
            self.show_simple_invoices_ui()
    
    def show_reports_ui(self):
        """عرض واجهة التقارير"""
        for widget in self.content_frame.winfo_children():
            widget.destroy()
        
        try:
            from ui.report_ui import ReportUI
            report_ui = ReportUI(self.content_frame, self.user_data)
            report_ui.pack(fill='both', expand=True)
        
            logger.info("تم تحميل واجهة التقارير بنجاح")
        
        except ImportError as e:
            logger.error(f"خطأ في تحميل واجهة التقارير: {e}")
            # عرض واجهة بديلة
            self.show_simple_report_ui()
    
    def check_permission(self, permission_name):
        """التحقق من صلاحية المستخدم"""
        # الأدوار والصلاحيات الافتراضية
        role_permissions = {
            'admin': ['manage_users', 'view_activity_log', 'add_invoice', 
                    'edit_invoice', 'delete_invoice', 'manage_customers', 
                    'view_reports', 'manage_settings', 'export_data', 'import_data',
                    'view_archive', 'manage_backup'],
            'accountant': ['add_invoice', 'edit_invoice', 'manage_customers', 
                          'view_reports', 'export_data', 'import_data'],
            'cashier': ['view_invoices', 'view_customers', 'add_payment'],
            'viewer': ['view_reports', 'view_customers']
        }
        
        user_role = self.user_data.get('role', 'viewer')
        
        # تسجيل محاولة الوصول (باستخدام get لتجنب KeyError)
        username = self.user_data.get('username', 'غير معروف')
        if not username or username == 'غير معروف':
            username = self.user_data.get('full_name', 'مستخدم')
        
        logger.info(f"التحقق من الصلاحية: {permission_name} للمستخدم: {username}، الدور: {user_role}")
        
        # إذا كان admin، يعود True لكل الصلاحيات
        if user_role == 'admin':
            return True
        
        # خلاف ذلك، يتحقق من الصلاحيات
        user_permissions = role_permissions.get(user_role, [])
        return permission_name in user_permissions

    def perform_backup(self):
        """تنفيذ النسخ الاحتياطي"""
        try:
            from modules.archive import ArchiveManager
            archive = ArchiveManager()
            result = archive.perform_backup()
            
            if result.get('success'):
                messagebox.showinfo("نجاح", result['message'])
            else:
                messagebox.showerror("خطأ", result.get('error', 'فشل النسخ الاحتياطي'))
                
        except ImportError as e:
            logger.error(f"خطأ في تحميل وحدة الأرشيف: {e}")
            messagebox.showinfo("نسخ احتياطي", 
                              "تم إجراء نسخ احتياطي بسيط\nسيتم تطوير النظام الكامل قريباً")
    
    def logout(self):
        """تسجيل الخروج"""
        if messagebox.askyesno("تأكيد", "هل تريد تسجيل الخروج؟"):
            self.root.destroy()
    
    def setup_menu(self):
        """إعداد القوائم"""
        menubar = tk.Menu(self.root)
        self.root.config(menu=menubar)
        
        # قائمة ملف
        file_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="ملف", menu=file_menu)
        file_menu.add_command(label="📥 مدير الاستيراد المتقدم", command=self.show_import_manager)  # ← أضف هذا السطر
        file_menu.add_command(label="📤 تصدير البيانات", command=self.export_data)
        file_menu.add_command(label="📥 استيراد البيانات", command=self.import_data)
        file_menu.add_separator()
        file_menu.add_command(label="خروج", command=self.root.quit)
        # قائمة عرض
        view_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="عرض", menu=view_menu)
        view_menu.add_command(label="تحديث", command=self.refresh)
        
        # قائمة مساعدة
        help_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="مساعدة", menu=help_menu)
        help_menu.add_command(label="دليل المستخدم", command=self.show_help)
        help_menu.add_command(label="عن البرنامج", command=self.about)
    
    def setup_statusbar(self):
        """إعداد شريط الحالة"""
        self.statusbar = tk.Frame(self.root, bg='#2c3e50', height=30)
        self.statusbar.pack(side='bottom', fill='x')
        self.statusbar.pack_propagate(False)
        
        status_label = tk.Label(self.statusbar,
                                text=f"{APP_NAME} - جاهز",
                                bg='#2c3e50', fg='white',
                                font=('Arial', 9))
        status_label.pack(side='left', padx=10)
        
        # تحديث الوقت تلقائياً
        self.update_time()
    
    def update_time(self):
        """تحديث الوقت"""
        for widget in self.statusbar.winfo_children():
            if isinstance(widget, tk.Label) and ":" in widget.cget("text"):
                current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                widget.config(text=current_time)
                break
        else:
            time_label = tk.Label(self.statusbar,
                                 text=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                                 bg='#2c3e50', fg='white',
                                 font=('Arial', 9))
            time_label.pack(side='right', padx=10)
        
        self.root.after(1000, self.update_time)
    
    def export_data(self):
        """تصدير البيانات إلى Excel"""
        try:
            # نافذة اختيار نوع البيانات للتصدير
            export_dialog = ExportDialog(self.root)
            self.root.wait_window(export_dialog)
            
            if export_dialog.export_type and export_dialog.data_to_export:
                # اختيار مكان الحفظ
                filename = filedialog.asksaveasfilename(
                    defaultextension=".xlsx",
                    filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")],
                    title="حفظ ملف Excel"
                )
                
                if filename:
                    # التصدير الفعلي
                    ExcelHandler.export_to_excel(
                        export_dialog.data_to_export,
                        filename,
                        sheet_name=export_dialog.export_type
                    )
                    messagebox.showinfo("نجاح", f"تم تصدير البيانات إلى:\n{filename}")
                    
        except Exception as e:
            logger.error(f"خطأ في تصدير البيانات: {e}")
            messagebox.showerror("خطأ", f"فشل تصدير البيانات: {str(e)}")

    
    def import_data(self):
        """استيراد بيانات من ملف Excel"""
        try:
            filename = filedialog.askopenfilename(
                filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")],
                title="اختر ملف Excel"
            )
            
            if filename:
                data = ExcelHandler.import_from_excel(filename)
                messagebox.showinfo("نجاح", 
                                f"تم استيراد {len(data)} سجل\n"
                                f"الأعمدة: {list(data[0].keys()) if data else 'لا توجد بيانات'}")
                
        except Exception as e:
            messagebox.showerror("خطأ", f"فشل الاستيراد: {str(e)}")

    def refresh(self):
        """تحديث البيانات"""
        current_view = str(self.content_frame.winfo_children()[0]) if self.content_frame.winfo_children() else ""
        if "dashboard" in current_view:
            self.show_dashboard()
        messagebox.showinfo("تحديث", "تم تحديث البيانات")
    
    def show_help(self):
        """عرض دليل المستخدم"""
        help_text = f"""
دليل استخدام {APP_NAME}

1. لوحة التحكم: نظرة عامة على النظام
2. الزبائن: إدارة بيانات الزبائن
3. الفواتير: إنشاء وإدارة الفواتير
4. التقارير: إحصائيات وتحليلات
5. المستخدمين: إدارة حسابات المستخدمين
6. سجل النشاط: تتبع جميع العمليات
7. النسخ الاحتياطي: حفظ واستعادة البيانات

الإصدار: {VERSION}
        """
        messagebox.showinfo("دليل المستخدم", help_text)
    
    def about(self):
        """عرض معلومات عن البرنامج"""
        about_text = f"""
{APP_NAME}

إصدار: {VERSION}
الشركة: {COMPANY_NAME}

نظام متكامل لإدارة فواتير الكهرباء
مطور بلغة Python مع واجهة حديثة

المميزات:
• قاعدة بيانات PostgreSQL آمنة
• نظام صلاحيات متعدد المستويات
• تقارير وإحصائيات متقدمة
• نسخ احتياطي تلقائي
• واجهة مستخدم عربية

حقوق النشر © 2025
جميع الحقوق محفوظة
        """
        messagebox.showinfo("عن البرنامج", about_text)
    
    def run(self):
        """تشغيل النافذة"""
        self.root.mainloop()

ملف report_ui.py له الكود التالي
# ui/report_ui.py
import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import logging
from datetime import datetime, timedelta
from modules.reports import ReportManager
import webbrowser
import os

logger = logging.getLogger(__name__)

class ReportUI(tk.Frame):
    """واجهة التقارير والإحصائيات"""
    
    def __init__(self, parent, user_data):
        super().__init__(parent)
        self.user_data = user_data
        self.report_manager = ReportManager()
        self.current_report = None
        self.create_widgets()
    
    def create_widgets(self):
        # قسم اختيار نوع التقرير
        report_type_frame = tk.LabelFrame(self, text="نوع التقرير", padx=10, pady=10)
        report_type_frame.pack(fill='x', padx=10, pady=10)
        
        # أزرار أنواع التقارير
        report_types = [
            ("📊 لوحة التحكم", self.show_dashboard_report),
            ("👥 تقرير الزبائن", self.show_customer_report),
            ("💰 تقرير الرصيد", self.show_balance_report),
            ("🧾 تقرير الفواتير", self.show_invoice_report),
            ("📈 تقرير المبيعات", self.show_sales_report),
            ("📅 المبيعات اليومية", self.show_daily_sales),
            ("🏢 تقرير القطاعات", self.show_sector_report)
        ]
        
        for i, (text, command) in enumerate(report_types):
            btn = tk.Button(report_type_frame, text=text, command=command,
                          width=15, height=2, bg='#3498db', fg='white')
            btn.grid(row=i//4, column=i%4, padx=5, pady=5, sticky='nsew')
        
        # إطار الفلاتر والتاريخ
        self.filter_frame = tk.LabelFrame(self, text="فلاتر التقرير", padx=10, pady=10)
        self.filter_frame.pack(fill='x', padx=10, pady=10)
        
        # تاريخ البداية
        tk.Label(self.filter_frame, text="من تاريخ:").grid(row=0, column=0, padx=5, pady=5)
        self.start_date_entry = tk.Entry(self.filter_frame, width=12)
        self.start_date_entry.grid(row=0, column=1, padx=5, pady=5)
        self.start_date_entry.insert(0, (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d"))
        
        # تاريخ النهاية
        tk.Label(self.filter_frame, text="إلى تاريخ:").grid(row=0, column=2, padx=5, pady=5)
        self.end_date_entry = tk.Entry(self.filter_frame, width=12)
        self.end_date_entry.grid(row=0, column=3, padx=5, pady=5)
        self.end_date_entry.insert(0, datetime.now().strftime("%Y-%m-%d"))
        
        # زر تطبيق الفلاتر
        tk.Button(self.filter_frame, text="تطبيق الفلاتر", 
                 command=self.apply_filters, bg='#27ae60', fg='white').grid(row=0, column=4, padx=10)
        
        # زر تصدير
        tk.Button(self.filter_frame, text="📥 تصدير إلى Excel", 
                 command=self.export_report, bg='#f39c12', fg='white').grid(row=0, column=5, padx=5)
        
        # زر طباعة
        tk.Button(self.filter_frame, text="🖨️ طباعة التقرير", 
                 command=self.print_report, bg='#9b59b6', fg='white').grid(row=0, column=6, padx=5)
        
        # منطقة عرض التقرير
        report_display_frame = tk.Frame(self)
        report_display_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        # إنشاء Notebook (تبويبات) لعرض التقارير
        self.notebook = ttk.Notebook(report_display_frame)
        self.notebook.pack(fill='both', expand=True)
        
        # تبويب النتائج
        self.results_frame = tk.Frame(self.notebook)
        self.notebook.add(self.results_frame, text="النتائج")
        
        # تبويب الإحصائيات
        self.stats_frame = tk.Frame(self.notebook)
        self.notebook.add(self.stats_frame, text="الإحصائيات")
        
        # تبويب الرسوم البيانية
        self.charts_frame = tk.Frame(self.notebook)
        self.notebook.add(self.charts_frame, text="الرسوم البيانية")
        
        # عرض لوحة التحكم افتراضياً
        self.show_dashboard_report()
    
    def show_dashboard_report(self):
        """عرض تقرير لوحة التحكم"""
        try:
            report = self.report_manager.get_dashboard_statistics()
            self.current_report = report
            
            # مسح الإطارات السابقة
            self.clear_frames()
            
            # عرض النتائج
            self.display_dashboard_results(report)
            
        except Exception as e:
            logger.error(f"خطأ في عرض تقرير لوحة التحكم: {e}")
            messagebox.showerror("خطأ", f"فشل تحميل التقرير: {str(e)}")
    
    def show_customer_report(self):
        """عرض تقرير الزبائن"""
        try:
            report = self.report_manager.get_customers_by_sector_report()
            self.current_report = report
            
            self.clear_frames()
            self.display_customer_report(report)
            
        except Exception as e:
            logger.error(f"خطأ في عرض تقرير الزبائن: {e}")
    
    def show_balance_report(self):
        """عرض تقرير الرصيد"""
        # نافذة اختيار نوع الرصيد
        balance_dialog = BalanceTypeDialog(self)
        self.wait_window(balance_dialog)
        
        if balance_dialog.balance_type:
            try:
                report = self.report_manager.get_customer_balance_report(balance_dialog.balance_type)
                self.current_report = report
                
                self.clear_frames()
                self.display_balance_report(report)
                
            except Exception as e:
                logger.error(f"خطأ في عرض تقرير الرصيد: {e}")
    
    def show_invoice_report(self):
        """عرض تقرير الفواتير"""
        try:
            start_date = self.start_date_entry.get()
            end_date = self.end_date_entry.get()
            
            report = self.report_manager.get_invoice_detailed_report(start_date, end_date)
            self.current_report = report
            
            self.clear_frames()
            self.display_invoice_report(report)
            
        except Exception as e:
            logger.error(f"خطأ في عرض تقرير الفواتير: {e}")
    
    def show_sales_report(self):
        """عرض تقرير المبيعات"""
        # نافذة اختيار نوع التجميع
        sales_dialog = SalesGroupDialog(self)
        self.wait_window(sales_dialog)
        
        if sales_dialog.group_by:
            try:
                start_date = self.start_date_entry.get()
                end_date = self.end_date_entry.get()
                
                report = self.report_manager.get_sales_report(start_date, end_date, sales_dialog.group_by)
                self.current_report = report
                
                self.clear_frames()
                self.display_sales_report(report)
                
            except Exception as e:
                logger.error(f"خطأ في عرض تقرير المبيعات: {e}")
    
    def show_daily_sales(self):
        """عرض تقرير المبيعات اليومية"""
        try:
            report = self.report_manager.get_daily_sales_summary()
            self.current_report = report
            
            self.clear_frames()
            self.display_daily_sales(report)
            
        except Exception as e:
            logger.error(f"خطأ في عرض تقرير المبيعات اليومية: {e}")
    
    def show_sector_report(self):
        """عرض تقرير القطاعات"""
        try:
            report = self.report_manager.get_customers_by_sector_report()
            self.current_report = report
            
            self.clear_frames()
            self.display_sector_report(report)
            
        except Exception as e:
            logger.error(f"خطأ في عرض تقرير القطاعات: {e}")
    
    def apply_filters(self):
        """تطبيق الفلاتر على التقرير الحالي"""
        messagebox.showinfo("تطبيق الفلاتر", "تم تطبيق الفلاتر بنجاح")
    
    def export_report(self):
        """تصدير التقرير الحالي إلى Excel"""
        if not self.current_report:
            messagebox.showwarning("تحذير", "لا يوجد تقرير للتصدير")
            return
        
        try:
            # تحديد نوع التقرير للتصدير
            report_type = "report"
            if 'report_type' in self.current_report:
                report_type = self.current_report['report_type']
            elif 'group_by' in self.current_report:
                report_type = f"sales_{self.current_report['group_by']}"
            
            filename = self.report_manager.export_report_to_excel(self.current_report, report_type)
            
            if filename and os.path.exists(filename):
                messagebox.showinfo("نجاح", f"تم تصدير التقرير إلى:\n{filename}")
                
                # فتح الملف
                try:
                    webbrowser.open(filename)
                except:
                    pass
            else:
                messagebox.showerror("خطأ", "فشل تصدير التقرير")
                
        except Exception as e:
            logger.error(f"خطأ في تصدير التقرير: {e}")
            messagebox.showerror("خطأ", f"فشل تصدير التقرير: {str(e)}")
    
    def print_report(self):
        """طباعة التقرير"""
        if not self.current_report:
            messagebox.showwarning("تحذير", "لا يوجد تقرير للطباعة")
            return
        
        messagebox.showinfo("طباعة", "سيتم إرسال التقرير إلى الطابعة")
        # هنا يمكن إضافة منطق الطباعة الفعلي
    
    def clear_frames(self):
        """مسح محتوى الإطارات"""
        for widget in self.results_frame.winfo_children():
            widget.destroy()
        
        for widget in self.stats_frame.winfo_children():
            widget.destroy()
        
        for widget in self.charts_frame.winfo_children():
            widget.destroy()
    
    def display_dashboard_results(self, report):
        """عرض نتائج لوحة التحكم"""
        # النتائج
        results_text = tk.Text(self.results_frame, wrap='word', height=20)
        results_text.pack(fill='both', expand=True, padx=10, pady=10)
        
        text = f"""
        {'='*50}
        لوحة التحكم - إحصائيات النظام
        {'='*50}
        
        الزبائن:
        --------
        • إجمالي الزبائن: {report.get('total_customers', 0):,}
        • زبائن برصيد سالب: {report.get('negative_count', 0):,} ({abs(report.get('negative_total', 0)):,.0f} كيلو واط)
        • زبائن برصيد موجب: {report.get('positive_count', 0):,} ({report.get('positive_total', 0):,.0f} كيلو واط)
        
        المبيعات:
        ---------
        • الفواتير اليوم: {report.get('today_invoices', 0):,} فاتورة
        • إجمالي اليوم: {report.get('today_amount', 0):,.0f} ل.س
        • الفواتير الشهرية: {report.get('month_invoices', 0):,} فاتورة
        • إجمالي الشهر: {report.get('month_amount', 0):,.0f} ل.س
        
        أفضل القطاعات أداءً هذا الشهر:
        --------------------------
        """
        
        for sector in report.get('top_sectors', []):
            text += f"• {sector['name']}: {sector['invoice_count']} فاتورة ({sector['total_amount']:,.0f} ل.س)\n"
        
        text += f"\nتم الإنشاء: {report.get('generated_at', '')}"
        
        results_text.insert('1.0', text)
        results_text.config(state='disabled')
        
        # الإحصائيات
        stats_text = tk.Text(self.stats_frame, wrap='word')
        stats_text.pack(fill='both', expand=True, padx=10, pady=10)
        
        stats = f"""
        الإحصائيات:
        -----------
        
        متوسط قيمة الفاتورة اليومية: {report.get('today_amount', 0) / max(report.get('today_invoices', 1), 1):,.0f} ل.س
        متوسط قيمة الفاتورة الشهرية: {report.get('month_amount', 0) / max(report.get('month_invoices', 1), 1):,.0f} ل.س
        
        نسبة الزبائن برصيد سالب: {(report.get('negative_count', 0) / max(report.get('total_customers', 1), 1) * 100):.1f}%
        نسبة الزبائن برصيد موجب: {(report.get('positive_count', 0) / max(report.get('total_customers', 1), 1) * 100):.1f}%
        
        صافي الرصيد: {(report.get('positive_total', 0) + report.get('negative_total', 0)):,.0f} ل.س
        """
        
        stats_text.insert('1.0', stats)
        stats_text.config(state='disabled')
    
    def display_balance_report(self, report):
        """عرض تقرير الرصيد"""
        # إنشاء Treeview لعرض الزبائن
        tree_frame = tk.Frame(self.results_frame)
        tree_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        columns = ('ID', 'الاسم', 'القطاع', 'الرصيد', 'الحالة', 'الهاتف')
        
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings')
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=100)
        
        tree.column('الاسم', width=150)
        
        # إضافة البيانات
        for customer in report.get('customers', []):
            balance = customer['current_balance']
            status = 'سالب' if balance < 0 else 'موجب' if balance > 0 else 'صفر'
            
            tree.insert('', 'end', values=(
                customer['id'],
                customer['name'],
                customer.get('sector_name', ''),
                f"{balance:,.0f}",
                status,
                customer.get('phone_number', '')
            ))
        
        # شريط التمرير
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # عرض الإحصائيات
        stats_text = tk.Text(self.stats_frame, wrap='word')
        stats_text.pack(fill='both', expand=True, padx=10, pady=10)
        
        stats = f"""
        تقرير الرصيد ({report.get('report_type', 'all')})
        {'='*50}
        
        إجمالي الزبائن: {report.get('total_count', 0):,}
        إجمالي الرصيد: {report.get('total_balance', 0):,.0f} كيلو واط
        إجمالي الرصيد السالب: {report.get('negative_total', 0):,.0f} كيلو واط
        إجمالي الرصيد الموجب: {report.get('positive_total', 0):,.0f} كيلو واط
        صافي الرصيد: {(report.get('positive_total', 0) + report.get('negative_total', 0)):,.0f} كيلو واط
        
        
        تم الإنشاء: {report.get('generated_at', '')}
        """
        
        stats_text.insert('1.0', stats)
        stats_text.config(state='disabled')
    
    def display_invoice_report(self, report):
        """عرض تقرير الفواتير"""
        # Treeview للفواتير
        tree_frame = tk.Frame(self.results_frame)
        tree_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        columns = ('الرقم', 'التاريخ', 'الزبون', 'القطاع', 'الكيلوات', 'المبلغ', 'المحاسب')
        
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings')
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=100)
        
        tree.column('الزبون', width=150)
        tree.column('الرقم', width=120)
        
        # إضافة البيانات
        for invoice in report.get('invoices', []):
            tree.insert('', 'end', values=(
                invoice['invoice_number'],
                invoice['payment_date'],
                invoice['customer_name'],
                invoice.get('sector_name', ''),
                f"{invoice.get('kilowatt_amount', 0):.1f}",
                f"{invoice.get('total_amount', 0):,.0f}",
                invoice.get('accountant_name', '')
            ))
        
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # الإحصائيات
        stats_text = tk.Text(self.stats_frame, wrap='word')
        stats_text.pack(fill='both', expand=True, padx=10, pady=10)
        
        stats = f"""
        تقرير الفواتير
        {'='*50}
        
        الفترة: من {report['period']['start_date']} إلى {report['period']['end_date']}
        إجمالي الفواتير: {report.get('total_count', 0):,}
        
        تم الإنشاء: {report.get('generated_at', '')}
        """
        
        stats_text.insert('1.0', stats)
        stats_text.config(state='disabled')
    
    def display_sales_report(self, report):
        """عرض تقرير المبيعات"""
        # Treeview للمبيعات
        tree_frame = tk.Frame(self.results_frame)
        tree_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        columns = ('الفترة', 'عدد الفواتير', 'إجمالي المبلغ', 'إجمالي الكيلوات', 'متوسط الفاتورة')
        
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings')
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=120)
        
        # إضافة البيانات
        for data in report.get('sales_data', []):
            avg_amount = data.get('average_amount', 0)
            tree.insert('', 'end', values=(
                data['period'],
                data.get('invoice_count', 0),
                f"{data.get('total_amount', 0):,.0f}",
                f"{data.get('total_kilowatts', 0):.1f}",
                f"{avg_amount:,.0f}" if avg_amount else '0'
            ))
        
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
        
        # الإحصائيات
        stats_text = tk.Text(self.stats_frame, wrap='word')
        stats_text.pack(fill='both', expand=True, padx=10, pady=10)
        
        totals = report.get('totals', {})
        stats = f"""
        تقرير المبيعات ({report.get('group_by', 'daily')})
        {'='*50}
        
        الفترة: من {report['period']['start_date']} إلى {report['period']['end_date']}
        
        الإجماليات:
        • عدد الفواتير: {totals.get('total_invoices', 0):,}
        • إجمالي المبلغ: {totals.get('grand_total', 0):,.0f} ل.س
        • إجمالي الكيلوات: {totals.get('total_kilowatts', 0):.1f}
        • إجمالي الخصم: {totals.get('total_discount', 0):,.0f} ل.س
        
        المتوسطات:
        • متوسط الفاتورة: {totals.get('grand_total', 0) / max(totals.get('total_invoices', 1), 1):,.0f} ل.س
        • متوسط الكيلوات/فاتورة: {totals.get('total_kilowatts', 0) / max(totals.get('total_invoices', 1), 1):.1f}
        
        تم الإنشاء: {report.get('generated_at', '')}
        """
        
        stats_text.insert('1.0', stats)
        stats_text.config(state='disabled')
    
    def display_daily_sales(self, report):
        """عرض تقرير المبيعات اليومية"""
        # النتائج
        results_text = tk.Text(self.results_frame, wrap='word')
        results_text.pack(fill='both', expand=True, padx=10, pady=10)
        
        today = report.get('today', {})
        yesterday = report.get('yesterday', {})
        
        text = f"""
        تقرير المبيعات اليومية
        {'='*50}
        
        التاريخ: {report.get('date', '')}
        
        أداء اليوم:
        • عدد الفواتير: {today.get('invoice_count', 0):,}
        • إجمالي المبلغ: {today.get('total_amount', 0):,.0f} ل.س
        • إجمالي الكيلوات: {today.get('total_kilowatts', 0):.1f}
        • متوسط الفاتورة: {today.get('average_amount', 0):,.0f} ل.س
        
        المقارنة مع الأمس:
        • عدد فواتير الأمس: {yesterday.get('invoice_count', 0):,}
        • إجمالي أمس: {yesterday.get('total_amount', 0):,.0f} ل.س
        • نسبة التغير: {report.get('change_percentage', 0):.1f}%
        
        أفضل 5 زبائن اليوم:
        -----------------
        """
        
        for i, customer in enumerate(report.get('top_customers', []), 1):
            text += f"{i}. {customer['customer_name']} ({customer.get('sector_name', '')}): "
            text += f"{customer['invoice_count']} فواتير، {customer['total_amount']:,.0f} ل.س\n"
        
        text += f"\nتم الإنشاء: {report.get('generated_at', '')}"
        
        results_text.insert('1.0', text)
        results_text.config(state='disabled')
    
    def display_sector_report(self, report):
        """عرض تقرير القطاعات"""
        # Treeview للقطاعات
        tree_frame = tk.Frame(self.results_frame)
        tree_frame.pack(fill='both', expand=True, padx=10, pady=10)
        
        columns = ('القطاع', 'عدد الزبائن', 'إجمالي الرصيد', 'متوسط الرصيد', 'سالب', 'موجب', 'صفر')
        
        tree = ttk.Treeview(tree_frame, columns=columns, show='headings')
        
        for col in columns:
            tree.heading(col, text=col)
            tree.column(col, width=100)
        
        tree.column('القطاع', width=150)
        
        # إضافة البيانات
        for sector in report.get('sectors', []):
            tree.insert('', 'end', values=(
                sector['sector_name'],
                sector.get('customer_count', 0),
                f"{sector.get('total_balance', 0):,.0f}",
                f"{sector.get('average_balance', 0):,.0f}",
                sector.get('negative_count', 0),
                sector.get('positive_count', 0),
                sector.get('zero_count', 0)
            ))
        
        scrollbar = ttk.Scrollbar(tree_frame, orient='vertical', command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')

class BalanceTypeDialog(tk.Toplevel):
    """نافذة اختيار نوع تقرير الرصيد"""
    
    def __init__(self, parent):
        super().__init__(parent)
        self.title("اختر نوع تقرير الرصيد")
        self.geometry("300x200")
        self.balance_type = None
        
        self.create_widgets()
        self.center_window()
    
    def center_window(self):
        """توسيط النافذة"""
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f'{width}x{height}+{x}+{y}')
    
    def create_widgets(self):
        """إنشاء عناصر الواجهة"""
        main_frame = tk.Frame(self, padx=20, pady=20)
        main_frame.pack(fill='both', expand=True)
        
        tk.Label(main_frame, text="اختر نوع تقرير الرصيد:", 
                font=('Arial', 12, 'bold')).pack(pady=(0, 20))
        
        balance_types = [
            ("الكل", "all"),
            ("رصيد سالب فقط", "negative"),
            ("رصيد موجب فقط", "positive"),
            ("رصيد صفر فقط", "zero")
        ]
        
        self.selected_type = tk.StringVar(value="all")
        
        for text, value in balance_types:
            rb = tk.Radiobutton(main_frame, text=text, variable=self.selected_type,
                              value=value, font=('Arial', 10))
            rb.pack(anchor='w', pady=5)
        
        btn_frame = tk.Frame(main_frame, pady=20)
        btn_frame.pack(fill='x')
        
        tk.Button(btn_frame, text="موافق", command=self.on_ok,
                 bg='#27ae60', fg='white').pack(side='right', padx=5)
        tk.Button(btn_frame, text="إلغاء", command=self.cancel,
                 bg='#e74c3c', fg='white').pack(side='right')
    
    def on_ok(self):
        """معالجة زر موافق"""
        self.balance_type = self.selected_type.get()
        self.destroy()
    
    def cancel(self):
        """إلغاء العملية"""
        self.balance_type = None
        self.destroy()

class SalesGroupDialog(tk.Toplevel):
    """نافذة اختيار نوع تجميع تقرير المبيعات"""
    def __init__(self, parent):
        super().__init__(parent)
        self.title("اختر نوع التجميع")
        self.geometry("300x250")
        self.group_by = None
        
        self.create_widgets()
        self.center_window()
    
    def center_window(self):
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f'{width}x{height}+{x}+{y}')
    
    def create_widgets(self):
        main_frame = tk.Frame(self, padx=20, pady=20)
        main_frame.pack(fill='both', expand=True)
        
        tk.Label(main_frame, text="اختر نوع تجميع البيانات:", 
                font=('Arial', 12, 'bold')).pack(pady=(0, 20))
        
        group_types = [
            ("يومي", "daily"),
            ("شهري", "monthly"),
            ("سنوي", "yearly"),
            ("حسب القطاع", "sector")
        ]
        
        self.selected_group = tk.StringVar(value="daily")
        
        for text, value in group_types:
            rb = tk.Radiobutton(main_frame, text=text, variable=self.selected_group,
                              value=value, font=('Arial', 10))
            rb.pack(anchor='w', pady=5)
        
        btn_frame = tk.Frame(main_frame, pady=20)
        btn_frame.pack(fill='x')
        
        tk.Button(btn_frame, text="موافق", command=self.ok,
                 bg='#27ae60', fg='white').pack(side='right', padx=5)
        tk.Button(btn_frame, text="إلغاء", command=self.cancel,
                 bg='#e74c3c', fg='white').pack(side='right')
    
    def ok(self):
        self.group_by = self.selected_group.get()
        self.destroy()
    
    def cancel(self):
        self.destroy()

ملف settings_ui.py له الكود التالي
# ui/settings_ui.py
import tkinter as tk
from tkinter import ttk, messagebox
import json
import os

class SettingsUI:
    def __init__(self, parent_frame):
        self.parent = parent_frame
        self.settings_file = "config/settings.json"
        self.load_settings()
        self.create_widgets()
    
    def load_settings(self):
        """تحميل الإعدادات"""
        default_settings = {
            "company_name": "مولدة الريان للطاقة الكهربائية",
            "company_phone": "011-1234567",
            "currency": "ل.س",
            "tax_rate": 10,
            "backup_auto": True
        }
        
        try:
            if os.path.exists(self.settings_file):
                with open(self.settings_file, 'r') as f:
                    self.settings = json.load(f)
            else:
                self.settings = default_settings
        except:
            self.settings = default_settings
    
    def save_settings(self):
        """حفظ الإعدادات"""
        try:
            os.makedirs("config", exist_ok=True)
            with open(self.settings_file, 'w') as f:
                json.dump(self.settings, f, indent=2)
            messagebox.showinfo("نجاح", "تم حفظ الإعدادات")
            return True
        except Exception as e:
            messagebox.showerror("خطأ", f"فشل الحفظ: {str(e)}")
            return False
    
    def create_widgets(self):
        """إنشاء واجهة الإعدادات"""
        for widget in self.parent.winfo_children():
            widget.destroy()
        
        frame = ttk.Frame(self.parent)
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = ttk.Label(frame, text="إعدادات النظام", font=("Arial", 20, "bold"))
        title.pack(pady=10)
        
        # تبويبات
        notebook = ttk.Notebook(frame)
        notebook.pack(fill='both', expand=True, pady=10)
        
        # تبويب عام
        general_frame = ttk.Frame(notebook)
        notebook.add(general_frame, text="عام")
        self.create_general_tab(general_frame)
        
        # تبويب مالي
        financial_frame = ttk.Frame(notebook)
        notebook.add(financial_frame, text="مالي")
        self.create_financial_tab(financial_frame)
        
        # أزرار الحفظ
        btn_frame = ttk.Frame(frame)
        btn_frame.pack(pady=10)
        
        ttk.Button(btn_frame, text="حفظ", command=self.save_settings).pack(side='left', padx=5)
        ttk.Button(btn_frame, text="إعادة تعيين", command=self.reset_settings).pack(side='left', padx=5)
    
    def create_general_tab(self, parent):
        """إنشاء تبويب الإعدادات العامة"""
        form_frame = ttk.Frame(parent)
        form_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # اسم الشركة
        ttk.Label(form_frame, text="اسم الشركة:").grid(row=0, column=0, sticky='e', pady=5)
        self.company_name = ttk.Entry(form_frame, width=40)
        self.company_name.grid(row=0, column=1, pady=5, padx=5)
        self.company_name.insert(0, self.settings.get("company_name", ""))
        
        # هاتف الشركة
        ttk.Label(form_frame, text="هاتف الشركة:").grid(row=1, column=0, sticky='e', pady=5)
        self.company_phone = ttk.Entry(form_frame, width=40)
        self.company_phone.grid(row=1, column=1, pady=5, padx=5)
        self.company_phone.insert(0, self.settings.get("company_phone", ""))
        
        # النسخ الاحتياطي التلقائي
        self.backup_var = tk.BooleanVar(value=self.settings.get("backup_auto", True))
        ttk.Checkbutton(form_frame, text="النسخ الاحتياطي التلقائي", 
                       variable=self.backup_var).grid(row=2, column=1, sticky='w', pady=5)
    
    def create_financial_tab(self, parent):
        """إنشاء تبويب الإعدادات المالية"""
        form_frame = ttk.Frame(parent)
        form_frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        # العملة
        ttk.Label(form_frame, text="العملة:").grid(row=0, column=0, sticky='e', pady=5)
        self.currency = ttk.Entry(form_frame, width=20)
        self.currency.grid(row=0, column=1, pady=5, padx=5, sticky='w')
        self.currency.insert(0, self.settings.get("currency", "ل.س"))
        
        # نسبة الضريبة
        ttk.Label(form_frame, text="نسبة الضريبة (%):").grid(row=1, column=0, sticky='e', pady=5)
        self.tax_rate = ttk.Entry(form_frame, width=20)
        self.tax_rate.grid(row=1, column=1, pady=5, padx=5, sticky='w')
        self.tax_rate.insert(0, str(self.settings.get("tax_rate", 10)))
    
    def reset_settings(self):
        """إعادة تعيين الإعدادات"""
        if messagebox.askyesno("تأكيد", "هل تريد إعادة تعيين جميع الإعدادات؟"):
            self.settings = {}
            self.create_widgets()
            messagebox.showinfo("نجاح", "تم إعادة تعيين الإعدادات")
ملف user_management_ui.py له الكود التالي
# ui/users_ui.py
import tkinter as tk
from tkinter import ttk, messagebox
import logging

logger = logging.getLogger(__name__)

class UsersUI:
    def __init__(self, parent_frame):
        self.parent = parent_frame
        self.create_widgets()
        self.load_users()
    
    def create_widgets(self):
        """إنشاء واجهة إدارة المستخدمين"""
        for widget in self.parent.winfo_children():
            widget.destroy()
        
        frame = ttk.Frame(self.parent)
        frame.pack(fill='both', expand=True, padx=20, pady=20)
        
        title = ttk.Label(frame, text="إدارة المستخدمين", font=("Arial", 20, "bold"))
        title.pack(pady=10)
        
        # أزرار الإدارة
        btn_frame = ttk.Frame(frame)
        btn_frame.pack(fill='x', pady=10)
        
        ttk.Button(btn_frame, text="إضافة مستخدم جديد", command=self.add_user).pack(side='left', padx=5)
        ttk.Button(btn_frame, text="تعديل مستخدم", command=self.edit_user).pack(side='left', padx=5)
        ttk.Button(btn_frame, text="حذف مستخدم", command=self.delete_user).pack(side='left', padx=5)
        ttk.Button(btn_frame, text="تصدير قائمة المستخدمين", command=self.export_users).pack(side='left', padx=5)
        
        # جدول المستخدمين
        columns = ('id', 'username', 'full_name', 'role', 'email', 'created_at')
        self.tree = ttk.Treeview(frame, columns=columns, show='headings', height=15)
        
        # تعريف العناوين
        self.tree.heading('id', text='المعرف')
        self.tree.heading('username', text='اسم المستخدم')
        self.tree.heading('full_name', text='الاسم الكامل')
        self.tree.heading('role', text='الدور')
        self.tree.heading('email', text='البريد الإلكتروني')
        self.tree.heading('created_at', text='تاريخ الإنشاء')
        
        self.tree.pack(fill='both', expand=True, pady=10)
        
        # معلومات إحصائية
        stats_frame = ttk.Frame(frame)
        stats_frame.pack(fill='x', pady=10)
        
        self.stats_label = ttk.Label(stats_frame, text="جاري تحميل الإحصائيات...")
        self.stats_label.pack()
    
    def load_users(self):
        """تحميل قائمة المستخدمين"""
        try:
            # بيانات تجريبية - ستحل محلها استعلام قاعدة البيانات
            users = [
                (1, 'admin', 'مدير النظام', 'admin', 'admin@rayan.com', '2024-01-01'),
                (2, 'accountant1', 'محاسب 1', 'accountant', 'acc1@rayan.com', '2024-02-01'),
                (3, 'cashier1', 'أمين صندوق 1', 'cashier', 'cash1@rayan.com', '2024-03-01'),
            ]
            
            # مسح الجدول أولاً
            for item in self.tree.get_children():
                self.tree.delete(item)
            
            # إضافة البيانات
            for user in users:
                self.tree.insert('', 'end', values=user)
            
            # تحديث الإحصائيات
            self.stats_label.config(text=f"إجمالي المستخدمين: {len(users)} | المديرين: 1 | المحاسبين: 1 | أمناء الصندوق: 1")
            
            logger.info(f"تم تحميل {len(users)} مستخدم")
        except Exception as e:
            logger.error(f"خطأ في تحميل المستخدمين: {e}")
            messagebox.showerror("خطأ", f"فشل تحميل المستخدمين: {str(e)}")
    
    def add_user(self):
        """إضافة مستخدم جديد"""
        logger.info("فتح نافذة إضافة مستخدم جديد")
        messagebox.showinfo("إضافة مستخدم", "سيتم فتح نافذة إضافة مستخدم جديد")
        # هنا سيتم فتح نافذة إضافة مستخدم
    
    def edit_user(self):
        """تعديل مستخدم"""
        selected = self.tree.selection()
        if not selected:
            messagebox.showwarning("تحذير", "يرجى اختيار مستخدم من القائمة")
            return
        logger.info("تعديل المستخدم المحدد")
    
    def delete_user(self):
        """حذف مستخدم"""
        selected = self.tree.selection()
        if not selected:
            messagebox.showwarning("تحذير", "يرجى اختيار مستخدم من القائمة")
            return
        
        user_data = self.tree.item(selected[0])['values']
        confirm = messagebox.askyesno("تأكيد الحذف", f"هل أنت متأكد من حذف المستخدم: {user_data[2]}؟")
        
        if confirm:
            logger.info(f"حذف المستخدم: {user_data[1]}")
            self.tree.delete(selected[0])
            messagebox.showinfo("نجاح", "تم حذف المستخدم بنجاح")
    
    def export_users(self):
        """تصدير قائمة المستخدمين"""
        logger.info("تصدير قائمة المستخدمين")
        messagebox.showinfo("تصدير", "سيتم تصدير قائمة المستخدمين إلى ملف Excel")

ملف  import_manager.py له الكود التالي 
# ui/import_manager.py - الملف الكامل
import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import logging
import os
import threading
from datetime import datetime

logger = logging.getLogger(__name__)

class ImportManagerUI:
    """واجهة إدارة الاستيراد المتقدمة"""
    
    def __init__(self, parent, user_data):
        self.parent = parent
        self.user_data = user_data
        self.excel_folder = ""
        self.selected_files = []
        self.is_running = False
        
        # إطار رئيسي مع سكرول بار
        self.create_main_scrollable_frame()
    
    def create_main_scrollable_frame(self):
        """إنشاء إطار رئيسي قابل للتمرير"""
        # مسح المحتوى القديم
        for widget in self.parent.winfo_children():
            widget.destroy()
        
        # إطار رئيسي مع Canvas وScrollbar
        self.canvas = tk.Canvas(self.parent, bg='white', highlightthickness=0)
        scrollbar = ttk.Scrollbar(self.parent, orient="vertical", command=self.canvas.yview)
        
        # إطار قابل للتمرير للعناصر
        self.scrollable_frame = tk.Frame(self.canvas, bg='white')
        
        # تهيئة الـCanvas
        self.canvas.configure(yscrollcommand=scrollbar.set)
        
        # إنشاء نافذة في Canvas
        self.canvas_window = self.canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw")
        
        # تعبئة وإظهار العناصر
        scrollbar.pack(side="right", fill="y")
        self.canvas.pack(side="left", fill="both", expand=True)
        
        # ربط الأحداث
        self.scrollable_frame.bind("<Configure>", self._on_frame_configure)
        self.canvas.bind("<Configure>", self._on_canvas_configure)
        
        # تمكين تمرير العجلة
        self.canvas.bind_all("<MouseWheel>", self._on_mousewheel)
        
        # إنشاء الواجهة داخل الإطار القابل للتمرير
        self.create_widgets_in_scrollable_frame()
    
    def _on_frame_configure(self, event=None):
        """تحديث منطقة التمرير عند تغيير حجم الإطار"""
        self.canvas.configure(scrollregion=self.canvas.bbox("all"))
    
    def _on_canvas_configure(self, event):
        """ضبط عرض نافذة الـCanvas عند تغيير الحجم"""
        self.canvas.itemconfig(self.canvas_window, width=event.width)
    
    def _on_mousewheel(self, event):
        """معالجة تمرير عجلة الماوس"""
        self.canvas.yview_scroll(int(-1*(event.delta/120)), "units")
    
    def create_widgets_in_scrollable_frame(self):
        """إنشاء عناصر الواجهة داخل الإطار القابل للتمرير"""
        # العنوان
        title = tk.Label(self.scrollable_frame,
                        text="🔄 مدير الاستيراد والتصدير",
                        font=('Arial', 20, 'bold'),
                        bg='white', fg='#2c3e50')
        title.pack(pady=10)
        
        # تبويبات
        notebook = ttk.Notebook(self.scrollable_frame)
        notebook.pack(fill='both', expand=True, pady=20)
        
        # تبويب الاستيراد
        import_tab = tk.Frame(notebook, bg='white')
        self.create_import_tab(import_tab)
        notebook.add(import_tab, text="📥 استيراد البيانات")
        
        # تبويب النسخ الاحتياطي
        backup_tab = tk.Frame(notebook, bg='white')
        self.create_backup_tab(backup_tab)
        notebook.add(backup_tab, text="💾 النسخ الاحتياطي")
        
        # تبويب السجلات
        logs_tab = tk.Frame(notebook, bg='white')
        self.create_logs_tab(logs_tab)
        notebook.add(logs_tab, text="📋 سجلات الاستيراد")
        
        # ضبط الحد الأدنى لحجم الإطار
        self.scrollable_frame.update_idletasks()
        self.canvas.configure(scrollregion=self.canvas.bbox("all"))
    
    def create_import_tab(self, parent):
        """إنشاء تبويب الاستيراد"""
        # إطار داخلي مع سكرول بار
        inner_canvas = tk.Canvas(parent, bg='white', highlightthickness=0)
        inner_scrollbar = ttk.Scrollbar(parent, orient="vertical", command=inner_canvas.yview)
        inner_frame = tk.Frame(inner_canvas, bg='white')
        
        inner_canvas.configure(yscrollcommand=inner_scrollbar.set)
        inner_canvas_window = inner_canvas.create_window((0, 0), window=inner_frame, anchor="nw")
        
        def configure_inner_canvas(event):
            inner_canvas.configure(scrollregion=inner_canvas.bbox("all"))
            inner_canvas.itemconfig(inner_canvas_window, width=event.width)
        
        inner_frame.bind("<Configure>", configure_inner_canvas)
        inner_canvas.bind("<Configure>", configure_inner_canvas)
        
        inner_scrollbar.pack(side="right", fill="y")
        inner_canvas.pack(side="left", fill="both", expand=True)
        
        # قسم اختيار الملفات
        file_frame = tk.LabelFrame(inner_frame, text="اختر ملفات Excel", 
                                  bg='white', padx=15, pady=15)
        file_frame.pack(fill='x', pady=10)
        
        tk.Label(file_frame, text="مجلد ملفات Excel:",
                bg='white', font=('Arial', 11)).pack(anchor='w')
        
        self.folder_path = tk.StringVar()
        
        folder_entry = tk.Entry(file_frame, textvariable=self.folder_path,
                               font=('Arial', 11), width=50)
        folder_entry.pack(side='left', fill='x', expand=True, pady=5)
        
        tk.Button(file_frame, text="استعراض...",
                 command=self.browse_folder,
                 bg='#3498db', fg='white').pack(side='right', padx=5)
        
        # قسم خيارات الاستيراد
        options_frame = tk.LabelFrame(inner_frame, text="خيارات الاستيراد",
                                     bg='white', padx=15, pady=15)
        options_frame.pack(fill='x', pady=10)
        
        # خيار حذف البيانات القديمة
        self.delete_old_var = tk.BooleanVar(value=True)
        tk.Checkbutton(options_frame, text="حذف البيانات القديمة قبل الاستيراد",
                      variable=self.delete_old_var,
                      bg='white', font=('Arial', 11)).pack(anchor='w', pady=5)
        
        # خيار النسخ الاحتياطي التلقائي
        self.auto_backup_var = tk.BooleanVar(value=True)
        tk.Checkbutton(options_frame, text="إنشاء نسخة احتياطية تلقائية",
                      variable=self.auto_backup_var,
                      bg='white', font=('Arial', 11)).pack(anchor='w', pady=5)
        
        # قسم الملفات المحددة
        self.files_frame = tk.LabelFrame(inner_frame, text="الملفات المحددة",
                                        bg='white', padx=15, pady=15)
        self.files_frame.pack(fill='both', expand=True, pady=10)
        
        # زر بدء الاستيراد
        start_button = tk.Button(inner_frame, text="🚀 بدء عملية الاستيراد",
                               command=self.start_import,
                               bg='#27ae60', fg='white',
                               font=('Arial', 12, 'bold'),
                               padx=30, pady=10)
        start_button.pack(pady=20)
        
        # إطار فارغ لضمان ظهور الزر
        tk.Frame(inner_frame, height=20, bg='white').pack()
        
        # ربط حدث الماوس مع الإطار الداخلي
        inner_canvas.bind_all("<MouseWheel>", 
                            lambda e: inner_canvas.yview_scroll(int(-1*(e.delta/120)), "units"))
    
    def browse_folder(self):
        """استعراض مجلد الملفات"""
        folder = filedialog.askdirectory(title="اختر مجلد ملفات Excel")
        if folder:
            self.folder_path.set(folder)
            self.display_excel_files(folder)
    
    def display_excel_files(self, folder):
        """عرض ملفات Excel في المجلد"""
        # مسح الإطار القديم
        for widget in self.files_frame.winfo_children():
            widget.destroy()
        
        # البحث عن ملفات Excel
        excel_files = []
        for file in os.listdir(folder):
            if file.endswith('.xlsx'):
                excel_files.append(file)
        
        if not excel_files:
            tk.Label(self.files_frame, text="❌ لا توجد ملفات Excel في المجلد",
                    bg='white', fg='red').pack(pady=20)
            return
        
        # عرض الملفات
        tk.Label(self.files_frame, 
                text=f"تم العثور على {len(excel_files)} ملف Excel:",
                bg='white', font=('Arial', 11, 'bold')).pack(anchor='w', pady=(0, 10))
        
        # إطار قائمة الملفات مع سكرول بار
        list_container = tk.Frame(self.files_frame, bg='white')
        list_container.pack(fill='both', expand=True)
        
        # Canvas للسكرول بار
        list_canvas = tk.Canvas(list_container, bg='white', height=200, highlightthickness=0)
        list_scrollbar = ttk.Scrollbar(list_container, orient="vertical", command=list_canvas.yview)
        list_frame = tk.Frame(list_canvas, bg='white')
        
        list_canvas.configure(yscrollcommand=list_scrollbar.set)
        list_canvas_window = list_canvas.create_window((0, 0), window=list_frame, anchor="nw")
        
        def configure_list_canvas(event):
            list_canvas.configure(scrollregion=list_canvas.bbox("all"))
            list_canvas.itemconfig(list_canvas_window, width=event.width)
        
        list_frame.bind("<Configure>", configure_list_canvas)
        list_canvas.bind("<Configure>", configure_list_canvas)
        
        list_scrollbar.pack(side="right", fill="y")
        list_canvas.pack(side="left", fill="both", expand=True)
        
        # أزرار اختيار الملفات
        self.file_vars = []
        for idx, file in enumerate(excel_files):
            var = tk.BooleanVar(value=True)
            self.file_vars.append((file, var))
            
            file_frame = tk.Frame(list_frame, bg='#f9f9f9' if idx % 2 == 0 else 'white')
            file_frame.pack(fill='x', pady=1)
            
            # خانة اختيار
            cb = tk.Checkbutton(file_frame, variable=var, bg=file_frame['bg'])
            cb.grid(row=0, column=0, padx=5, pady=3)
            
            # اسم الملف
            tk.Label(file_frame, text=file, bg=file_frame['bg'],
                    font=('Arial', 10), anchor='w').grid(row=0, column=1, 
                                                         padx=5, pady=3, sticky='w')
            
            # حجم الملف
            try:
                size = os.path.getsize(os.path.join(folder, file))
                size_str = f"{size/1024:.1f} KB"
            except:
                size_str = "غير معروف"
            
            tk.Label(file_frame, text=size_str, bg=file_frame['bg'],
                    font=('Arial', 9), fg='#666').grid(row=0, column=2, 
                                                      padx=5, pady=3)
        
        # أزرار اختيار/إلغاء الكل
        buttons_frame = tk.Frame(self.files_frame, bg='white')
        buttons_frame.pack(fill='x', pady=10)
        
        tk.Button(buttons_frame, text="تحديد الكل",
                 command=lambda: self.toggle_all_files(True),
                 bg='#3498db', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=5)
        
        tk.Button(buttons_frame, text="إلغاء تحديد الكل",
                 command=lambda: self.toggle_all_files(False),
                 bg='#e74c3c', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=5)
        
        # ربط حدث الماوس مع canvas القائمة
        list_canvas.bind_all("<MouseWheel>", 
                           lambda e: list_canvas.yview_scroll(int(-1*(e.delta/120)), "units"))
        
        # حفظ الملفات المحددة
        self.selected_files = excel_files
    
    def toggle_all_files(self, select_all):
        """تحديد أو إلغاء تحديد جميع الملفات"""
        if hasattr(self, 'file_vars'):
            for file, var in self.file_vars:
                var.set(select_all)
    
    def get_selected_files(self):
        """الحصول على الملفات المحددة"""
        selected = []
        if hasattr(self, 'file_vars'):
            for file, var in self.file_vars:
                if var.get():
                    selected.append(file)
        return selected
    
    def start_import(self):
        """بدء عملية الاستيراد"""
        folder = self.folder_path.get()
        if not folder or not os.path.exists(folder):
            messagebox.showerror("خطأ", "يرجى اختيار مجلد صحيح")
            return
        
        # التحقق من الصلاحيات
        if self.user_data.get('role') != 'admin':
            messagebox.showerror("صلاحيات", "هذا الإجراء للمديرين فقط")
            return
        
        # الحصول على الملفات المحددة
        selected_files = self.get_selected_files()
        if not selected_files:
            messagebox.showerror("خطأ", "لم يتم اختيار أي ملفات للاستيراد")
            return
        
        # تحذير قبل الحذف
        if self.delete_old_var.get():
            warning = f"""⚠️  تحذير مهم!
            
سيتم حذف جميع البيانات القديمة قبل الاستيراد!
عدد الملفات المحددة: {len(selected_files)}
            
هل أنت متأكد من المتابعة؟"""
            if not messagebox.askyesno("تحذير", warning):
                return
        
        # إنشاء نافذة التقدم
        self.create_progress_window()
        
        # تنفيذ الاستيراد في thread منفصل
        thread = threading.Thread(target=self.execute_import, 
                                 args=(folder, selected_files))
        thread.start()
    
    def create_progress_window(self):
        """إنشاء نافذة عرض التقدم"""
        self.progress_window = tk.Toplevel(self.parent)
        self.progress_window.title("جاري الاستيراد...")
        self.progress_window.geometry("500x300")
        self.progress_window.resizable(False, False)
        self.progress_window.transient(self.parent)
        self.progress_window.grab_set()
        
        # شريط التقدم
        self.progress_bar = ttk.Progressbar(self.progress_window, 
                                          mode='determinate',
                                          length=400)
        self.progress_bar.pack(pady=30)
        
        # حالة التقدم
        self.status_label = tk.Label(self.progress_window,
                                    text="جاري إعداد عملية الاستيراد...",
                                    font=('Arial', 12))
        self.status_label.pack(pady=10)
        
        # التفاصيل
        self.details_label = tk.Label(self.progress_window,
                                     text="",
                                     font=('Arial', 10),
                                     fg='#7f8c8d')
        self.details_label.pack(pady=10)
        
        # زر الإلغاء
        tk.Button(self.progress_window, text="إلغاء",
                 command=self.cancel_import,
                 bg='#e74c3c', fg='white',
                 padx=20).pack(pady=20)
        
        self.progress_window.protocol("WM_DELETE_WINDOW", self.cancel_import)
    
    def execute_import(self, folder, selected_files):
        """تنفيذ عملية الاستيراد"""
        try:
            self.is_running = True
            
            if not selected_files:
                self.update_progress("❌ لم يتم اختيار أي ملفات", 0)
                messagebox.showerror("خطأ", "لم يتم اختيار أي ملفات")
                self.close_progress()
                return
            
            # النسخ الاحتياطي إذا مطلوب
            if self.auto_backup_var.get():
                self.update_progress("جاري إنشاء نسخة احتياطية...", 20)
                self.create_backup()
            
            # حذف البيانات القديمة إذا مطلوب
            if self.delete_old_var.get():
                self.update_progress("جاري حذف البيانات القديمة...", 30)
                self.delete_old_data()
            
            # استيراد البيانات الجديدة
            total_files = len(selected_files)
            
            for idx, file in enumerate(selected_files, 1):
                progress = 40 + (idx / total_files * 50)
                self.update_progress(f"جاري استيراد الملف {idx}/{total_files}: {file}", 
                                   progress)
                
                # استيراد كل ملف
                from database.migrations import ExcelMigration
                migrator = ExcelMigration(folder)
                
                # هنا يجب تعديل الكود ليقبل اسم ملف محدد
                # مؤقتاً نستخدم نفس الدالة
                success = migrator.migrate_all_data()
                
                if not success:
                    self.update_progress(f"❌ فشل استيراد الملف: {file}", progress)
                    logger.error(f"فشل استيراد الملف: {file}")
            
            self.update_progress("✅ تمت العملية بنجاح!", 100)
            # إغلاق نافذة التقدم بعد 2 ثانية
            self.parent.after(2000, self.close_progress_success)
            
        except Exception as e:
            logger.error(f"خطأ في الاستيراد: {e}")
            self.update_progress(f"❌ فشل الاستيراد: {str(e)}", 0)
            self.parent.after(2000, lambda: messagebox.showerror("خطأ", f"فشل الاستيراد: {str(e)}"))
            self.close_progress()
        finally:
            self.is_running = False
    
    def update_progress(self, message, percentage):
        """تحديث شريط التقدم"""
        if hasattr(self, 'progress_window') and self.progress_window.winfo_exists():
            self.status_label.config(text=message)
            self.progress_bar['value'] = percentage
            self.details_label.config(text=f"التقدم: {percentage:.0f}%")
            self.progress_window.update()
    
    def create_backup(self):
        """إنشاء نسخة احتياطية"""
        try:
            from modules.archive import ArchiveManager
            archive = ArchiveManager()
            archive.perform_backup()
            logger.info("تم إنشاء نسخة احتياطية بنجاح")
        except Exception as e:
            logger.error(f"خطأ في النسخ الاحتياطي: {e}")
    
    def delete_old_data(self):
        """حذف البيانات القديمة"""
        try:
            from database.connection import db
            with db.get_cursor() as cursor:
                # حذف الفواتير أولاً (بسبب المفتاح الخارجي)
                cursor.execute("DELETE FROM invoices")
                # حذف الزبائن
                cursor.execute("DELETE FROM customers")
                logger.info("تم حذف البيانات القديمة")
        except Exception as e:
            logger.error(f"خطأ في حذف البيانات: {e}")
            raise
    
    def cancel_import(self):
        """إلغاء عملية الاستيراد"""
        self.is_running = False
        if hasattr(self, 'progress_window'):
            self.progress_window.destroy()
    
    def close_progress(self):
        """إغلاق نافذة التقدم"""
        if hasattr(self, 'progress_window'):
            self.progress_window.destroy()
    
    def close_progress_success(self):
        """إغلاق نافذة التقدم مع رسالة نجاح"""
        self.close_progress()
        messagebox.showinfo("نجاح", "✅ تمت عملية الاستيراد بنجاح!")
        # تحديث قائمة الملفات
        folder = self.folder_path.get()
        if folder:
            self.display_excel_files(folder)
    
    def create_backup_tab(self, parent):
        """إنشاء تبويب النسخ الاحتياطي"""
        # محتوى النسخ الاحتياطي
        backup_frame = tk.LabelFrame(parent, text="خيارات النسخ الاحتياطي",
                                    bg='white', padx=15, pady=15)
        backup_frame.pack(fill='both', expand=True, pady=10)
        
        tk.Label(backup_frame, 
                text="إنشاء نسخة احتياطية من قاعدة البيانات:",
                bg='white', font=('Arial', 11)).pack(anchor='w', pady=10)
        
        tk.Button(backup_frame, text="💾 إنشاء نسخة احتياطية الآن",
                 command=self.create_manual_backup,
                 bg='#9b59b6', fg='white',
                 font=('Arial', 11),
                 padx=20, pady=10).pack(pady=20)
        
        tk.Label(backup_frame, 
                text="النسخ الاحتياطية السابقة:",
                bg='white', font=('Arial', 11, 'bold')).pack(anchor='w', pady=(20, 10))
        
        # قائمة النسخ الاحتياطية مع سكرول بار
        backup_container = tk.Frame(backup_frame, bg='white')
        backup_container.pack(fill='both', expand=True)
        
        canvas = tk.Canvas(backup_container, bg='white', height=150, highlightthickness=0)
        scrollbar = ttk.Scrollbar(backup_container, orient="vertical", command=canvas.yview)
        backup_list_frame = tk.Frame(canvas, bg='white')
        
        canvas.configure(yscrollcommand=scrollbar.set)
        canvas_window = canvas.create_window((0, 0), window=backup_list_frame, anchor="nw")
        
        scrollbar.pack(side="right", fill="y")
        canvas.pack(side="left", fill="both", expand=True)
        
        def configure_backup_canvas(event):
            canvas.configure(scrollregion=canvas.bbox("all"))
            canvas.itemconfig(canvas_window, width=canvas.winfo_width())
        
        backup_list_frame.bind("<Configure>", configure_backup_canvas)
        
        # عرض النسخ الاحتياطية (مثال)
        backups = self.get_backup_list()
        if backups:
            for backup in backups:
                backup_item = tk.Frame(backup_list_frame, bg='#f8f9fa')
                backup_item.pack(fill='x', pady=2, padx=5)
                
                tk.Label(backup_item, text=backup['name'], 
                        bg=backup_item['bg'], font=('Arial', 10)).pack(side='left', padx=10)
                tk.Label(backup_item, text=backup['date'], 
                        bg=backup_item['bg'], font=('Arial', 9), fg='#666').pack(side='right', padx=10)
        else:
            tk.Label(backup_list_frame, text="لا توجد نسخ احتياطية حالياً",
                    bg='white', fg='#999', font=('Arial', 10)).pack(pady=20)
    
    def get_backup_list(self):
        """الحصول على قائمة النسخ الاحتياطية"""
        return [
            {'name': 'backup_2024_01_01.zip', 'date': '2024-01-01 10:30'},
            {'name': 'backup_2023_12_15.zip', 'date': '2023-12-15 14:20'},
        ]
    
    def create_manual_backup(self):
        """إنشاء نسخة احتياطية يدوية"""
        try:
            from modules.archive import ArchiveManager
            archive = ArchiveManager()
            result = archive.perform_backup()
            messagebox.showinfo("نجاح", "✅ تم إنشاء نسخة احتياطية بنجاح!")
        except Exception as e:
            logger.error(f"خطأ في النسخ الاحتياطي: {e}")
            messagebox.showerror("خطأ", f"فشل إنشاء نسخة احتياطية: {str(e)}")
    
    def create_logs_tab(self, parent):
        """إنشاء تبويب السجلات"""
        # محتوى سجلات الاستيراد
        logs_frame = tk.LabelFrame(parent, text="سجلات عمليات الاستيراد",
                                  bg='white', padx=15, pady=15)
        logs_frame.pack(fill='both', expand=True, pady=10)
        
        # شريط الأدوات
        toolbar = tk.Frame(logs_frame, bg='white')
        toolbar.pack(fill='x', pady=(0, 10))
        
        tk.Button(toolbar, text="🔄 تحديث السجلات",
                 command=self.refresh_logs,
                 bg='#3498db', fg='white').pack(side='left', padx=5)
        
        tk.Button(toolbar, text="🗑️ مسح السجلات",
                 command=self.clear_logs,
                 bg='#e74c3c', fg='white').pack(side='left', padx=5)
        
        # منطقة عرض السجلات مع سكرول بار
        log_container = tk.Frame(logs_frame, bg='white')
        log_container.pack(fill='both', expand=True)
        
        # إطار النص مع سكرول بار
        text_frame = tk.Frame(log_container)
        text_frame.pack(fill='both', expand=True)
        
        self.log_text = tk.Text(text_frame, 
                               height=15, 
                               font=('Courier', 10),
                               bg='#f8f9fa',
                               wrap='word')
        
        log_scrollbar = ttk.Scrollbar(text_frame)
        log_scrollbar.pack(side='right', fill='y')
        
        self.log_text.pack(side='left', fill='both', expand=True)
        
        # ربط السكرول بار
        self.log_text.config(yscrollcommand=log_scrollbar.set)
        log_scrollbar.config(command=self.log_text.yview)
        
        # تحميل السجلات الأولية
        self.load_logs()
    
    def load_logs(self):
        """تحميل السجلات"""
        try:
            # تحميل سجلات من ملف أو قاعدة بيانات
            logs_content = """📅 2024-01-01 10:30:00 - بدء عملية الاستيراد
✅ تم استيراد 5 ملفات بنجاح
📁 الملفات: customers.xlsx, invoices.xlsx
⏱️ المدة: 15 ثانية

📅 2023-12-15 14:20:00 - بدء عملية الاستيراد
✅ تم استيراد 3 ملفات بنجاح
📁 الملفات: products.xlsx
⏱️ المدة: 8 ثواني

📅 2023-12-01 09:15:00 - فشل عملية الاستيراد
❌ خطأ في تنسيق الملف: sales.xlsx
⚠️ تم التخطي والمتابعة"""
            
            self.log_text.delete(1.0, tk.END)
            self.log_text.insert(1.0, logs_content)
            self.log_text.config(state='normal')
        except Exception as e:
            logger.error(f"خطأ في تحميل السجلات: {e}")
            self.log_text.insert(1.0, "خطأ في تحميل السجلات")
    
    def refresh_logs(self):
        """تحديث السجلات"""
        self.load_logs()
        messagebox.showinfo("تحديث", "تم تحديث السجلات بنجاح")
    
    def clear_logs(self):
        """مسح السجلات"""
        if messagebox.askyesno("تأكيد", "هل تريد مسح جميع السجلات؟"):
            self.log_text.delete(1.0, tk.END)
            self.log_text.insert(1.0, "📋 سجلات الاستيراد\n" + "="*40 + "\n\nلا توجد سجلات حالياً.")

ملف accounting_ui.py  له الكود التالي
"""
ui/accounting_ui.py - واجهة محاسبة متكاملة مع النظام الجديد
تم التحديث لدعم نظام كمية الدفع والمجاني بدلاً من القراءة الجديدة
"""

import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
import logging
from datetime import datetime
from modules.fast_operations import FastOperations
from modules.printing import FastPrinter

logger = logging.getLogger(__name__)

class AccountingUI(tk.Frame):
    """واجهة محاسبة محسنة تعمل بالنظام الجديد (كمية الدفع + مجاني)"""
    
    def __init__(self, parent, user_data):
        super().__init__(parent)
        self.parent = parent
        self.user_data = user_data
        self.fast_ops = FastOperations()
        self.printer = FastPrinter()
        
        self.selected_customer = None
        self.sectors = []
        self.last_invoice_result = None
        self.search_results_data = []
        
        # تكوين الإطار ليملأ الشاشة كاملة
        self.pack(fill='both', expand=True)
        
        self.load_sectors()
        self.create_widgets()
        self.center_window()
    
    def load_sectors(self):
        """تحميل القطاعات مرة واحدة"""
        from database.connection import db
        try:
            with db.get_cursor() as cursor:
                cursor.execute("SELECT id, name FROM sectors WHERE is_active = TRUE ORDER BY name")
                self.sectors = cursor.fetchall()
        except Exception as e:
            logger.error(f"خطأ في تحميل القطاعات: {e}")
            self.sectors = []
    
    def create_widgets(self):
        """إنشاء واجهة كاملة الشاشة بالنظام الجديد"""
        # إزالة أي عناصر سابقة
        for widget in self.winfo_children():
            widget.destroy()
        
        # الإطار الرئيسي مع تمرير
        main_frame = tk.Frame(self, bg='#f5f7fa')
        main_frame.pack(fill='both', expand=True)
        
        # شريط الأدوات العلوي
        self.create_toolbar(main_frame)
        
        # إطار المحتوى القابل للتمرير
        canvas = tk.Canvas(main_frame, bg='#f5f7fa', highlightthickness=0)
        canvas.pack(fill='both', expand=True, padx=20, pady=10)

        scrollbar = tk.Scrollbar(main_frame, orient='vertical', command=canvas.yview)
        scrollbar.pack(side='right', fill='y')

        canvas.configure(yscrollcommand=scrollbar.set)

        content_frame = tk.Frame(canvas, bg='#f5f7fa')
        canvas.create_window((0, 0), window=content_frame, anchor='nw')

        def on_configure(event):
            canvas.configure(scrollregion=canvas.bbox('all'))

        content_frame.bind('<Configure>', on_configure)
        
        # ===================== قسم البحث السريع =====================
        search_section = tk.LabelFrame(content_frame, text="🔍 بحث سريع عن الزبائن", 
                                      font=('Arial', 14, 'bold'),
                                      bg='white', fg='#2c3e50',
                                      padx=15, pady=15, relief='groove')
        search_section.pack(fill='x', pady=(0, 10))
        
        # صف البحث
        search_row = tk.Frame(search_section, bg='white')
        search_row.pack(fill='x', pady=5)
        
        tk.Label(search_row, text="ابحث بالاسم أو العلبة:", 
                bg='white', font=('Arial', 12), fg='#34495e').pack(side='left', padx=5)
        
        self.search_var = tk.StringVar()
        self.search_entry = tk.Entry(search_row, textvariable=self.search_var,
                                    font=('Arial', 14), width=50,
                                    bg='#ecf0f1', relief='solid')
        self.search_entry.pack(side='left', padx=5, fill='x', expand=True)
        self.search_entry.bind('<KeyRelease>', self.quick_search)
        self.search_entry.focus_set()
        
        # زر البحث
        search_btn = tk.Button(search_row, text="بحث", 
                              command=self.perform_search,
                              bg='#3498db', fg='white',
                              font=('Arial', 12, 'bold'),
                              padx=20, pady=5)
        search_btn.pack(side='left', padx=5)
        
        # نتائج البحث في إطار مع تمرير
        results_frame = tk.Frame(search_section, bg='white', height=200)
        results_frame.pack(fill='both', expand=True, pady=10)
        results_frame.pack_propagate(False)
        
        # شريط التمرير
        scrollbar_results = tk.Scrollbar(results_frame)
        scrollbar_results.pack(side='right', fill='y')
        
        # قائمة النتائج
        self.results_listbox = tk.Listbox(results_frame, 
                                         font=('Arial', 12),
                                         bg='white', fg='#2c3e50',
                                         selectbackground='#3498db',
                                         selectforeground='white',
                                         yscrollcommand=scrollbar_results.set,
                                         height=8)
        self.results_listbox.pack(side='left', fill='both', expand=True)
        scrollbar_results.config(command=self.results_listbox.yview)
        self.results_listbox.bind('<<ListboxSelect>>', self.on_search_select)
        
        # ===================== قسم بيانات الزبون =====================
        info_section = tk.LabelFrame(content_frame, text="📋 بيانات الزبون المحدد", 
                                    font=('Arial', 14, 'bold'),
                                    bg='white', fg='#2c3e50',
                                    padx=15, pady=15, relief='groove')
        info_section.pack(fill='x', pady=(0, 10))
        
        # إطار بيانات الزبون مع تمرير
        info_frame = tk.Frame(info_section, bg='white')
        info_frame.pack(fill='both', expand=True)
        
        # إنشاء شبكة لعرض البيانات
        info_labels = [
            ("اسم الزبون:", "name"),
            ("القطاع:", "sector"),
            ("العلبة:", "box"),
            ("المسلسل:", "serial"),
            ("الرصيد الحالي:", "balance"),
            ("آخر قراءة عداد:", "reading"),
            ("رصيد التأشيرة:", "visa"),
            ("سحب المشترك:", "withdrawal")
        ]
        
        self.info_vars = {}
        for i, (label_text, key) in enumerate(info_labels):
            row = i // 2
            col = (i % 2) * 2
            
            tk.Label(info_frame, text=label_text, 
                    bg='white', font=('Arial', 11, 'bold'),
                    fg='#34495e').grid(row=row, column=col, 
                                      sticky='e', padx=5, pady=8)
            
            var = tk.StringVar(value="---")
            entry = tk.Entry(info_frame, textvariable=var,
                           font=('Arial', 11), state='readonly',
                           bg='#f8f9fa', fg='#2c3e50',
                           relief='solid', width=25)
            entry.grid(row=row, column=col+1, padx=5, pady=8, sticky='ew')
            self.info_vars[key] = var
        
        # جعل الأعمدة قابلة للتوسع
        info_frame.columnconfigure(1, weight=1)
        info_frame.columnconfigure(3, weight=1)
        
        # ===================== قسم المحاسبة السريعة (النظام الجديد) =====================
        acc_section = tk.LabelFrame(content_frame, text="💰 إدخال بيانات الفاتورة (النظام الجديد)", 
                                   font=('Arial', 14, 'bold'),
                                   bg='white', fg='#2c3e50',
                                   padx=15, pady=15, relief='groove')
        acc_section.pack(fill='x', pady=(0, 10))
        
        # شبكة لإدخال البيانات
        acc_frame = tk.Frame(acc_section, bg='white')
        acc_frame.pack(fill='both', expand=True)

        acc_frame.columnconfigure(0, weight=0)
        acc_frame.columnconfigure(1, weight=1)
        
        # حقل كمية الدفع (بدلاً من القراءة الجديدة)
        tk.Label(acc_frame, text="كمية الدفع (كيلو):*", 
                bg='white', font=('Arial', 12),
                fg='#e74c3c').grid(row=0, column=0, sticky='e', padx=5, pady=12)
        
        kilowatt_frame = tk.Frame(acc_frame, bg='white')
        kilowatt_frame.grid(row=0, column=1, padx=5, pady=12, sticky='ew')
        
        self.kilowatt_var = tk.StringVar()
        self.kilowatt_entry = tk.Entry(kilowatt_frame, textvariable=self.kilowatt_var,
                                     font=('Arial', 12), width=15,
                                     bg='#ecf0f1', relief='solid')
        self.kilowatt_entry.pack(side='left', padx=2)
        
        # أزرار التحكم في كمية الدفع
        tk.Button(kilowatt_frame, text="+100", 
                 command=lambda: self.adjust_kilowatt(100),
                 bg='#3498db', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=2)
        
        tk.Button(kilowatt_frame, text="+10", 
                 command=lambda: self.adjust_kilowatt(10),
                 bg='#3498db', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=2)
        
        tk.Button(kilowatt_frame, text="-10", 
                 command=lambda: self.adjust_kilowatt(-10),
                 bg='#e74c3c', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=2)
        
        # حقل المجاني
        tk.Label(acc_frame, text="المجاني (كيلو):", 
                bg='white', font=('Arial', 12),
                fg='#34495e').grid(row=1, column=0, sticky='e', padx=5, pady=12)
        
        self.free_var = tk.StringVar(value="0")
        self.free_entry = tk.Entry(acc_frame, textvariable=self.free_var,
                                  font=('Arial', 12), width=20,
                                  bg='#ecf0f1', relief='solid')
        self.free_entry.grid(row=1, column=1, padx=5, pady=12, sticky='w')
        
        # حقل سعر الكيلو
        tk.Label(acc_frame, text="سعر الكيلو (ل.س):", 
                bg='white', font=('Arial', 12),
                fg='#34495e').grid(row=2, column=0, sticky='e', padx=5, pady=12)
        
        self.price_var = tk.StringVar(value="7200")
        self.price_entry = tk.Entry(acc_frame, textvariable=self.price_var,
                                   font=('Arial', 12), width=20,
                                   bg='#ecf0f1', relief='solid')
        self.price_entry.grid(row=2, column=1, padx=5, pady=12, sticky='w')
        
        # حقل الحسم
        tk.Label(acc_frame, text="الحسم (ل.س):", 
                bg='white', font=('Arial', 12),
                fg='#34495e').grid(row=3, column=0, sticky='e', padx=5, pady=12)
        
        self.discount_var = tk.StringVar(value="0")
        self.discount_entry = tk.Entry(acc_frame, textvariable=self.discount_var,
                                      font=('Arial', 12), width=20,
                                      bg='#ecf0f1', relief='solid')
        self.discount_entry.grid(row=3, column=1, padx=5, pady=12, sticky='w')
        
        # حقل التأشيرة
        tk.Label(acc_frame, text="تنزيل تأشيرة:", 
                bg='white', font=('Arial', 12),
                fg='#34495e').grid(row=4, column=0, sticky='e', padx=5, pady=12)
        
        self.visa_var = tk.StringVar()
        self.visa_entry = tk.Entry(acc_frame, textvariable=self.visa_var,
                                  font=('Arial', 12), width=20,
                                  bg='#ecf0f1', relief='solid')
        self.visa_entry.grid(row=4, column=1, padx=5, pady=12, sticky='w')
        
        # حقل سحب المشترك
        tk.Label(acc_frame, text="سحب المشترك:", 
                bg='white', font=('Arial', 12),
                fg='#34495e').grid(row=5, column=0, sticky='e', padx=5, pady=12)
        
        self.withdrawal_var = tk.StringVar()
        self.withdrawal_entry = tk.Entry(acc_frame, textvariable=self.withdrawal_var,
                                        font=('Arial', 12), width=20,
                                        bg='#ecf0f1', relief='solid')
        self.withdrawal_entry.grid(row=5, column=1, padx=5, pady=12, sticky='w')
        
        # جعل الأعمدة قابلة للتوسع
        acc_frame.columnconfigure(1, weight=1)
        
        # ===================== قسم أزرار التحكم =====================
        btn_section = tk.Frame(content_frame, bg='#f5f7fa')
        btn_section.pack(fill='x', pady=20)
        
        # أزرار كبيرة وواضحة
        btn_frame = tk.Frame(btn_section, bg='#f5f7fa')
        btn_frame.pack()
        
        # زر المعالجة السريعة
        self.process_btn = tk.Button(btn_frame, text="⚡ معالجة سريعة", 
                                   command=self.fast_process,
                                   bg='#27ae60', fg='white',
                                   font=('Arial', 14, 'bold'),
                                   padx=40, pady=15,
                                   state='disabled', cursor='hand2')
        self.process_btn.pack(side='left', padx=10)
        
        # زر الطباعة
        self.print_btn = tk.Button(btn_frame, text="🖨️ طباعة الفاتورة", 
                                 command=self.print_invoice,
                                 bg='#3498db', fg='white',
                                 font=('Arial', 14),
                                 padx=40, pady=15,
                                 state='disabled', cursor='hand2')
        self.print_btn.pack(side='left', padx=10)
        
        # زر التصفير
        clear_btn = tk.Button(btn_frame, text="🗑️ تصفير الحقول", 
                            command=self.clear_fields,
                            bg='#e74c3c', fg='white',
                            font=('Arial', 14),
                            padx=40, pady=15, cursor='hand2')
        clear_btn.pack(side='left', padx=10)
        
        # زر حساب المعاينة
        preview_btn = tk.Button(btn_frame, text="🧮 حساب المعاينة", 
                              command=self.calculate_preview,
                              bg='#9b59b6', fg='white',
                              font=('Arial', 14),
                              padx=40, pady=15, cursor='hand2')
        preview_btn.pack(side='left', padx=10)
        
        # ===================== قسم النتائج =====================
        result_section = tk.LabelFrame(content_frame, text="📊 تفاصيل المعالجة", 
                                      font=('Arial', 14, 'bold'),
                                      bg='white', fg='#2c3e50',
                                      padx=15, pady=15, relief='groove')
        result_section.pack(fill='both', expand=True, pady=(0, 10))
        
        # منطقة النص للنتائج
        self.result_text = scrolledtext.ScrolledText(result_section,
                                                    height=10,
                                                    font=('Arial', 11),
                                                    bg='#f8f9fa',
                                                    fg='#2c3e50',
                                                    wrap='word')
        self.result_text.pack(fill='both', expand=True)
        self.result_text.config(state='disabled')
        
        # عرض رسالة ترحيبية
        self.show_result_message("🔍 ابدأ بالبحث عن زبون باستخدام حقل البحث أعلاه...")
    
    def create_toolbar(self, parent):
        """إنشاء شريط الأدوات العلوي"""
        toolbar = tk.Frame(parent, bg='#2c3e50', height=60)
        toolbar.pack(fill='x', side='top')
        toolbar.pack_propagate(False)
        
        # العنوان
        title_label = tk.Label(toolbar, 
                              text="مولدة الريان - نظام المحاسبة السريعة (النظام الجديد)",
                              font=('Arial', 18, 'bold'),
                              bg='#2c3e50', fg='white')
        title_label.pack(side='left', padx=20)
        
        # معلومات المستخدم
        user_info = tk.Label(toolbar,
                            text=f"المستخدم: {self.user_data.get('full_name', '')} | الدور: {self.user_data.get('role', '')}",
                            font=('Arial', 12),
                            bg='#2c3e50', fg='#ecf0f1')
        user_info.pack(side='right', padx=20)
    
    def center_window(self):
        """توسيط النافذة على الشاشة"""
        root = self.parent.winfo_toplevel()
        root.update_idletasks()

        width = 1200
        height = 700

        screen_width = root.winfo_screenwidth()
        screen_height = root.winfo_screenheight()

        x = (screen_width // 2) - (width // 2)
        y = (screen_height // 2) - (height // 2)

        root.geometry(f'{width}x{height}+{x}+{y}')
        root.minsize(1000, 600)
    
    def quick_search(self, event=None):
        """بحث فوري أثناء الكتابة"""
        search_term = self.search_var.get().strip()
        if len(search_term) < 2:
            self.results_listbox.delete(0, tk.END)
            return
        
        # إلغاء البحث السابق إذا كان هناك واحد
        if hasattr(self, '_search_job'):
            self.after_cancel(self._search_job)
        
        # جدولة بحث جديد بعد تأخير 300 مللي ثانية
        self._search_job = self.after(300, self._perform_search, search_term)
    
    def _perform_search(self, search_term):
        """تنفيذ البحث الفعلي"""
        if not search_term:
            return
        
        results = self.fast_ops.fast_search_customers(search_term, limit=30)
        self.results_listbox.delete(0, tk.END)
        
        # حفظ بيانات العملاء للوصول السريع
        self.search_results_data = results
        
        for customer in results:
            display_text = f"{customer['name']} | علبة: {customer['box_number']} | رصيد: {customer['current_balance']:,.0f} | آخر قراءة: {customer['last_counter_reading']:,.0f}"
            self.results_listbox.insert(tk.END, display_text)
    
    def perform_search(self):
        """بحث يدوي"""
        search_term = self.search_var.get().strip()
        if search_term:
            self._perform_search(search_term)
    
    def on_search_select(self, event=None):
        """عند اختيار نتيجة من البحث"""
        selection = self.results_listbox.curselection()
        if not selection:
            return
        
        idx = selection[0]
        if hasattr(self, 'search_results_data') and idx < len(self.search_results_data):
            customer = self.search_results_data[idx]
            self.select_customer(customer['id'])
    
    def select_customer(self, customer_id):
        """تحديد زبون وعرض بياناته"""
        try:
            customer_data = self.fast_ops.fast_get_customer_details(customer_id)
            if not customer_data:
                messagebox.showwarning("تحذير", "لم يتم العثور على بيانات الزبون")
                return
            
            self.selected_customer = customer_data
            
            # تحديث حقول المعلومات
            self.info_vars['name'].set(customer_data.get('name', '---'))
            self.info_vars['sector'].set(customer_data.get('sector_name', '---'))
            self.info_vars['box'].set(customer_data.get('box_number', '---'))
            self.info_vars['serial'].set(customer_data.get('serial_number', '---'))
            self.info_vars['balance'].set(f"{customer_data.get('current_balance', 0):,.0f}")
            self.info_vars['reading'].set(f"{customer_data.get('last_counter_reading', 0):,.0f}")
            self.info_vars['visa'].set(f"{customer_data.get('visa_balance', 0):,.0f}")
            self.info_vars['withdrawal'].set(f"{customer_data.get('withdrawal_amount', 0):,.0f}")
            
            # تصفير حقول الإدخال
            self.kilowatt_var.set("")
            self.free_var.set("0")
            self.price_var.set("7200")
            self.discount_var.set("0")
            self.visa_var.set("")
            self.withdrawal_var.set("")
            
            # تفعيل الأزرار
            self.process_btn.config(state='normal', bg='#27ae60')
            self.print_btn.config(state='normal', bg='#3498db')
            
            # إظهار رسالة في منطقة النتائج
            self.show_result_message(f"✅ تم تحديد الزبون: {customer_data.get('name', '')}\n"
                                   f"الرصيد الحالي: {customer_data.get('current_balance', 0):,.0f} كيلو واط\n"
                                   f"آخر قراءة عداد: {customer_data.get('last_counter_reading', 0):,.0f}\n\n"
                                   f"⚠️ أدخل كمية الدفع والمجاني ثم اضغط على 'معالجة سريعة'")
            
            # وضع التركيز على حقل كمية الدفع
            self.kilowatt_entry.focus_set()
            
        except Exception as e:
            logger.error(f"خطأ في تحديد الزبون: {e}")
            messagebox.showerror("خطأ", f"فشل تحميل بيانات الزبون: {str(e)}")
    
    def adjust_kilowatt(self, amount):
        """ضبط كمية الدفع بزيادة/نقصان"""
        try:
            current = float(self.kilowatt_var.get() or 0)
            new_value = current + amount
            if new_value >= 0:
                self.kilowatt_var.set(str(int(new_value)))
        except ValueError:
            self.kilowatt_var.set("0")
    
    def calculate_preview(self):
        """حساب معاينة الفاتورة دون حفظ"""
        if not self.selected_customer:
            messagebox.showerror("خطأ", "يرجى اختيار زبون أولاً")
            return
        
        try:
            # التحقق من المدخلات
            if not self.kilowatt_var.get().strip():
                messagebox.showerror("خطأ", "يرجى إدخال كمية الدفع")
                return
            
            kilowatt_amount = float(self.kilowatt_var.get())
            free_kilowatt = float(self.free_var.get() or 0)
            price_per_kilo = float(self.price_var.get() or 7200)
            discount = float(self.discount_var.get() or 0)
            
            # الحسابات
            last_reading = float(self.selected_customer.get('last_counter_reading', 0))
            current_balance = float(self.selected_customer.get('current_balance', 0))
            
            # القراءة الجديدة = القراءة السابقة + كمية الدفع + المجاني
            new_reading = last_reading + kilowatt_amount + free_kilowatt
            
            # الرصيد الجديد = الرصيد الحالي + كمية الدفع + المجاني
            new_balance = current_balance + kilowatt_amount + free_kilowatt
            
            # المبلغ الكلي = (كمية الدفع * سعر الكيلو) - الحسم
            total_amount = (kilowatt_amount * price_per_kilo) - discount
            
            # عرض المعاينة
            preview_text = f"""
            📊 معاينة الحساب (غير محفوظة):
            
            الزبون: {self.selected_customer.get('name', '')}
            
            البيانات المدخلة:
            • كمية الدفع: {kilowatt_amount:,.1f} كيلو
            • المجاني: {free_kilowatt:,.1f} كيلو
            • سعر الكيلو: {price_per_kilo:,.0f} ل.س
            • الحسم: {discount:,.0f} ل.س
            
            نتائج الحساب:
            • القراءة السابقة: {last_reading:,.0f}
            • القراءة الجديدة: {new_reading:,.0f}
            • الإجمالي المقطوع: {(kilowatt_amount + free_kilowatt):,.1f} كيلو
            • المبلغ الإجمالي: {total_amount:,.0f} ليرة سورية
            • الرصيد الجديد: {new_balance:,.0f} كيلو واط
            
            للحفظ الفعلي اضغط على "⚡ معالجة سريعة"
            """
            
            self.show_result_message(preview_text)
            
        except ValueError:
            messagebox.showerror("خطأ", "يرجى إدخال أرقام صحيحة في الحقول الرقمية")
        except Exception as e:
            logger.error(f"خطأ في حساب المعاينة: {e}")
            messagebox.showerror("خطأ", f"فشل حساب المعاينة: {str(e)}")
    
    def fast_process(self):
        """معالجة فاتورة سريعة بالنظام الجديد"""
        if not self.selected_customer:
            messagebox.showerror("خطأ", "يرجى اختيار زبون أولاً")
            return
        
        try:
            # التحقق من المدخلات
            if not self.kilowatt_var.get().strip():
                messagebox.showerror("خطأ", "يرجى إدخال كمية الدفع")
                return
            
            # جمع البيانات
            kilowatt_amount = float(self.kilowatt_var.get())
            free_kilowatt = float(self.free_var.get() or 0)
            price_per_kilo = float(self.price_var.get() or 7200)
            discount = float(self.discount_var.get() or 0)
            visa_application = self.visa_var.get()
            customer_withdrawal = self.withdrawal_var.get()
            
            # التحقق من صحة البيانات
            if kilowatt_amount < 0 or free_kilowatt < 0:
                messagebox.showerror("خطأ", "كمية الدفع والمجاني يجب أن تكون أرقاماً موجبة")
                return
            
            # الحسابات للمعاينة
            last_reading = float(self.selected_customer.get('last_counter_reading', 0))
            total_kilowatt = kilowatt_amount + free_kilowatt
            
            # إظهار تأكيد
            confirm_msg = f"""
            هل أنت متأكد من معالجة الفاتورة؟
            
            الزبون: {self.selected_customer.get('name', '')}
            
            البيانات المدخلة:
            • كمية الدفع: {kilowatt_amount:,.1f} كيلو
            • المجاني: {free_kilowatt:,.1f} كيلو
            • الإجمالي: {total_kilowatt:,.1f} كيلو
            • سعر الكيلو: {price_per_kilo:,.0f} ل.س
            • الحسم: {discount:,.0f} ل.س
            
            ستصبح القراءة الجديدة: {last_reading + total_kilowatt:,.0f}
            """
            
            if not messagebox.askyesno("تأكيد المعالجة", confirm_msg):
                return
            
            # معالجة الفاتورة باستخدام التابع المعدل
            result = self.fast_ops.fast_process_invoice(
                customer_id=self.selected_customer['id'],
                kilowatt_amount=kilowatt_amount,
                free_kilowatt=free_kilowatt,
                price_per_kilo=price_per_kilo,
                discount=discount,
                visa_application=visa_application,
                customer_withdrawal=customer_withdrawal,
                user_id=self.user_data.get('id', 1)
            )
            
            if result.get('success'):
                # عرض النتيجة
                result_text = f"""
                ✅ تمت المعالجة بنجاح!
                
                تفاصيل الفاتورة:
                • رقم الفاتورة: {result.get('invoice_number', 'N/A')}
                • الزبون: {result.get('customer_name', 'N/A')}
                • كمية الدفع: {result.get('kilowatt_amount', 0):,.1f} كيلو
                • المجاني: {result.get('free_kilowatt', 0):,.1f} كيلو
                • الإجمالي المقطوع: {(result.get('kilowatt_amount', 0) + result.get('free_kilowatt', 0)):,.1f} كيلو
                • القراءة السابقة: {result.get('previous_reading', 0):,.0f}
                • القراءة الجديدة: {result.get('new_reading', 0):,.0f}
                • المبلغ الإجمالي: {result.get('total_amount', 0):,.0f} ليرة سورية
                • الرصيد الجديد: {result.get('new_balance', 0):,.0f}
                • وقت المعالجة: {result.get('processed_at', 'N/A')}
                
                يمكنك الآن طباعة الفاتورة.
                """
                
                self.show_result_message(result_text)
                
                # حفظ نتيجة المعالجة للطباعة
                self.last_invoice_result = result
                
                # تحديث بيانات الزبون المعروضة
                self.selected_customer['current_balance'] = result['new_balance']
                self.selected_customer['last_counter_reading'] = result['new_reading']
                self.info_vars['balance'].set(f"{result['new_balance']:,.0f}")
                self.info_vars['reading'].set(f"{result['new_reading']:,.0f}")
                
                # سؤال عن الطباعة
                if messagebox.askyesno("طباعة", "هل تريد طباعة الفاتورة الآن؟"):
                    self.print_invoice()
                
                # تصفير حقول الإدخال
                self.clear_input_fields()
                
            else:
                error_msg = result.get('error', 'حدث خطأ غير معروف')
                self.show_result_message(f"❌ فشل المعالجة:\n{error_msg}")
                messagebox.showerror("خطأ", f"فشل المعالجة: {error_msg}")
                
        except ValueError as e:
            messagebox.showerror("خطأ", "يرجى إدخال أرقام صحيحة في الحقول الرقمية")
        except Exception as e:
            logger.error(f"خطأ في المعالجة: {e}")
            messagebox.showerror("خطأ", f"حدث خطأ غير متوقع: {str(e)}")
    
    def print_invoice(self):
        """طباعة الفاتورة"""
        if not hasattr(self, 'last_invoice_result') or not self.last_invoice_result:
            messagebox.showwarning("تحذير", "لا توجد فاتورة حديثة للطباعة")
            return
        
        try:
            # تحضير بيانات الطباعة
            invoice_data = {
                'customer_name': self.selected_customer.get('name', ''),
                'sector_name': self.selected_customer.get('sector_name', ''),
                'box_number': self.selected_customer.get('box_number', ''),
                'serial_number': self.selected_customer.get('serial_number', ''),
                'previous_reading': self.last_invoice_result.get('previous_reading', 0),
                'new_reading': self.last_invoice_result.get('new_reading', 0),
                'kilowatt_amount': self.last_invoice_result.get('kilowatt_amount', 0),
                'free_kilowatt': self.last_invoice_result.get('free_kilowatt', 0),
                'consumption': self.last_invoice_result.get('kilowatt_amount', 0) + self.last_invoice_result.get('free_kilowatt', 0),
                'price_per_kilo': 7200,
                'total_amount': self.last_invoice_result.get('total_amount', 0),
                'new_balance': self.last_invoice_result.get('new_balance', 0),
                'invoice_number': self.last_invoice_result.get('invoice_number', ''),
                'discount': self.last_invoice_result.get('discount', 0)
            }
            
            if self.printer.print_fast_invoice(invoice_data):
                self.show_result_message("🖨️ تمت الطباعة بنجاح!")
                messagebox.showinfo("نجاح", "تمت طباعة الفاتورة بنجاح")
            else:
                self.show_result_message("❌ فشل الطباعة. تحقق من اتصال الطابعة.")
                messagebox.showerror("خطأ", "فشل الطباعة. تحقق من اتصال الطابعة.")
                
        except Exception as e:
            logger.error(f"خطأ في الطباعة: {e}")
            messagebox.showerror("خطأ", f"فشل الطباعة: {str(e)}")
    
    def show_result_message(self, message):
        """عرض رسالة في منطقة النتائج"""
        self.result_text.config(state='normal')
        self.result_text.delete(1.0, tk.END)
        self.result_text.insert(1.0, message)
        self.result_text.config(state='disabled')
    
    def clear_input_fields(self):
        """تصفير حقول الإدخال فقط"""
        self.kilowatt_var.set("")
        self.free_var.set("0")
        self.price_var.set("7200")
        self.discount_var.set("0")
        self.visa_var.set("")
        self.withdrawal_var.set("")
        
        if self.selected_customer:
            last_reading = self.selected_customer.get('last_counter_reading', 0)
            self.kilowatt_entry.focus_set()
    
    def clear_fields(self):
        """تصفير جميع الحقول"""
        self.search_var.set("")
        self.kilowatt_var.set("")
        self.free_var.set("0")
        self.price_var.set("7200")
        self.discount_var.set("0")
        self.visa_var.set("")
        self.withdrawal_var.set("")
        
        # تصفير حقول المعلومات
        for var in self.info_vars.values():
            var.set("---")
        
        # تصفير قائمة النتائج
        self.results_listbox.delete(0, tk.END)
        
        # تصفير منطقة النتائج
        self.show_result_message("🔍 ابدأ بالبحث عن زبون باستخدام حقل البحث أعلاه...")
        
        # إلغاء تحديد الزبون
        self.selected_customer = None
        self.last_invoice_result = None
        
        # تعطيل الأزرار
        self.process_btn.config(state='disabled', bg='#95a5a6')
        self.print_btn.config(state='disabled', bg='#95a5a6')
        
        # وضع التركيز على حقل البحث
        self.search_entry.focus_set()
ملف customer_history_ui.py    له الكود التالي
# ui/customer_history_ui.py

import tkinter as tk
from tkinter import ttk, messagebox
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class CustomerHistoryUI:
    """واجهة عرض السجل التاريخي للزبون"""
    
    def __init__(self, parent, customer_data, user_data):
        self.parent = parent
        self.customer_data = customer_data
        self.user_data = user_data
        self.history_manager = None
        
        self.load_history_manager()
        self.create_dialog()
        self.create_widgets()
        self.load_history()
        
        self.dialog.grab_set()
    
    def load_history_manager(self):
        """تحميل مدير السجل التاريخي"""
        try:
            from modules.history_manager import HistoryManager
            self.history_manager = HistoryManager()
        except ImportError as e:
            logger.error(f"خطأ في تحميل مدير السجل التاريخي: {e}")
            messagebox.showerror("خطأ", "لا يمكن تحميل وحدة السجل التاريخي")
    
    def create_dialog(self):
        """إنشاء النافذة المنبثقة"""
        self.dialog = tk.Toplevel(self.parent)
        self.dialog.title(f"سجل العمليات - {self.customer_data['name']}")
        self.dialog.geometry("1000x700")
        self.dialog.resizable(True, True)
        self.dialog.configure(bg='#f5f7fa')
        
        # مركزية النافذة
        self.dialog.update_idletasks()
        width = self.dialog.winfo_width()
        height = self.dialog.winfo_height()
        x = (self.dialog.winfo_screenwidth() // 2) - (width // 2)
        y = (self.dialog.winfo_screenheight() // 2) - (height // 2)
        self.dialog.geometry(f'1000x700+{x}+{y}')
    
    def create_widgets(self):
        """إنشاء عناصر الواجهة"""
        # إطار العنوان
        title_frame = tk.Frame(self.dialog, bg='#3498db', height=80)
        title_frame.pack(fill='x')
        title_frame.pack_propagate(False)
        
        title_text = f"📜 سجل العمليات التاريخية - {self.customer_data['name']}"
        title_label = tk.Label(title_frame, text=title_text,
                              font=('Arial', 16, 'bold'),
                              bg='#3498db', fg='white')
        title_label.pack(expand=True)
        
        # إطار معلومات الزبون
        info_frame = tk.Frame(self.dialog, bg='#e8f4fc', relief='ridge', borderwidth=1)
        info_frame.pack(fill='x', padx=10, pady=10)
        
        # تنسيق الأرقام بشكل آمن
        current_balance = self._safe_float(self.customer_data.get('current_balance', 0))
        visa_balance = self._safe_float(self.customer_data.get('visa_balance', 0))
        withdrawal_amount = self._safe_float(self.customer_data.get('withdrawal_amount', 0))
        
        info_text = f"""
        👤 الزبون: {self.customer_data['name']} | 📍 القطاع: {self.customer_data.get('sector_name', 'غير محدد')}
        📦 العلبة: {self.customer_data.get('box_number', '')} | 💰 الرصيد الحالي: {current_balance:,.0f} كيلو واط
        🏦 رصيد التأشيرة: {visa_balance:,.0f} | 💵 السحب: {withdrawal_amount:,.0f}
        """
        
        info_label = tk.Label(info_frame, text=info_text,
                             font=('Arial', 11),
                             bg='#e8f4fc', fg='#2c3e50',
                             justify='left')
        info_label.pack(padx=10, pady=10)
        
        # شريط الأدوات
        toolbar_frame = tk.Frame(self.dialog, bg='#2c3e50', height=50)
        toolbar_frame.pack(fill='x', pady=(0, 10))
        toolbar_frame.pack_propagate(False)
        
        # أزرار الأدوات
        tools = tk.Frame(toolbar_frame, bg='#2c3e50')
        tools.pack()
        
        tk.Button(tools, text="🔄 تحديث",
                 command=self.refresh_history,
                 bg='#3498db', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=5)
        
        tk.Button(tools, text="📊 ملخص",
                 command=self.show_summary,
                 bg='#9b59b6', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=5)
        
        tk.Button(tools, text="📤 تصدير Excel",
                 command=self.export_history,
                 bg='#27ae60', fg='white',
                 font=('Arial', 10)).pack(side='left', padx=5)
        
        # إطار الشجرة
        tree_frame = tk.Frame(self.dialog)
        tree_frame.pack(fill='both', expand=True, padx=10, pady=(0, 10))
        
        # شريط التمرير
        v_scrollbar = ttk.Scrollbar(tree_frame, orient='vertical')
        v_scrollbar.pack(side='right', fill='y')
        
        h_scrollbar = ttk.Scrollbar(tree_frame, orient='horizontal')
        h_scrollbar.pack(side='bottom', fill='x')
        
        # إنشاء الشجرة
        columns = ('id', 'date', 'type', 'old_value', 'new_value', 
                  'amount', 'balance_after', 'notes', 'user')
        
        self.tree = ttk.Treeview(tree_frame, columns=columns,
                                yscrollcommand=v_scrollbar.set,
                                xscrollcommand=h_scrollbar.set,
                                selectmode='browse',
                                show='headings',
                                height=20)
        
        v_scrollbar.config(command=self.tree.yview)
        h_scrollbar.config(command=self.tree.xview)
        
        # تعريف رؤوس الأعمدة
        columns_config = [
            ('id', '#', 50, 'center'),
            ('date', 'التاريخ والوقت', 150, 'center'),
            ('type', 'نوع العملية', 150, 'center'),
            ('old_value', 'القيمة القديمة', 120, 'center'),
            ('new_value', 'القيمة الجديدة', 120, 'center'),
            ('amount', 'المبلغ', 100, 'center'),
            ('balance_after', 'الرصيد بعد', 120, 'center'),
            ('notes', 'ملاحظات', 200, 'w'),
            ('user', 'المستخدم', 120, 'center')
        ]
        
        for col_id, heading, width, anchor in columns_config:
            self.tree.heading(col_id, text=heading)
            self.tree.column(col_id, width=width, anchor=anchor)
        
        self.tree.pack(fill='both', expand=True)
        
        # شريط الحالة
        self.status_frame = tk.Frame(self.dialog, bg='#34495e', height=30)
        self.status_frame.pack(fill='x', padx=10, pady=(0, 10))
        self.status_frame.pack_propagate(False)
        
        self.status_label = tk.Label(self.status_frame,
                                    text="جارٍ تحميل السجل...",
                                    bg='#34495e', fg='white',
                                    font=('Arial', 10))
        self.status_label.pack(side='left', padx=10)
    
    def _safe_float(self, value, default=0.0):
        """تحويل قيمة إلى float بشكل آمن"""
        if value is None:
            return default
        try:
            return float(value)
        except (ValueError, TypeError):
            return default
    
    def load_history(self):
        """تحميل السجل التاريخي"""
        if not self.history_manager:
            self.show_error("مدير السجل غير متاح")
            return
        
        try:
            # مسح البيانات الحالية
            for item in self.tree.get_children():
                self.tree.delete(item)
            
            # جلب البيانات
            result = self.history_manager.get_customer_history(
                customer_id=self.customer_data['id']
            )
            
            if not result['success']:
                self.show_error(result.get('error', 'خطأ في جلب البيانات'))
                return
            
            # إضافة البيانات إلى الشجرة
            for record in result['history']:
                # تحويل القيم إلى float بشكل آمن
                old_value = self._safe_float(record.get('old_value', 0))
                new_value = self._safe_float(record.get('new_value', 0))
                amount = self._safe_float(record.get('amount', 0))
                balance_after = self._safe_float(record.get('current_balance_after', 0))
                
                values = (
                    record['id'],
                    record.get('created_at_formatted', ''),
                    record.get('transaction_type_arabic', ''),
                    f"{old_value:,.0f}",
                    f"{new_value:,.0f}",
                    f"{amount:,.0f}",
                    f"{balance_after:,.0f}",
                    (record.get('notes', '') or '')[:50] + ('...' if len(record.get('notes', '') or '') > 50 else ''),
                    record.get('created_by_name', 'نظام')
                )
                
                self.tree.insert('', 'end', values=values)
            
            # تحديث شريط الحالة
            self.status_label.config(
                text=f"عدد السجلات: {result['total_count']} | آخر تحديث: {datetime.now().strftime('%H:%M:%S')}"
            )
            
        except Exception as e:
            logger.error(f"خطأ في تحميل السجل التاريخي: {e}")
            self.show_error(f"خطأ في تحميل البيانات: {str(e)}")
    
    def refresh_history(self):
        """تحديث السجل"""
        self.load_history()
    
    def show_summary(self):
        """عرض ملخص السجل"""
        if not self.history_manager:
            return
        
        try:
            result = self.history_manager.get_history_summary(
                customer_id=self.customer_data['id']
            )
            
            if result['success']:
                summary = result['summary']
                
                # استخدام _safe_float للقيم الرقمية
                total_visa = self._safe_float(summary.get('total_visa', 0))
                total_withdrawal = self._safe_float(summary.get('total_withdrawal', 0))
                
                message = f"""
                📊 ملخص السجل التاريخي:
                
                • إجمالي العمليات: {summary.get('total_transactions', 0)}
                • إجمالي التأشيرات: {total_visa:,.0f}
                • إجمالي السحوبات: {total_withdrawal:,.0f}
                • أول عملية: {summary.get('first_transaction', 'غير متوفر')}
                • آخر عملية: {summary.get('last_transaction', 'غير متوفر')}
                """
                
                messagebox.showinfo("ملخص السجل", message)
            
        except Exception as e:
            logger.error(f"خطأ في عرض الملخص: {e}")
            messagebox.showerror("خطأ", f"فشل عرض الملخص: {str(e)}")
    
    def export_history(self):
        """تصدير السجل إلى Excel"""
        try:
            from modules.history_manager import HistoryManager
            history_mgr = HistoryManager()
            
            result = history_mgr.get_customer_history(
                customer_id=self.customer_data['id'],
                limit=10000  # جلب جميع السجلات
            )
            
            if not result['success']:
                messagebox.showerror("خطأ", "فشل في جلب البيانات للتصدير")
                return
            
            # إنشاء DataFrame
            import pandas as pd
            from datetime import datetime
            
            data = []
            for record in result['history']:
                data.append({
                    'التاريخ': record.get('created_at_formatted', ''),
                    'نوع العملية': record.get('transaction_type_arabic', ''),
                    'القيمة القديمة': self._safe_float(record.get('old_value', 0)),
                    'القيمة الجديدة': self._safe_float(record.get('new_value', 0)),
                    'المبلغ': self._safe_float(record.get('amount', 0)),
                    'الرصيد بعد العملية': self._safe_float(record.get('current_balance_after', 0)),
                    'ملاحظات': record.get('notes', ''),
                    'المستخدم': record.get('created_by_name', 'نظام')
                })
            
            df = pd.DataFrame(data)
            
            # حفظ في ملف Excel
            filename = f"history_{self.customer_data['id']}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
            df.to_excel(filename, index=False, engine='openpyxl')
            
            messagebox.showinfo("نجاح", f"تم التصدير إلى: {filename}")
            
        except Exception as e:
            logger.error(f"خطأ في التصدير: {e}")
            messagebox.showerror("خطأ", f"فشل التصدير: {str(e)}")
    
    def show_error(self, message):
        """عرض رسالة خطأ"""
        messagebox.showerror("خطأ", message)
        self.status_label.config(text=f"خطأ: {message}")


مجلدات أخرى للمشروع
Backups    مجلد يتم انشاؤه تلقائيا
Data       مجلد فارغ
Fonts  مجلد الخطوط التي أستخدمها في مشروعي
Logs      مجلد ينشئه المشروع تلقائيا 
Logs     مجلد يتم انشاؤه تلقائيا
هذا مشروعي أريدك أن تساعدني فيه هل أنت جاهز أجب ب نعم أو لا ولاتكتب شيئا آخر فقك أجب ب نعم أو لا
